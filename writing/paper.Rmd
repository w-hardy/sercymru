---
title: "Variation in Primary Care Prescribing in Wales due to COVID-19"
author:
- name: Will Hardy
  affiliation: '1'
  corresponding: yes
  address: Postal address
  email: my@email.com
- name: Susan Murphy
  affiliation: '3'
- name: Dyfrig Hughes
  affiliation: '1'
- name: Daniel Hill-McManus
  affiliation: '1'
shorttitle: Welsh Primary Care COVID Prescribing
output:
  html_document: default
  pdf_document: default
keywords: keywords
wordcount: X
bibliography:
- r-references.bib
- ../references/library.bib
header-includes: \usepackage{caption}
csl: ../references/apa.csl
always_allow_html: yes
affiliation:
- id: '1'
  institution: Centre for Health Economics & Medicines Evaluation, Bangor University,
    LL55 2PZ
- id: '2'
  institution: Betsi Cadwaladr University Health Board
---

```{r setup, include = FALSE}
## Packages
# devtools::install_github("https://github.com/w-hardy/serCymruTools")
library(plyr); library(dplyr)
library(rms)
library(nlme)
library(tidyverse)
library(lubridate)
library(tsibble)
library(fable)
library(feasts)
library(furrr)
library(rebus)
library(serCymruTools)
library(knitr)
library(kableExtra)
library(papaja)
library(fuzzyjoin)
library(ggbiplot)

r_refs("r-references.bib")

plan(cluster)
## Data
gp <- 
  read_rds("../data/gp_agesex_qof_combined.rds") %>% 
  mutate(npat = N,
         N = NULL,
         practice_id = as.character(practiceid)) %>% 
  ungroup() %>% 
  janitor::clean_names() %>% 
  select(practice_id, year, npat)

gp_2020 <- 
  read_rds("../data/gp_2020.rds") %>% 
  mutate(gp_load = npat/ngp)

quantile(gp_2020$wimd2019, 1/3)
quantile(gp_2020$wimd2019, 2/3)

gp_2020 <- 
  gp_2020 %>% 
  mutate(wimd2019 = case_when(wimd2019 <= 15.1 ~ 1,
                              wimd2019 > 27 ~ 3,
                              wimd2019 > 15.1 & wimd2019 <= 27 ~ 2),
         wimd2019 = factor(x = wimd2019, levels = 1:3,
                           labels = c("Low", "Med", "High")))

# CV model accuracies
cv_model_files <- 
  paste0("../data/gp_cv_models/", 
         list.files("../data/gp_cv_models/"))
names(cv_model_files) <- 
  cv_model_files %>% 
  str_remove_all("../data/gp_cv_models/") %>% 
  str_remove_all("_gp_cv_models.rds")

# Forecast - observed
differences_files <- 
  list.files("../data/differences/")
names(differences_files) <- 
  str_remove_all(differences_files, "_discreps.rds")

differences <- 
  furrr::future_map_dfr(.x = differences_files,
                        .f = ~read_rds(paste0("../data/differences/", .x)),
                        .id = "drug") %>% 
  mutate(drug = relevel(as_factor(drug), ref = "quant_all_drugs"),
         drug = str_remove_all(drug, "ddd_"),
         drug = str_remove_all(drug, "quant_"),
         drug = str_remove_all(drug, "_ddd")) %>% 
  filter(regional_unit != "W95636") #https://abuhb.nhs.wales/news/news/important-information-regarding-lansbury-surgery-caerphilly/
plan(sequential)


# GP extract data
data_files <-
  paste0("../data/prescribing_data/", list.files("../data/prescribing_data"))
names(data_files) <-
  str_remove_all(list.files("../data/prescribing_data"), ".rds")
# 
# gp_extract <- 
#   map_dfr(.x = data_files[1:11],
#           .f = ~(read_rds(.x)),
#           .id = "drug")


# Functions

#### Summarise and standardise prescribing ####
monthlyPrescribing <- 
  function(data){
    data %>% 
      janitor::clean_names() %>% 
      mutate(datename = dmy(paste0("28-", datename)),
             practice_id = as.character(practice_id)) %>% 
      countRegional(practice_id, datename, quantity) %>% 
      mutate(year = year(datename)) %>%
      as_tibble() %>% 
      inner_join(gp %>% 
                   select(practice_id, year, npat), 
                 by = c("regional_unit" = "practice_id", "year")) %>% 
      mutate(n = 1000*n/npat,
             datename = yearmonth(datename),
             regional_unit = as_factor(regional_unit)) %>% 
      select(-c(npat, year)) %>% 
      as_tsibble(index = datename, key = regional_unit) %>% 
      fill_gaps()
  }

#### Prep GLS data ####
glsData <- function(data){
  df <- 
    differences %>% 
    filter(drug == data) %>% 
    mutate(Month = as.numeric(as.factor(datename)),
           pct_change = 100*(prop - 1)) %>% 
    select(c(regional_unit, Month, pct_change)) %>% 
    filter(Month > 2) %>% 
    left_join(gp_2020, by = "regional_unit") %>% 
    mutate(gp_load = npat / ngp)
  
  dd <- datadist(df)
  options(datadist = "dd")
  
  return(df)
}

#### GLS Analysis function ####
bestGLS <- function(data, bootstrap = FALSE){
  cp <- list(corExp, corCompSymm, corLin, corGaus, corSpher)
  z <- vector("list", length(cp))
  
  ### Fit models
  for(k in 1:length(cp)){
    z[[k]] <- gls(pct_change ~ rcs(Month, 4:7) + hboard + dispensing + 
                            wimd2019 + ngp + 
                    gp_load + PC1 + PC2 + PC3 + PC4 +
                            hboard:rcs(Month, 4:7) +
                            dispensing:rcs(Month, 4:7) +
                            wimd2019:rcs(Month, 4:7) +
                            ngp:rcs(Month, 4:7) +
                            gp_load:rcs(Month, 4:7),
                  data = data,
                  correlation = cp[[k]](form = ~ Month | regional_unit))
  }
  
  arma_tab <- # Table for p and q values for corARMA()
    tibble(p = 1:2, 
           q = rep(0,2)) %>% 
    mutate(model = row_number() + length(cp))
  
  z <- c(z, map2(.x = arma_tab$p, .y = arma_tab$q, 
                 .f = ~ if(.x > 0 | .y >0)
                 { # p = 0 & q = 0 fails
                   tryCatch(
                     {gls(pct_change ~ rcs(Month, 4:7) + hboard + dispensing + 
                            wimd2019 + ngp + 
                            gp_load + PC1 + PC2 + PC3 + PC4 +
                            hboard:rcs(Month, 4:7) +
                            dispensing:rcs(Month, 4:7) +
                            wimd2019:rcs(Month, 4:7) +
                            ngp:rcs(Month, 4:7) +
                            gp_load:rcs(Month, 4:7),
                          data = data,
                          correlation = corARMA(form = ~ Month|regional_unit, 
                                                p=.x, q=.y))
                     },
                     error = function(cond){
                       message(paste("Model causing error: p = ", 
                                     .x, "q = ", .y))
                       message("Original error message:")
                       message(cond)
                       return(NULL)
                     },
                     warning = function(cond){
                       message(paste("Model causing warning: p = ", 
                                     .x, "q = ", .y))
                       message("Original warning message:")
                       message(cond)
                       return(NULL)
                     }
                   )
                 }))
  
  ### Select best model
  names(z) <- paste0("model", 1:length(z))
  x <- z %>% 
    map(summary)
  
  # Get metrics for each model
  aic <- map_dfr(x, pluck("AIC"), .id = "model") 
  bic <- map_dfr(x, pluck("BIC"), .id = "model")
  log_lik <- map_dfr(x, pluck("logLik"), .id = "model")
  
  # Create table
  mod_comparison <- 
    bind_cols(metric = c("aic", "bic", "log_lik"), 
              bind_rows(aic, bic, log_lik)) %>% 
    pivot_longer(-metric) %>% 
    pivot_wider(id_cols = name, values_from = value, names_from = metric) %>% 
    rename(model = name) %>% 
    mutate(model = as.numeric(str_remove_all(model, "model")))
  
  # Select best model
  best_model_aic <- 
    mod_comparison %>% 
    arrange(aic, bic, desc(log_lik)) %>% 
    head(1) %>% 
    .$model
  
  
  ### Fit best model
  if(bootstrap == TRUE){  
    if(best_model_aic <= 6){
      a <-  Gls(pct_change ~ rcs(Month, 4:7) + hboard + dispensing + 
                            wimd2019 + ngp + 
                  gp_load + PC1 + PC2 + PC3 + PC4 +
                            hboard:rcs(Month, 4:7) +
                            dispensing:rcs(Month, 4:7) +
                            wimd2019:rcs(Month, 4:7) +
                            ngp:rcs(Month, 4:7) +
                            gp_load:rcs(Month, 4:7),
                data = data, B = 1000,
                correlation = 
                  cp[[best_model_aic]](form = ~ Month | regional_unit))
      }
    else{
      a <-  Gls(pct_change ~ rcs(Month, 4:7) + hboard + dispensing + 
                            wimd2019 + ngp + 
                  gp_load + PC1 + PC2 + PC3 + PC4 +
                            hboard:rcs(Month, 4:7) +
                            dispensing:rcs(Month, 4:7) +
                            wimd2019:rcs(Month, 4:7) +
                            ngp:rcs(Month, 4:7) +
                            gp_load:rcs(Month, 4:7),
                data = data, B = 1000,
                correlation = 
                  corARMA(form = ~ Month | regional_unit, 
                          p = filter(arma_tab, model == best_model_aic)$p, 
                          q = filter(arma_tab, model == best_model_aic)$q))
      }
  }
  else{
    if(best_model_aic <= 6){
      a <- Gls(pct_change ~ rcs(Month, 4:7) + hboard + dispensing + 
                            wimd2019 + ngp + 
                 gp_load + PC1 + PC2 + PC3 + PC4 +
                            hboard:rcs(Month, 4:7) +
                            dispensing:rcs(Month, 4:7) +
                            wimd2019:rcs(Month, 4:7) +
                            ngp:rcs(Month, 4:7) +
                            gp_load:rcs(Month, 4:7),
               data = data,
               correlation = 
                 cp[[best_model_aic]](form = ~ Month | regional_unit))
    }
    else{
      a <- Gls(pct_change ~ rcs(Month, 4:7) + hboard + dispensing + 
                            wimd2019 + ngp + 
                 gp_load + PC1 + PC2 + PC3 + PC4 +
                            hboard:rcs(Month, 4:7) +
                            dispensing:rcs(Month, 4:7) +
                            wimd2019:rcs(Month, 4:7) +
                            ngp:rcs(Month, 4:7) +
                            gp_load:rcs(Month, 4:7),
               data = data,
               correlation = 
                 corARMA(form = ~ Month | regional_unit, 
                         p = filter(arma_tab, model == best_model_aic)$p, 
                         q = filter(arma_tab, model == best_model_aic)$q))
    }
  }
  return(a)
}

#### Percentiles for a given variable ####
percentiles <- function(data, var){
  # return vector of 5th, 25th, 50th, 75th, and 95th percentile
  var <- enquo(var)
  data %>% 
    summarise(enframe(stats::quantile(!!var, c(.05, .25, .5, .75, .95)), 
                      "Percentile", "value"), .groups = "drop") %>% 
    mutate(value = round(value, 2)) %>% .$value
}

```


```{r, analysis-preferences}
# Seed for random number generation
set.seed(32)
knitr::opts_chunk$set(cache.extra = knitr::rand_seed, cache = TRUE, echo = FALSE)
kable_opts <- options(knitr.kable.NA = "-")
```

## Figure 1


```{r, figure-1, fig.cap="Data processing flow."}
include_graphics("figures/data_flow.pdf")
```

## Table 2

```{r, table-2}
tibble(regional_unit = unique(differences$regional_unit)) %>% 
  left_join(read_rds("../data/gp_agesex_qof_combined.rds") %>% 
              mutate(npat = N,
                     N = NULL,
                     regional_unit = as.character(practiceid)) %>% 
              ungroup() %>% 
              janitor::clean_names() %>%  
              filter(year == 2020)) %>% 
  select(npat, ngp, dispensing, wimd2019:flu) %>% 
  mutate(across(p_male:flu, ~.x*100)) %>% 
  tibble() %>% 
  psych::describe(fast = TRUE) %>% 
  kable(digits = 2, caption = "Summary of prescribing data and GP practice characteristics")
```


```{r}
plan(cluster)
pres_2019 <- 
  data_files[c(1:10)] %>% 
  furrr::future_map(read_rds) %>% 
  furrr::future_map(monthlyPrescribing) %>% 
  furrr::future_map_dfr(as_tibble, .id = "drug") %>% 
  filter(year(datename) == 2019)
plan(sequential)

pres_2019 %>% 
  right_join(differences %>% 
               group_by(regional_unit, drug) %>% 
               count() %>% 
               select(-n), by = c("drug", "regional_unit")) %>% 
  filter(drug != "warfarin_ddd") %>% 
  bind_rows(read_rds(data_files[12]) %>% 
              mutate(drug = "warfarin_ddd",
                datename = yearmonth(dmy(paste0("28-", datename)))) %>% 
              rename(regional_unit = practice_id,
                     n = quantity) %>% 
              filter(year(datename) == 2019)) %>% 
  group_by(drug) %>% 
  summarise(mean = mean(n, na.rm = TRUE),
            sd = sd(n, na.rm = TRUE),
            min = min(n, na.rm = TRUE),
            max = max(n, na.rm = TRUE)) %>% 
  left_join(differences %>% 
              dplyr::group_by(drug) %>% 
              dplyr::count() %>% 
              mutate(n = n/8), by = "drug") %>% 
  select(drug, n, everything()) %>% 
  kable(digits = 2)
```


## Figure 2

```{r, fig-2, fig.cap="Distribution of the difference between observed and forecast dispensing, expressed as a percentage of forecast dispensing. Grey line marks forecast level of dispensing. Pink shading covers duration of Wales' \"stay at home\" order. Please note the difference y-axis scales across the plots. ", dpi=450}
differences_quantiles <- 
  differences %>% 
  na.omit() %>% 
  dplyr::group_by(datename, drug) %>% 
  dplyr::summarise(mean_prop = mean(prop, na.rm = T),
            med_prop = median(prop, na.rm = T),
            enframe(stats::quantile(prop, seq(.1,.9,.1)), 
                    "Percentile", "prop"),
            .groups = "drop") %>% 
  dplyr::mutate(datename = month(datename),
         prop = 100*(prop - 1)) # Percentage change instead of proportion

differences_quantiles %>%
  dplyr::mutate(datename = factor(x = datename, levels = 1:8, 
                           labels = month.abb[1:8])) %>% 
  dplyr::mutate(drug = case_when(drug == "all_drugs" ~ "All",
                          drug == "ace" ~ "ACEi",
                          drug == "cortico" ~ "Inhaled cortico",
                          drug == "hcq" ~ "HCQ",
                          drug == "nsaid" ~ "NSAIDs",
                          drug == "oral_contra" ~ "Oral contra",
                          drug == "paracet" ~ "Paracet",
                          drug == "sal" ~ "Salbutamol",
                          drug == "ssri" ~ "SSRIs",
                          drug == "vitd" ~ "Vit D",
                          drug == "warfarin" ~ "Warfarin",
                          drug == "warfarin_ddd" ~"Warfarin"),
         drug = relevel(as_factor(drug), ref = "All"),
         line_type = if_else(Percentile == "50%", "Median", "Decile")) %>%
  ggplot(aes(x = datename, col = drug, 
             group = Percentile)) +
  geom_rect(aes(xmin = "Mar", xmax = "Jul", ymin = -Inf, ymax = Inf),
            fill = 'pink', col = 0,alpha = 0.03) +
  geom_line(aes(y = prop, lty = line_type)) +
  geom_hline(aes(yintercept = 0), alpha = .5) +
  facet_wrap(~drug, scales = "free") + 
  guides(size = "legend", colour = "none") + 
  theme(text = element_text(size = 10),
        legend.position = c(1, 0),
        legend.justification = c(1, 0)) +
  scale_linetype_manual(values = c(2,1), name = " ") +
  xlab("Month") +
  ylab("Percentage difference from forecast dispensing") 

ggsave(filename = "Draft 5/Figures/Figure 2.png", device = "png", height = 14, width = 25, units = "cm")
```


## Table 3

```{r, fig-2-single-fcts, eval=TRUE, fig.cap="Estimated percentage change [95% CI] from forecast dispensing. Grey line marks the level of forecast dispensing. Pink shading covers duration of Wales’ “stay at home” order. Please note the different y-axis scales across the plots. ACEi = ACE inhibitors, HCQ = Hydroxycholoroquine."}
plan(cluster)
nat_data <- # Data for all regional units combined
  data_files %>% 
  furrr::future_map_dfr(read_rds, .id = "drug") %>% 
  filter(drug != "warfarin_ddd") %>% 
  dplyr::group_by(drug, datename) %>% 
  dplyr::summarise(n = sum(quantity, na.rm = TRUE), .groups = "drop") %>% 
  mutate(datename = yearmonth(dmy(paste("28", datename, sep = "-"))),
         regional_unit = as.factor(drug)) %>% # Calling drug regional_unit to save rewriting all the code
  as_tsibble(index = "datename", key = "regional_unit") %>% 
  fill_gaps()

precribing_cv_models <- 
  nat_data %>% 
  filter(datename < yearmonth(dmy("01-01-2020"))) %>% 
  serCymruTools::regionalCV(cv_dist = 8, init = 36, step = 1)

best_model <- 
  precribing_cv_models %>% 
  group_by(regional_unit) %>% 
  rankModels() %>% 
  slice(1, .preserve = TRUE)

best_mape_over_50 <- 
  best_model %>% 
  filter(MAPE > 50)

#### Monthly forecasts ####
prescribing_fcsts <-
  nat_data %>% 
  filter(datename < yearmonth(dmy("01-01-2020"))) %>% 
  filter(!regional_unit %in% best_mape_over_50$regional_unit) %>%
  regionalJointFcsts()

lockdown_fcsts <- 
  nat_data %>% 
  filter(datename < yearmonth(dmy("01-01-2020"))) %>% 
  filter(!regional_unit %in% best_mape_over_50$regional_unit) %>% 
  fableModels() %>%
  generate(h = 8, times = 1000) %>%
  as_tibble() %>% 
  filter(!datename %in% 
           yearmonth(c("2020 Jan", "2020 Feb", "2020 Aug", "2020 Sept", "2020 Oct"))) %>% 
  group_by(.model, regional_unit, .rep) %>% 
  dplyr::summarise(.sim = sum(.sim)) %>%
  # Store as a distribution
  dplyr::summarise(total = distributional::dist_sample(list(.sim))) %>% 
  mutate(mean = mean(total),
         lb_95 = stats::quantile(total, .025),
         lb_80 = stats::quantile(total, .1),
         med = median(total),
         ub_80 = stats::quantile(total, .9),
         ub_95 = stats::quantile(total, .975),
         sd = distributional::variance(total)^.5,
         total = NULL)

three_month_fcsts <- 
  nat_data %>% 
  filter(datename < yearmonth(dmy("01-01-2020"))) %>% 
  filter(!regional_unit %in% best_mape_over_50$regional_unit) %>% 
  fableModels() %>%
  generate(h = 8, times = 1000) %>%
  as_tibble() %>% 
  filter(datename > yearmonth("2020 Feb") &
                       datename < yearmonth("2020 Jun")) %>% 
  group_by(.model, regional_unit, .rep) %>% 
  dplyr::summarise(.sim = sum(.sim)) %>%
  # Store as a distribution
  dplyr::summarise(total = distributional::dist_sample(list(.sim))) %>% 
  mutate(mean = mean(total),
         lb_95 = stats::quantile(total, .025),
         lb_80 = stats::quantile(total, .1),
         med = median(total),
         ub_80 = stats::quantile(total, .9),
         ub_95 = stats::quantile(total, .975),
         sd = distributional::variance(total)^.5,
         total = NULL)
  
plan(sequential)


#### Monthly discreps ####
best_model_discrep <- 
  best_model %>% 
  select(.model, regional_unit) %>% 
  inner_join(mutate(prescribing_fcsts, # Select best forecast
                    datename = yearmonth(datename)), 
             by = c(".model", "regional_unit")) %>%
  left_join(dplyr::mutate(dplyr::select(nat_data, #Join observed dispensing data
                          c(regional_unit, datename, n)), 
                   datename = yearmonth(datename)),
            by = c("datename", "regional_unit")) %>% 
  mutate(discrepancy = n - med, # observed - forecast
         prop = n / med) %>% 
  ungroup()

#### Table ####
monthly_diffs <- 
  best_model_discrep %>% 
  group_by(regional_unit) %>% 
  dplyr::mutate(across(lb_95:ub_95, ~ 100*(n-.x)/.x)) %>% 
  select(datename, regional_unit, lb_95, med, ub_95) %>% 
  mutate(pct_change = paste0(printnum(med), 
                             "[", printnum(ub_95), ",", 
                             printnum(lb_95), "]")) %>% 
  select(datename, regional_unit, pct_change) %>% 
  pivot_wider(id_cols = regional_unit, names_from = datename, values_from = pct_change)

#### Lockdown discreps ####
lockdown_model_discrep <- 
  best_model %>% 
  select(.model, regional_unit) %>% 
  inner_join(lockdown_fcsts,  # Select best forecast
             by = c(".model", "regional_unit")) %>%
  left_join(nat_data %>% 
              filter(datename > yearmonth("2020 Feb") &
                       datename < yearmonth("2020 Aug")) %>% 
              as_tibble() %>% 
              select(-datename) %>% 
              ungroup() %>% 
              dplyr::group_by(regional_unit) %>% 
              dplyr::summarise(n = sum(n)),
            by = "regional_unit") %>% 
  dplyr::mutate(across(lb_95:ub_95, ~ 100*(n-.x)/.x))

#### Table ####
lockdown_diffs <- 
  lockdown_model_discrep %>% 
  mutate(pct_change = paste0(printnum(med), 
                             "[", printnum(ub_95), ",", 
                             printnum(lb_95), "]")) %>% 
  select(regional_unit, lckdwn = pct_change)

#### Joint table ####
lockdown_diffs %>% 
  left_join(monthly_diffs, by = "regional_unit") %>% 
  kable(col.names = c("Drug", "Lockdown", month.abb[1:8]),
        align = "lrrrrrrrr",
        booktabs = TRUE,
        caption = "Monthly percentage change in prescribing") %>%
  kable_styling(font_size = 8) %>% 
  add_header_above(header = c(" " = 1,
                              "Mean percentage change [95% CI]" = 9)) %>%
  landscape()

```



## Table 4

```{r, gls-functions, echo=FALSE}
drugs <- unique(differences$drug) # Remove? Should be in setup

## Assumption checking? ##

#### Redundancy analysis model ####
redun <- list()
for(i in drugs){
  redun[[i]] <- redun(~hboard + dispensing + Month + wimd2019 + 
                        PC1 + PC2 + PC3 + PC4 + PC5 + ngp + 
                        gp_load,
                      data = glsData(i), r2 = .8, type = "adjusted") %>% 
    .$Out
}

# redun # No redundant variables

#### Collinearity diagnostics ####
colin <- list()
for(i in drugs){
  dd <- datadist(glsData(i))
  options(datadist = "dd")
  colin[[i]] <- sum(vif(ols(pct_change ~ hboard + dispensing + Month + wimd2019 + 
                        PC1 + PC2 + PC3 + PC4 + ngp + 
                          gp_load,
                      data = glsData(i))) >= 5)
  options(datadist = NULL)
}

# colin # no VIF >= 5
```


```{r, gls-analysis-save, results="asis", warning=FALSE, message=FALSE, eval = FALSE}
#### gls-analysis-save ####
drugs <- unique(differences$drug)

best_models <- list()
best_bs_models <- list()

dd <- NULL
for(i in drugs){
  gls_data <- glsData(i)
  gls_data %>% 
    mutate(hboard = as.factor(hboard),
           hboard = relevel(hboard, ref = "BC"))
  dd <- datadist(gls_data)
  options(datadist = "dd")
  best_gls <- bestGLS(gls_data)
  best_bs_gls <- bestGLS(gls_data, TRUE)
  rm(dd)
  best_models[[i]] <-
    best_gls
  best_bs_models[[i]] <- 
    best_bs_gls
  options(datadist = NULL)
}

write_rds(best_models, "../data/gls/best_models.rds")
write_rds(best_bs_models, "../data/gls/best_bs_models.rds")
```


```{r, gls-anova-summary-tab}
best_bs_models <- read_rds("../data/gls/best_bs_models.rds")

#### ANOVA Table ####
best_bs_models %>% 
  map(~anova(., tol = 1e-10)) %>% 
  map(~as_tibble(x = ., rownames = "Variable")) %>% 
  map(as.matrix) %>% 
  map(as_tibble) %>% 
  bind_rows(.id= "drug") %>% 
  mutate(across(`Chi-Square`:P, as.numeric)) %>% 
  select(-c(`Chi-Square`, d.f.)) %>% 
  filter(!str_detect(Variable, "Nonlinear") &
           !str_detect(Variable, "TOTAL") &
           !str_detect(Variable,"All Interactions"),
         !str_detect(Variable, c("f" %R% OPEN_PAREN %R% "A,B"))) %>%
  pivot_wider(names_from = drug, values_from = P) %>% 
  mutate(across(ace:warfarin, ~printnum(., zero = FALSE)),
         Variable = str_remove_all(Variable, OPEN_PAREN %R% "Factor" %R% PLUS %R% 
                                 "Higher Order Factors" %R% CLOSE_PAREN)) %>% 
  select(Variable, all_drugs, everything()) %>% 
  kable(booktabs = TRUE, linesep = "",
        caption = paste("Wald test p-values")) %>%
  kable_styling(latex_options = c("striped", "HOLD_position", "repeat_header")) %>% 
  landscape()
```


## Variation of impacts on dispensing

```{r, gls-fig-setup}
## Health board
drugs_hb <- c("all_drugs", "cortico", "nsaid", "oral_contra", "sal", "ssri", 
              "vitd", "warfarin")

## Dispensing status
drugs_disp <- c("all_drugs", "cortico", "paracet", "sal", "vitd")

## WIMD
drugs_wimd <- c("ace", "cortico", "sal", "ssri", "vitd")

## NGPs
drugs_ngp <- c("oral_contra", "sal")

## GP load
drugs_gpld <- c("oral_contra")

```


```{r, gp-2020-medians, include=FALSE}
gp_2020 %>% 
  dplyr::summarise(hboard = mode(hboard),
                   dispensing = mode(dispensing),
                   wimd2019 = mode(wimd2019),
                   ngp = median(ngp),
                   gp_load = median(gp_load),
                   PC1 = median(PC1),
                   PC2 = median(PC2),
                   PC3 = median(PC3),
                   PC4 = median(PC4))

```


```{r, gp-2020-percentiles, include=FALSE}
gp_2020_percentiles <- 
  data.frame(
    percentile = c(5, 25, 50, 75, 95),
    # wimd2019 = percentiles(gp_2020, wimd2019),
    ngp = percentiles(gp_2020, ngp),
    gp_load = percentiles(gp_2020, gp_load),
    PC1 = percentiles(gp_2020, PC1),
    PC2 = percentiles(gp_2020, PC2),
    PC3 = percentiles(gp_2020, PC3),
    PC4 = percentiles(gp_2020, PC4))

```

* Figures represent predicted changes to dispensing based on GLS models
* When considering the effect of a specific predictor over time, all other predictors will be set to the median value for continuous predictors and the mode for categorical predictors.
* 


### Month

```{r gls-month-fig, fig.cap="Dispensing by health board", eval=FALSE}
dd <- NULL
gls_month_fig <- list()
for(i in drugs){
  dd <- datadist(glsData(i))
  options(datadist = "dd")
  gls_month_fig[[i]] <- 
    Predict(best_bs_models[[i]], Month, 
            hboard = "BC", dispensing = FALSE, wimd2019 = "Med", ngp = 5, 
            gp_load = 1329.486, 
            PC1 = median(gp_2020$PC1), PC2 = median(gp_2020$PC2), 
            PC3 = median(gp_2020$PC3), PC4 = median(gp_2020$PC4),
            conf.int = .95)
  
  options(datadist = NULL)
}

gls_month_fig %>% 
  map_dfr(as_tibble, .id = "drug") %>% 
  mutate(drug = as.factor(drug),
           drug = relevel(drug, ref = "all_drugs")) %>%
  ggplot(aes(x = Month, y = yhat)) +
  geom_line() +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0) +
  facet_wrap(~drug, scales = "free_y")

```

* This is broadly a repeat of what is seen in Figure 2 and what is described in the text referring to that section, therefore will not be repeated here.


### Health board

```{r gls-hb-fig-panel, fig.cap="Dispensing by health board"}
dd <- NULL
gls_hb_fig <- list()
for(i in drugs_hb){
  dd <- datadist(glsData(i))
  options(datadist = "dd")
  gls_hb_fig[[i]] <- 
    Predict(best_bs_models[[i]], Month, hboard,
            dispensing = FALSE, wimd2019 = "Med", ngp = 5, 
            gp_load = 1329.486, 
            PC1 = median(gp_2020$PC1), PC2 = median(gp_2020$PC2), 
            PC3 = median(gp_2020$PC3), PC4 = median(gp_2020$PC4),
            conf.int = .95)
  
  options(datadist = NULL)
}

gls_hb_fig %>% 
  map_dfr(as_tibble, .id = "drug") %>% 
  dplyr::mutate(Month = factor(x = Month, levels = 3:8, 
                           labels = month.abb[3:8]),
                drug = case_when(drug == "all_drugs" ~ "All",
                          drug == "ace" ~ "ACEi",
                          drug == "cortico" ~ "Inhaled \ncorticosteriods",
                          drug == "hcq" ~ "HCQ",
                          drug == "nsaid" ~ "NSAIDs",
                          drug == "oral_contra" ~ "Oral \ncontraceptives",
                          drug == "paracet" ~ "Paracetamol",
                          drug == "sal" ~ "Salbutamol",
                          drug == "ssri" ~ "SSRIs",
                          drug == "vitd" ~ "Vitamin D",
                          drug == "warfarin" ~ "Warfarin",
                          drug == "warfarin_ddd" ~"Warfarin")) %>% 
  ggplot(aes(x = Month, y = yhat, col = as.factor(hboard), group = hboard)) +
  geom_line(alpha = 0, position = position_dodge(.7)) +
  geom_point(position = position_dodge(.7), size = .5) +
  geom_errorbar(aes(ymin = lower, ymax = upper), width = .5, 
                position = position_dodge(.7)) +
  ggthemes::theme_few() +
  guides(col = guide_legend(ncol = 2)) +
  theme(legend.position = c(.8,.1),
        legend.title = element_text(size = 10, face = "bold", hjust = .5),
        legend.text = element_text(size = 10)) +
  scale_colour_viridis_d("Health board") +
  facet_wrap(~drug, scales = "free_y")

ggsave(filename = "Draft 5/Figures/health-board.png", device = "png", height = 14, width = 25, units = "cm")

```


* Seven of the eleven groups of medicines were dispensed differently across health boards.
* 


### Dispensing status

```{r, disp-contrast-fig, fig.cap="Dispensing status contrasts and 95% confidence limits from GLS models."}
disp_contrasts <- 
  list(
    all_drugs = contrast(best_bs_models$all_drugs, 
                         list(Month = 3:8, hboard = "BC", wimd2019 = "Med", 
                              ngp = 5, gp_load = 1329,
                              PC1 = median(gp_2020$PC1), PC2 = median(gp_2020$PC2), 
                              PC3 = median(gp_2020$PC3), PC4 = median(gp_2020$PC4),
                              dispensing = TRUE),
                         list(Month = 3:8, hboard = "BC", wimd2019 = "Med", 
                              ngp = 5, gp_load = 1329,
                              PC1 = median(gp_2020$PC1), PC2 = median(gp_2020$PC2), 
                              PC3 = median(gp_2020$PC3), PC4 = median(gp_2020$PC4),
                              dispensing = FALSE)) %>% 
      .[c("Month", "Contrast", "Lower", "Upper")] %>% 
      as.data.frame(),
    cortico = contrast(best_bs_models$cortico, 
                       list(Month = 3:8, hboard = "BC", wimd2019 = "Med", 
                            ngp = 5, gp_load = 1329,
                            PC1 = median(gp_2020$PC1), PC2 = median(gp_2020$PC2), 
                            PC3 = median(gp_2020$PC3), PC4 = median(gp_2020$PC4),
                            dispensing = TRUE),
                       list(Month = 3:8, hboard = "BC", wimd2019 = "Med", 
                            ngp = 5, gp_load = 1329,
                            PC1 = median(gp_2020$PC1), PC2 = median(gp_2020$PC2), 
                            PC3 = median(gp_2020$PC3), PC4 = median(gp_2020$PC4),
                            dispensing = FALSE)) %>% 
      .[c("Month", "Contrast", "Lower", "Upper")] %>% 
      as.data.frame(),
    paracet = contrast(best_bs_models$paracet, 
                       list(Month = 3:8, hboard = "BC", wimd2019 = "Med", 
                            ngp = 5, gp_load = 1329,
                            PC1 = median(gp_2020$PC1), PC2 = median(gp_2020$PC2), 
                            PC3 = median(gp_2020$PC3), PC4 = median(gp_2020$PC4),
                            dispensing = TRUE),
                       list(Month = 3:8, hboard = "BC", wimd2019 = "Med", 
                            ngp = 5, gp_load = 1329,
                            PC1 = median(gp_2020$PC1), PC2 = median(gp_2020$PC2), 
                            PC3 = median(gp_2020$PC3), PC4 = median(gp_2020$PC4),
                            dispensing = FALSE)) %>% 
      .[c("Month", "Contrast", "Lower", "Upper")] %>% 
      as.data.frame(),
    sal = contrast(best_bs_models$sal, 
                   list(Month = 3:8, hboard = "BC", wimd2019 = "Med", 
                        ngp = 5, gp_load = 1329,
                        PC1 = median(gp_2020$PC1), PC2 = median(gp_2020$PC2), 
                        PC3 = median(gp_2020$PC3), PC4 = median(gp_2020$PC4),
                        dispensing = TRUE),
                   list(Month = 3:8, hboard = "BC", wimd2019 = "Med", 
                        ngp = 5, gp_load = 1329,
                        PC1 = median(gp_2020$PC1), PC2 = median(gp_2020$PC2), 
                        PC3 = median(gp_2020$PC3), PC4 = median(gp_2020$PC4),
                        dispensing = FALSE)) %>% 
      .[c("Month", "Contrast", "Lower", "Upper")] %>% 
      as.data.frame(),
    vitd = contrast(best_bs_models$vitd, 
                    list(Month = 3:8, hboard = "BC", wimd2019 = "Med", 
                         ngp = 5, gp_load = 1329,
                         PC1 = median(gp_2020$PC1), PC2 = median(gp_2020$PC2), 
                         PC3 = median(gp_2020$PC3), PC4 = median(gp_2020$PC4),
                         dispensing = TRUE),
                    list(Month = 3:8, hboard = "BC", wimd2019 = "Med", 
                         ngp = 5, gp_load = 1329,
                         PC1 = median(gp_2020$PC1), PC2 = median(gp_2020$PC2), 
                         PC3 = median(gp_2020$PC3), PC4 = median(gp_2020$PC4),
                         dispensing = FALSE)) %>% 
      .[c("Month", "Contrast", "Lower", "Upper")] %>% 
      as.data.frame()
  ) %>% 
  bind_rows(.id = "drug")

(disp_plot <- disp_contrasts %>% 
  mutate(Month = factor(x = Month, levels = 3:8, 
                           labels = month.abb[3:8])) %>% 
  ggplot(aes(x = Month, col = drug)) +
  geom_point(aes(y = Contrast), size = .5, position = position_dodge(.25)) +
  geom_errorbar(aes(ymin = Lower, ymax = Upper), position = position_dodge(.25),
                width = 0) +
  geom_hline(aes(yintercept = 0), colour = "grey") +
  ggthemes::theme_few() +
  scale_colour_viridis_d("Drug", drop = FALSE) +
  ylab("Dispensing - Non-dispensing"))

ggsave(filename = "Draft 5/Figures/dispensing-status.png", device = "png", 
       height = 14, width = 25, units = "cm")


disp_contrasts %>% 
  arrange(drug) %>% 
  kable

```




* Predicted dispensing of all drugs, inhaled corticosteroids, paracetamol, and salbutamol was higher for dispensing practices during March 2020.
* Predicted dispensing of vitamin d was lower for dispensing practices from March to August 2020.


### WIMD

```{r, wimd-contrast-fig, fig.cap="WIMD contrasts and 95% confidence limits from GLS models."}
wimd_contrasts <- 
  list(
    ace = contrast(best_bs_models$ace, 
                       list(Month = 3:8, hboard = "BC", wimd2019 = "Low", 
                            ngp = 5, gp_load = 1329,
                            PC1 = median(gp_2020$PC1), PC2 = median(gp_2020$PC2), 
                            PC3 = median(gp_2020$PC3), PC4 = median(gp_2020$PC4),
                            dispensing = FALSE),
                       list(Month = 3:8, hboard = "BC", wimd2019 = "High", 
                            ngp = 5, gp_load = 1329,
                            PC1 = median(gp_2020$PC1), PC2 = median(gp_2020$PC2), 
                            PC3 = median(gp_2020$PC3), PC4 = median(gp_2020$PC4),
                            dispensing = FALSE)) %>% 
      .[c("Month", "Contrast", "Lower", "Upper")] %>% 
      as.data.frame(),
    cortico = contrast(best_bs_models$cortico, 
                       list(Month = 3:8, hboard = "BC", wimd2019 = "Low", 
                            ngp = 5, gp_load = 1329,
                            PC1 = median(gp_2020$PC1), PC2 = median(gp_2020$PC2), 
                            PC3 = median(gp_2020$PC3), PC4 = median(gp_2020$PC4),
                            dispensing = FALSE),
                       list(Month = 3:8, hboard = "BC", wimd2019 = "High", 
                            ngp = 5, gp_load = 1329,
                            PC1 = median(gp_2020$PC1), PC2 = median(gp_2020$PC2), 
                            PC3 = median(gp_2020$PC3), PC4 = median(gp_2020$PC4),
                            dispensing = FALSE)) %>% 
      .[c("Month", "Contrast", "Lower", "Upper")] %>% 
      as.data.frame(),
    sal = contrast(best_bs_models$sal, 
                   list(Month = 3:8, hboard = "BC", wimd2019 = "Low", 
                            ngp = 5, gp_load = 1329,
                            PC1 = median(gp_2020$PC1), PC2 = median(gp_2020$PC2), 
                            PC3 = median(gp_2020$PC3), PC4 = median(gp_2020$PC4),
                            dispensing = FALSE),
                       list(Month = 3:8, hboard = "BC", wimd2019 = "High", 
                            ngp = 5, gp_load = 1329,
                            PC1 = median(gp_2020$PC1), PC2 = median(gp_2020$PC2), 
                            PC3 = median(gp_2020$PC3), PC4 = median(gp_2020$PC4),
                            dispensing = FALSE)) %>% 
      .[c("Month", "Contrast", "Lower", "Upper")] %>% 
      as.data.frame(),
    ssri = contrast(best_bs_models$ssri, 
                       list(Month = 3:8, hboard = "BC", wimd2019 = "Low", 
                            ngp = 5, gp_load = 1329,
                            PC1 = median(gp_2020$PC1), PC2 = median(gp_2020$PC2), 
                            PC3 = median(gp_2020$PC3), PC4 = median(gp_2020$PC4),
                            dispensing = FALSE),
                       list(Month = 3:8, hboard = "BC", wimd2019 = "High", 
                            ngp = 5, gp_load = 1329,
                            PC1 = median(gp_2020$PC1), PC2 = median(gp_2020$PC2), 
                            PC3 = median(gp_2020$PC3), PC4 = median(gp_2020$PC4),
                            dispensing = FALSE)) %>% 
      .[c("Month", "Contrast", "Lower", "Upper")] %>% 
      as.data.frame(),
    vitd = contrast(best_bs_models$vitd, 
                    list(Month = 3:8, hboard = "BC", wimd2019 = "Low", 
                            ngp = 5, gp_load = 1329,
                            PC1 = median(gp_2020$PC1), PC2 = median(gp_2020$PC2), 
                            PC3 = median(gp_2020$PC3), PC4 = median(gp_2020$PC4),
                            dispensing = FALSE),
                       list(Month = 3:8, hboard = "BC", wimd2019 = "High", 
                            ngp = 5, gp_load = 1329,
                            PC1 = median(gp_2020$PC1), PC2 = median(gp_2020$PC2), 
                            PC3 = median(gp_2020$PC3), PC4 = median(gp_2020$PC4),
                            dispensing = FALSE)) %>% 
      .[c("Month", "Contrast", "Lower", "Upper")] %>% 
      as.data.frame()
  ) %>% 
  bind_rows(.id = "drug")

(wimd_plot <- wimd_contrasts %>% 
  mutate(Month = factor(x = Month, levels = 3:8, 
                           labels = month.abb[3:8])) %>% 
  ggplot(aes(x = Month, col = drug)) +
  geom_point(aes(y = Contrast), size = .5, position = position_dodge(.25)) +
  geom_errorbar(aes(ymin = Lower, ymax = Upper), position = position_dodge(.25),
                width = 0) +
  geom_hline(aes(yintercept = 0), colour = "grey") +
  ggthemes::theme_few() +
  scale_colour_viridis_d("Drug", drop = FALSE) +
  ylab("High - Low WIMD"))

ggsave(filename = "Draft 5/Figures/wimd.png", device = "png", height = 14, width = 25, units = "cm")

wimd_contrasts %>% 
  arrange(drug) %>% 
  kable

```




### Number of GPs

```{r, ngp-contrast-fig, fig.cap="NGP contrasts and 95% confidence limits from GLS models."}
ngp_contrasts <- 
  list(
    oral_contra = contrast(best_bs_models$oral_contra, 
                           list(Month = 3:8, hboard = "BC", wimd2019 = "High", 
                                ngp = 3, gp_load = 1329,
                                PC1 = median(gp_2020$PC1), PC2 = median(gp_2020$PC2), 
                                PC3 = median(gp_2020$PC3), PC4 = median(gp_2020$PC4),
                                dispensing = FALSE),
                           list(Month = 3:8, hboard = "BC", wimd2019 = "High", 
                                ngp = 8, gp_load = 1329,
                                PC1 = median(gp_2020$PC1), PC2 = median(gp_2020$PC2), 
                                PC3 = median(gp_2020$PC3), PC4 = median(gp_2020$PC4),
                                dispensing = FALSE)) %>% 
      .[c("Month", "Contrast", "Lower", "Upper")] %>% 
      as.data.frame(),
    sal = contrast(best_bs_models$sal, 
                   list(Month = 3:8, hboard = "BC", wimd2019 = "High", 
                        ngp = 3, gp_load = 1329,
                        PC1 = median(gp_2020$PC1), PC2 = median(gp_2020$PC2), 
                        PC3 = median(gp_2020$PC3), PC4 = median(gp_2020$PC4),
                        dispensing = FALSE),
                   list(Month = 3:8, hboard = "BC", wimd2019 = "High", 
                        ngp = 8, gp_load = 1329,
                        PC1 = median(gp_2020$PC1), PC2 = median(gp_2020$PC2), 
                        PC3 = median(gp_2020$PC3), PC4 = median(gp_2020$PC4),
                        dispensing = FALSE)) %>% 
      .[c("Month", "Contrast", "Lower", "Upper")] %>% 
      as.data.frame()) %>% 
  bind_rows(.id = "drug")

(ngp_plot <- ngp_contrasts %>% 
  mutate(Month = factor(x = Month, levels = 3:8, 
                           labels = month.abb[3:8])) %>% 
  ggplot(aes(x = Month, col = drug)) +
  geom_point(aes(y = Contrast), size = .5, position = position_dodge(.25)) +
  geom_errorbar(aes(ymin = Lower, ymax = Upper), position = position_dodge(.25),
                width = 0) +
  geom_hline(aes(yintercept = 0), colour = "grey") +
  ggthemes::theme_few() +
  scale_colour_viridis_d("Drug", drop = FALSE) +
  ylab("8 GPs - 3 GPs"))

ggsave(filename = "Draft 5/Figures/number-gps.png", device = "png", height = 14, width = 25, units = "cm")

ngp_contrasts %>% 
  arrange(drug) %>% 
  kable

```



### GP load

```{r, gpld-contrast-fig, fig.cap="NGP contrasts and 95% confidence limits from GLS models."}
gpld_contrasts <- 
  list(
    oral_contra = contrast(best_bs_models$oral_contra, 
                       list(Month = 3:8, hboard = "BC", wimd2019 = "High", 
                        ngp = 8, gp_load = 1098,
                        PC1 = median(gp_2020$PC1), PC2 = median(gp_2020$PC2), 
                        PC3 = median(gp_2020$PC3), PC4 = median(gp_2020$PC4),
                        dispensing = FALSE),
                       list(Month = 3:8, hboard = "BC", wimd2019 = "High", 
                        ngp = 8, gp_load = 1710,
                        PC1 = median(gp_2020$PC1), PC2 = median(gp_2020$PC2), 
                        PC3 = median(gp_2020$PC3), PC4 = median(gp_2020$PC4),
                        dispensing = FALSE)) %>% 
      .[c("Month", "Contrast", "Lower", "Upper")] %>% 
      as.data.frame()) %>% 
  bind_rows(.id = "drug")

(gp_load_plot <- gpld_contrasts %>% 
  mutate(Month = factor(x = Month, levels = 3:8, 
                           labels = month.abb[3:8])) %>% 
  ggplot(aes(x = Month, col = drug)) +
  geom_point(aes(y = Contrast), size = .5, position = position_dodge(.25)) +
  geom_errorbar(aes(ymin = Lower, ymax = Upper), position = position_dodge(.25),
                width = 0) +
  geom_hline(aes(yintercept = 0), colour = "grey") +
  ggthemes::theme_few() +
  scale_colour_viridis_d("Drug", drop = FALSE) +
  ylab("1710 per GP - 1098 per GP"))

ggsave(filename = "Draft 5/Figures/gp-workload.png", device = "png", height = 14, width = 25, units = "cm")

gpld_contrasts %>% 
  arrange(drug) %>% 
  kable

```



### Summary figure

```{r, summary-plot}
# names(drugs) <- c("ACE inhibitors", "Inhaled corticosteriods", "
#                   Hydroxychloroquine", "Non-steroidal anti-inflamatory drugs",
#                   "Oral contraceptives", "Paracetamol", "Salbutamol", )

contrasts <- 
  bind_rows(disp_contrasts, wimd_contrasts, ngp_contrasts, gpld_contrasts,
            .id = "effect") %>% 
  mutate(Month = factor(x = Month, levels = 3:8, 
                           labels = month.abb[3:8]),
         effect = case_when(effect == 1 ~ "Dispensing - Non-dispensing",
                            effect == 2 ~ "High - Low WIMD",
                            effect == 3 ~ "8 GPs - 3 GPs",
                            effect == 4 ~ "1710 per GP - 1098 per GP"),
         drug = case_when(drug == "all_drugs" ~ "All",
                          drug == "ace" ~ "ACEi",
                          drug == "cortico" ~ "Inhaled \ncorticosteriods",
                          drug == "hcq" ~ "HCQ",
                          drug == "nsaid" ~ "NSAIDs",
                          drug == "oral_contra" ~ "Oral \ncontraceptives",
                          drug == "paracet" ~ "Paracetamol",
                          drug == "sal" ~ "Salbutamol",
                          drug == "ssri" ~ "SSRIs",
                          drug == "vitd" ~ "Vitamin D",
                          drug == "warfarin" ~ "Warfarin",
                          drug == "warfarin_ddd" ~"Warfarin"),
         drug = factor(drug),
         effect = factor(effect,
                         levels = c("Dispensing - Non-dispensing", 
                                    "High - Low WIMD",
                                    "8 GPs - 3 GPs", 
                                    "1710 per GP - 1098 per GP")))


contrasts %>% 
  ggplot(aes(x = Month, col = drug)) +
  geom_point(aes(y = Contrast), size = .5, position = position_dodge(.25)) +
  geom_errorbar(aes(ymin = Lower, ymax = Upper), position = position_dodge(.25),
                width = 0) +
  geom_hline(aes(yintercept = 0), colour = "grey") +
  ggthemes::theme_few() +
  theme(legend.spacing.y = unit(0.5, 'cm'),
        plot.caption = element_text(size = 8, hjust = 1)) +
  guides(col = guide_legend(byrow = TRUE)) +
  labs(col = "Drug") +
  facet_wrap(~effect) +
  labs(caption = paste0("Adjusted to Health Board = BC, Dispensing status = FALSE, WIMD = Med, Number GPs = 5, \nGP workload = 1329, PC1 = ", printnum(median(gp_2020$PC1))," PC2 = ", printnum(median(gp_2020$PC1)), " PC3 = ", printnum(median(gp_2020$PC3)), " PC4 = ", printnum(median(gp_2020$PC4))))

ggsave(filename = "Draft 5/Figures/gls-summary-figure.png", device = "png", height = 14, width = 25, units = "cm")
```


