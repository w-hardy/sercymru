---
title: Supplementary Information
short_title: COVID-19 Prescribing
bibliography      : ["r-references.bib", "../references/library.bib"]
ouput: html_document
---

```{r setup, include = FALSE}
## Packages
# devtools::install_github("https://github.com/w-hardy/serCymruTools")
library(tidyverse)
library(lubridate)
library(tsibble)
library(rstan) # needed to load prophet
library(prophet)
library(fable)
library(fable.prophet)
library(fasster)
library(feasts)
library(furrr)
library(rebus)
library(serCymruTools)
library(knitr)
library(kableExtra)
library(geepack)
library(papaja)

r_refs("r-references.bib")


## Data
gp <- 
  read_rds("../data/gp_agesex_qof_combined.rds") %>% 
  mutate(npat = N,
         N = NULL,
         practice_id = as.character(practiceid)) %>% 
  ungroup() %>% 
  janitor::clean_names() %>% 
  select(practice_id, year, npat)

# GP extract data
data_files <-
  paste0("../data/prescribing_data/", list.files("../data/prescribing_data")) 
names(data_files) <- 
  str_remove_all(list.files("../data/prescribing_data"), ".rds")

# CV model accuracies
cv_model_files <- 
  paste0("../data/gp_cv_models/", 
         list.files("../data/gp_cv_models/"))
names(cv_model_files) <- 
  cv_model_files %>% 
  str_remove_all("../data/gp_cv_models/") %>% 
  str_remove_all("_gp_cv_models.rds")

# Forecast - observed
differences_files <- 
  list.files("../data/differences/")
names(differences_files) <- 
  str_remove_all(differences_files, "_discreps.rds")

differences <- 
  map_dfr(.x = differences_files,
          .f = ~read_rds(paste0("../data/differences/", .x)),
          .id = "drug") %>% 
  mutate(drug = relevel(as_factor(drug), ref = "all_drugs"))

```

```{r, analysis-preferences}
# Seed for random number generation
set.seed(32)
knitr::opts_chunk$set(cache.extra = knitr::rand_seed, cache = TRUE)
kable_opts <- options(knitr.kable.NA = "-")
```

\renewcommand{\appendixname}{Supplementary Material}
\renewcommand{\thefigure}{SI\arabic{figure}} \setcounter{figure}{0}
\renewcommand{\thetable}{SI\arabic{table}} \setcounter{table}{0}
\renewcommand{\theequation}{SI\arabic{table}} \setcounter{equation}{0}



## Reproducability and code


We used `r cite_r("r-references.bib")` for all our analyses, functions are available in the `serCymruTools` package [@R-serCymruTools], and all other code is available at https://github.com/w-hardy/sercymru.

## Forecasting

### Forecasting models

* We did not assume that the existing processes would be the same for all drugs or all GP practices, therefore, we investigated the fit of several different time series models to the pre-COVID data. 
* We used the `fable` [@R-fable], `fasster` [@R-fasster], and the `fable.prophet` [@R-fable.prophet] packages to conduct the time series analyses.
  * Simple methods
      * Naïve (with and without drift)
        * $\hat{y}_{T+h|T} = y_T$
      * Seasonal naïve (with and without drift)
        * $\hat{y}_{T+h|T} = y_{T-m(k+1)}$ where m = seasonal period and k is the complete years in $T+h$
  * STL Decomposition model [@Cleveland1990]
    * Fixed and variable seasonality
  * Time series linear model
    * $y_t = \beta_0 + \beta_1x_t + \varepsilon_t$
  * Autoregressive integrated moving average [ARIMA; @Box2015]
    * Using a version of the Hyndman-Khandakar algorithm [@Hyndman2008]
  * Exponential smoothing [@Holt2004; @Winters1960]
    * Simple exponential smoothing
    * Holt-Winters Additive Model [@Chatfield1978]
  * Forecasting with Additive Switching of Seasonality, Trends and Exogenous Regressors [fasster; @R-fasster]
    * State space model
  * Prophet [@Taylor2018]
  * Combination models [cf. @Bates1969; @Clemen1989; @Thomson2019]
* Prescribing quantities log transformed and forecasts use median values to reduce bias that back transformation would introduce when using the mean
* Using Jan 2015 to Dec 2019 data, we fitted several different models and assessed their accuracy using a cross-validated process to reduce the likelihood of overfitting models to the data.
  * Started with 36 months of data, used 6-month horizon as this was the horizon we would be using for the forecasts, 3-month step (to keep run-times manageable)
    * Only interested in one forecast horizon: six-months


## All prescribing


```{r, all-prescribing-model-accuracy-hist, fig.cap="All prescribing, model accuracy", eval=FALSE}
p1 <- all_prescribing_fable_fits %>% 
  na.omit() %>% 
  ggplot(aes(x = reorder(.model, RMSE, sort), y = RMSE)) +
  geom_col() +
  theme(axis.text.x = element_text(angle = 90))
  

p2 <- all_prescribing_fable_fits %>% 
  na.omit() %>% 
  ggplot(aes(x = reorder(.model, winkler, sort), y = winkler)) +
  geom_col() +
  theme(axis.text.x = element_text(angle = 90)) 

cowplot::plot_grid(p1, p2)
```


```{r, all-prescribing-cv-plot, fig.cap="All prescribing, best model CV fit", eval=FALSE}
all_prescribing_best_cv_model <- 
  augment(all_prescribing_fable_models) %>% 
  as_tibble() %>% 
  filter(.model == all_prescribing_best_model$.model) 

all_prescribing_best_cv_model %>% 
  ggplot(aes(x = datename)) +
  geom_line(aes(y = n/1e+06, colour = "Data")) +
  geom_line(aes(y = .fitted/1e+06, colour = "Fitted", lty = as.factor(.id))) +
  labs(lty = "CV iteration")
```


```{r, all-prescribing-forecast-plot, warning=FALSE, fig.cap="All prescribing, best model fit and forecast.", eval=FALSE}
plan(cluster)
all_prescribing %>% 
  ggplot(aes(x = datename)) +
  geom_line(aes(y = n, col = "Observed", fill = "Observed")) +
  geom_line(aes(y = med, col = "Forecast", fill = "Forecast"), 
            data = all_prescribing_covid_forecast) +
  geom_ribbon(aes(ymin = lb_80, ymax = ub_80, 
                  fill = "Forecast"), alpha = .2,
              data = all_prescribing_covid_forecast) +
  geom_ribbon(aes(ymin = lb_95, ymax = ub_95, 
                  fill = "Forecast"), alpha = .3,
              data = all_prescribing_covid_forecast) +
  # geom_line(aes(y = fitted, col = "Fitted", fill = "Fitted"), 
  #           data = fableModels(all_prescribing_pre_cv19) %>% 
  #             augment() %>% 
  #             as_tibble() %>% 
  #             filter(.model == all_prescribing_best_model$.model) %>% 
  #             group_by(datename) %>% 
  #             summarise(fitted = median(.fitted, na.rm = TRUE))) +
  geom_vline(xintercept = ymd("2020-03-01"), lty = 3) +
  coord_cartesian(xlim = c(dmy("01-11-2018"), dmy("01-08-2020"))) +
  scale_x_yearmonth(breaks = "6 months", minor_breaks = "1 months")+
  xlab("Date") +
  ylab("Mean daily prescribing volume")

plan(sequential)
```


```{r, all-prescribing-pct-change-plot, fig.cap="Percentage difference in all prescribing.", eval=FALSE}
all_prescribing %>% 
  inner_join(all_prescribing_covid_forecast, by = "datename") %>% 
  ggplot(aes(x = datename, y = (100*n/med)-100)) +
  geom_line() +
  geom_hline(yintercept = 0, lty = 3)
```


## Excluded practices

Table with a row for each drug and a column for each reason a practice could be excluded, with a total column at the end

(a) missing any data in the COVID months, (b) more than 10% of the pre-COVID data (i.e., 6 months) missing, (c) significant changes to prescribing in the six months pre-COVID (e.g., changes that suggested the practice had closed), or (d) MAPE >50.

```{r, excluded-practices-tab}
months <- c("2015 Jan","2015 Feb","2015 Mar","2015 Apr","2015 May","2015 Jun",
            "2015 Jul","2015 Aug","2015 Sep","2015 Oct","2015 Nov","2015 Dec",
            "2016 Jan","2016 Feb","2016 Mar","2016 Apr","2016 May","2016 Jun",
            "2016 Jul","2016 Aug","2016 Sep","2016 Oct","2016 Nov","2016 Dec",
            "2017 Jan","2017 Feb","2017 Mar","2017 Apr","2017 May","2017 Jun",
            "2017 Jul","2017 Aug","2017 Sep","2017 Oct","2017 Nov","2017 Dec",
            "2018 Jan","2018 Feb","2018 Mar","2018 Apr","2018 May","2018 Jun",
            "2018 Jul","2018 Aug","2018 Sep","2018 Oct","2018 Nov","2018 Dec",
            "2019 Jan","2019 Feb","2019 Mar","2019 Apr","2019 May","2019 Jun",
            "2019 Jul","2019 Aug","2019 Sep","2019 Oct","2019 Nov","2019 Dec",
            "2020 Jan","2020 Feb","2020 Mar","2020 Apr","2020 May","2020 Jun",
            "2020 Jul","2020 Aug")

monthlyPrescribing <- 
  function(data){
    data %>% 
      janitor::clean_names() %>% 
      mutate(datename = dmy(paste0("28-", datename)),
             practice_id = as.character(practice_id)) %>% 
      countRegional(practice_id, datename, quantity) %>% 
      mutate(year = year(datename)) %>%
      as_tibble() %>% 
      inner_join(gp, 
                 by = c("regional_unit" = "practice_id", "year")) %>% 
      mutate(n = 1000*n/npat,
             datename = yearmonth(datename),
             regional_unit = as_factor(regional_unit)) %>% 
      select(-c(npat, year)) %>% 
      as_tsibble(index = datename, key = regional_unit) %>% 
      fill_gaps()
  }

gpMissing <- 
  function(data){
    data %>% 
      as_tibble() %>% 
      pivot_wider(id_cols = regional_unit, names_from = datename,
                  values_from = n, values_fill = NA) %>% 
      select(all_of(months), everything()) %>% 
      rowwise() %>% 
      mutate(across(.cols = `2015 Jan`:`2020 Aug`, .fns = is.na)) %>% 
      group_by(regional_unit) %>% 
      summarise(miss_non_covid = sum(c_across(`2015 Jan`:`2019 Dec`)),
                miss_covid = sum(c_across(`2020 Mar`:`2020 Aug`))) %>% 
      filter(miss_covid > 0 | miss_non_covid > 0) %>% 
      mutate(miss_10_non_covid = if_else(miss_non_covid > 60/10, TRUE, FALSE))
  }

missRemove <- 
  function(data){
    data %>% 
      mutate(remove = if_else((miss_covid > 0 | miss_10_non_covid == TRUE), TRUE, FALSE)) %>% 
      summarise(miss_covid = sum(if_else(miss_covid > 0, TRUE, FALSE)),
                miss_10_non_covid = sum(if_else(miss_non_covid > 60/10, TRUE, FALSE)),
                miss_either = sum(if_else(remove == TRUE, TRUE, FALSE)))
  }

n_practices <- 
  data_files %>% 
  map(read_rds) %>% 
  map(pluck("practice_id")) %>% 
  map(unique) %>% 
  map_dfr(length) %>% 
  pivot_longer(cols = everything(), names_to = "drug", values_to = "n")

missing_raw_data <- 
  data_files %>% 
  map(read_rds) %>% 
  map(monthlyPrescribing) %>% 
  map(gpMissing) %>% 
  map_dfr(missRemove, .id = "drug")

poor_forcasts <- 
  cv_model_files %>% 
  map_dfr(.id = "drug", .f = read_rds) %>% 
  rankModels() %>% 
  group_by(drug, regional_unit) %>% 
  slice(1, .preserve = TRUE) %>% 
  filter(MAPE >= 50) %>% 
  group_by(drug) %>% 
  summarise(mape_over_50 = n())

n_practices %>% 
  left_join(missing_raw_data, by = "drug") %>% 
  left_join(poor_forcasts, by = "drug") %>% 
  rowwise() %>% 
  mutate(mape_over_50 = if_else(is.na(mape_over_50), as.integer(0), mape_over_50),
         total_removed = miss_either + mape_over_50) %>% 
  knitr::kable(booktabs = TRUE, linesep = "",
               caption = "Summary of GP practices removed for each drug.") %>% 
  footnote(general = "The total is not always equal to the row sum, as a single practice may be missing both data in covid months and more than 10\\% of data in the non-covid months, but will only be excluded once.",
           threeparttable = TRUE)

n_practices %>% 
  summarise(sum(n))

length(unique(gp$practice_id))
```


## Cross-validated model accuracy

```{r, cv-model-accuracy-by-drug-tab}
cv_model_files %>% 
  map_dfr(.id = "drug", .f = read_rds) %>% 
  rankModels() %>% 
  group_by(drug, regional_unit) %>% 
  slice(1, .preserve = TRUE) %>% 
  filter(MAPE < 50) %>% 
  group_by(drug) %>% 
  summarise(n_practice_retained = n(),
            mape_mean = mean(MAPE),
            mape_sd = sd(MAPE)) %>% 
  kable(caption = "Accuaracy of cross-validated models retained for forecasting.",
               digits = 2)
```


```{r, individual-drug-accuracy-plot, fig.cap="Accuracy of best model for each regional unit by drug, as measured by mean absoloute percentage error (MAPE). Models with MAPE > 50 have been removed."}
cv_model_files %>% 
  map_dfr(.id = "drug", .f = read_rds) %>% 
  rankModels() %>% 
  group_by(drug, regional_unit) %>% 
  slice(1, .preserve = TRUE) %>% 
  filter(MAPE < 50) %>% 
  mutate(drug = as.factor(drug),
         drug = relevel(as_factor(drug), ref = "all_drugs")) %>% 
  ggplot(aes(x = drug, y = MAPE, col = drug)) +
  geom_violin() +
  geom_jitter(alpha = .1) +
  xlab("Medicine group")+
  theme(legend.position = "none")
```


```{r best-cv-model-type, fig.cap="Performance by model type."}
cv_model_files %>% 
  map_dfr(.id = "drug", .f = read_rds) %>% 
  rankModels() %>% 
  group_by(drug, regional_unit) %>% 
  slice(1, .preserve = TRUE) %>% 
  filter(MAPE < 50) %>% 
  ggplot(aes(x = as.factor(.model))) +
  geom_bar() +
  theme(axis.text.x = element_text(angle = 90))
```


## Warfarin

```{r, oac-gen-trend, eval=FALSE}
oac <- read_rds(data_files[9])

oac %>% 
  mutate(warfarin = if_else(bnfchem == "0208020V0", TRUE, FALSE)) %>% 
  group_by(warfarin, datename) %>% 
  summarise(quantity = sum(quantity), .groups = "drop") %>% 
  pivot_wider(id_cols = datename, values_from = quantity, names_from = warfarin) %>% 
  mutate(prop = `TRUE` / (`TRUE` + `FALSE`),
         datename = yearmonth(dmy(paste0("28-", datename)))) %>% 
  tsibble() %>% 
  autoplot(prop) +
  xlab("Date") +
  ylab("Warfarin as a proportion of all oral anticoagulant prescribing")

```



\newpage

## SM References

\begingroup
\setlength{\parindent}{-0.5in}
\setlength{\leftskip}{0.5in}

<div id="refs" custom-style="Bibliography"></div>
\endgroup

\newpage
