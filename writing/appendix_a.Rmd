---
title: "Supplementary Information"
short_title: COVID-19 Prescribing
bibliography:
- r-references.bib
- ../references/library.bib
output:
  pdf_document: default

papersize: a4
header-includes:
  \usepackage{float}
  \let\origfigure\figure
  \let\endorigfigure\endfigure
  \renewenvironment{figure}[1][2] {
      \expandafter\origfigure\expandafter[H]
  } {
      \endorigfigure
  }

---

```{r setup, include = FALSE}
## Packages
# devtools::install_github("w-hardy/serCymruTools")
library(plyr); library(dplyr)
library(rms)
library(nlme)
library(tidyverse)
library(lubridate)
library(tsibble)
library(fable)
library(feasts)
library(furrr)
library(rebus)
library(serCymruTools)
library(knitr)
library(kableExtra)
library(papaja)
library(fuzzyjoin)
library(ggbiplot)

r_refs("r-references.bib")

## Data
gp <- 
  read_rds("../data/gp_agesex_qof_combined.rds") %>% 
  mutate(npat = N,
         N = NULL,
         practice_id = as.character(practiceid),
         hboard = case_when(hboard == "W11000023" ~ "BC",
                            hboard == "W11000024" ~ "P",
                            hboard == "W11000025" ~ "HD",
                            hboard == "W11000028" ~ "AB",
                            hboard == "W11000029" ~ "CaV",
                            hboard == "W11000030" ~ "CTM",
                            hboard == "W11000031" ~ "SB")) %>% 
  ungroup() %>% 
  janitor::clean_names() %>% 
  mutate(dispensing = case_when(tolower(dispensing) == "yes" ~ TRUE, 
                                tolower(dispensing) == "no" ~ FALSE),
         hboard = as.factor(hboard))

# GP extract data
data_files <-
  paste0("../data/prescribing_data/", list.files("../data/prescribing_data")) 
names(data_files) <- 
  str_remove_all(list.files("../data/prescribing_data"), ".rds")
pres_data <- 
  map(data_files, read_rds)

# CV model accuracies
cv_model_files <- 
  paste0("../data/gp_cv_models/", 
         list.files("../data/gp_cv_models/"))
names(cv_model_files) <- 
  cv_model_files %>% 
  str_remove_all("../data/gp_cv_models/") %>% 
  str_remove_all("_gp_cv_models.rds")

# Forecast - observed
differences_files <- 
  list.files("../data/differences/")
names(differences_files) <- 
  str_remove_all(differences_files, "_discreps.rds")

plan(cluster)
differences <- 
  furrr::future_map_dfr(.x = differences_files,
                        .f = ~read_rds(paste0("../data/differences/", .x)),
                        .id = "drug") %>% 
  mutate(drug = relevel(as_factor(drug), ref = "quant_all_drugs"),
         drug = str_remove_all(drug, "ddd_"),
         drug = str_remove_all(drug, "quant_"),
         drug = str_remove_all(drug, "_ddd")) %>% 
  filter(regional_unit != "W95636") #https://abuhb.nhs.wales/news/news/important-information-regarding-lansbury-surgery-caerphilly/

plan(sequential)


drugs <- unique(differences$drug)


# Seed for random number generation
set.seed(32)
knitr::opts_chunk$set(cache.extra = knitr::rand_seed, cache = TRUE, 
                      echo = FALSE, fig.pos = 'h!')
kable_opts <- options(knitr.kable.NA = "-")
```

\renewcommand{\appendixname}{Supplementary Material}
\renewcommand{\thefigure}{SI\arabic{figure}} \setcounter{figure}{0}
\renewcommand{\thetable}{SI\arabic{table}} \setcounter{table}{0}
\renewcommand{\theequation}{SI\arabic{table}} \setcounter{equation}{0}


## GP PCA

```{r, gp-pca, fig.cap="Variance of QoF variables explained by individual principal components (lines) with cumulative proportion of variance explained (text)."}
#### Data ####
gp_2020 <- 
  filter(gp, year == 2020) %>% 
  rename(regional_unit = practice_id)
  

#### Functions ####
# Add cumulative fraction of variance explained
addScree <- function(x, npcs=min(10, length(x$sdev)),
                     plotv = FALSE,
                     col = 1, offset = .8, adj = 0, pr = FALSE){
  vars <- x$sdev^2
  cumv <- cumsum(vars)/sum(vars)
  if(pr) print(cumv)
  text(1:npcs, vars[1:npcs] + offset*par("cxy")[2],
       as.character(round(cumv[1:npcs], 2)),
       srt = 45, adj = adj, cex = .65, xpd = NA, col = col)
}

#### Analysis ####
gp_pca <- 
  prcomp(select(gp_2020, c(chd:flu, p_fem, pm_65, pf_65)), center = TRUE, scale. = TRUE)

plot(gp_pca, type = "lines", main = " ", pch = 3)
addScree(gp_pca)
abline(h = 1, col = "blue")

gp_2020 <- 
  gp_2020 %>% 
  left_join(bind_cols(regional_unit = gp_2020$regional_unit, gp_pca$x), 
            by = "regional_unit") %>% 
  select(regional_unit = regional_unit, everything(),
         -c(practiceid, county, postcode, lsoacode, easting, northing,
            chd:flu, PC6:PC20, year))
```


```{r, gp-pca-direction, fig.cap=c("QoF disease register loadings on PC 1-2","QoF disease register loadings on PC 2-3","QoF disease register loadings on PC 3-4","QoF disease register loadings on PC 4-5")}
p1 <- ggbiplot(gp_pca, ellipse = FALSE, groups = gp_2020$hboard, obs.scale = 1, 
         var.scale = 1, alpha = .3, varname.size = 5, varname.adjust = 5)  +
      scale_colour_viridis_d(name = "Health board")
p2 <- ggbiplot(gp_pca, choices = 2:3,
         ellipse = FALSE, groups = gp_2020$hboard, obs.scale = 1, 
         var.scale = 1, alpha = .3, varname.size = 5, varname.adjust = 5)  +
      scale_colour_viridis_d(name = "Health board")
p3 <- ggbiplot(gp_pca, choices = 3:4,
         ellipse = FALSE, groups = gp_2020$hboard, obs.scale = 1, 
         var.scale = 1, alpha = .3, varname.size = 5, varname.adjust = 5)  +
      scale_colour_viridis_d(name = "Health board")
p4 <- ggbiplot(gp_pca, choices = 4:5,
         ellipse = FALSE, groups = gp_2020$hboard, obs.scale = 1, 
         var.scale = 1, alpha = .3, varname.size = 5, varname.adjust = 5)  +
      scale_colour_viridis_d(name = "Health board")
p1
cat("\n\n")
p2
cat("\n\n")
p3
cat("\n\n")
p4
cat("\n\n")

```


## Excluded practices

Table with a row for each drug and a column for each reason a practice could be excluded, with a total column at the end

(a) missing any data in the COVID months, (b) more than 10% of the pre-COVID data (i.e., 6 months) missing, or (c) MAPE >50.


```{r, excluded-practices-tab, eval=TRUE}
months <- c("2015 Jan","2015 Feb","2015 Mar","2015 Apr","2015 May","2015 Jun",
            "2015 Jul","2015 Aug","2015 Sep","2015 Oct","2015 Nov","2015 Dec",
            "2016 Jan","2016 Feb","2016 Mar","2016 Apr","2016 May","2016 Jun",
            "2016 Jul","2016 Aug","2016 Sep","2016 Oct","2016 Nov","2016 Dec",
            "2017 Jan","2017 Feb","2017 Mar","2017 Apr","2017 May","2017 Jun",
            "2017 Jul","2017 Aug","2017 Sep","2017 Oct","2017 Nov","2017 Dec",
            "2018 Jan","2018 Feb","2018 Mar","2018 Apr","2018 May","2018 Jun",
            "2018 Jul","2018 Aug","2018 Sep","2018 Oct","2018 Nov","2018 Dec",
            "2019 Jan","2019 Feb","2019 Mar","2019 Apr","2019 May","2019 Jun",
            "2019 Jul","2019 Aug","2019 Sep","2019 Oct","2019 Nov","2019 Dec",
            "2020 Jan","2020 Feb","2020 Mar","2020 Apr","2020 May","2020 Jun",
            "2020 Jul","2020 Aug")

monthlyPrescribing <- 
  function(data){
    data %>% 
      janitor::clean_names() %>% 
      mutate(datename = dmy(paste0("28-", datename)),
             practice_id = as.character(practice_id)) %>% 
      countRegional(practice_id, datename, quantity) %>% 
      mutate(year = year(datename)) %>%
      as_tibble() %>% 
      inner_join(gp %>% 
                   select(practice_id, year, npat), 
                 by = c("regional_unit" = "practice_id", "year")) %>% 
      mutate(n = 1000*n/npat,
             datename = yearmonth(datename),
             regional_unit = as_factor(regional_unit)) %>% 
      select(-c(npat, year)) %>% 
      as_tsibble(index = datename, key = regional_unit) %>% 
      fill_gaps()
  }

gpMissing <- 
  function(data){
    data %>% 
      as_tibble() %>% 
      pivot_wider(id_cols = regional_unit, names_from = datename,
                  values_from = n, values_fill = NA) %>% 
      select(all_of(months), everything()) %>% 
      rowwise() %>% 
      mutate(across(.cols = `2015 Jan`:`2020 Aug`, .fns = is.na)) %>% 
      group_by(regional_unit) %>% 
      summarise(miss_non_covid = sum(c_across(`2015 Jan`:`2019 Dec`)),
                miss_covid = sum(c_across(`2020 Jan`:`2020 Aug`))) %>% 
      filter(miss_covid > 0 | miss_non_covid > 0) %>% 
      mutate(miss_10_non_covid = if_else(miss_non_covid >= 60/10, TRUE, FALSE))
  }

missRemove <- 
  function(data){
    data %>% 
      mutate(remove = if_else((miss_covid > 0 | miss_10_non_covid == TRUE), 
                              TRUE, FALSE)) %>% 
      summarise(miss_covid = sum(if_else(miss_covid > 0, TRUE, FALSE)),
                miss_10_non_covid = sum(if_else(miss_non_covid >= 60/10, TRUE,
                                                FALSE)),
                miss_either = sum(if_else(remove == TRUE, TRUE, FALSE)))
  }

plan(cluster)

full_data <- 
  data_files[grep(pattern = "../data/prescribing_data/warfarin_ddd_nat.rds",
                x = data_files, value = FALSE, invert = TRUE)] %>% 
  furrr::future_map(read_rds)

n_practices <- 
  full_data %>% 
  map(pluck("practice_id")) %>% 
  map(unique) %>% 
  map_dfr(length) %>% 
  pivot_longer(cols = everything(), names_to = "drug", values_to = "n")

missing_gp  <-
  full_data %>% 
  map(pluck("practice_id")) %>% 
  map(unique) %>% 
  map_dfr(~length(.)-sum(. %in% gp$practice_id), .id = "drug") %>% 
  pivot_longer(cols = everything(), names_to = "drug", 
               values_to = "missing_gp")

missing_raw_data <- 
  full_data %>% 
  furrr::future_map(monthlyPrescribing) %>% 
  furrr::future_map(gpMissing) %>% 
  furrr::future_map_dfr(missRemove, .id = "drug")

poor_forcasts <- 
  cv_model_files %>% 
  map_dfr(.id = "drug", .f = read_rds) %>% 
  rankModels() %>% 
  group_by(drug, regional_unit) %>% 
  slice(1, .preserve = TRUE) %>% 
  filter(MAPE >= 50) %>% 
  group_by(drug) %>% 
  summarise(mape_over_50 = n())
plan(sequential)

n_practices %>% 
  left_join(missing_gp, by = "drug") %>% 
  left_join(missing_raw_data, by = "drug") %>% 
  left_join(poor_forcasts, by = "drug") %>% 
  mutate(drug = str_remove_all(drug, "ddd_"),
         drug = str_remove_all(drug, "quant_"),
         drug = str_remove_all(drug, "_ddd"),
         drug = relevel(as_factor(drug), ref = "all_drugs")) %>%
  rowwise() %>% 
  mutate(mape_over_50 = if_else(is.na(mape_over_50), as.integer(0), mape_over_50),
         total_removed = missing_gp + miss_either + mape_over_50, 
         n_rem = n - total_removed) %>% 
  knitr::kable(booktabs = TRUE, linesep = "", 
               col.names = c("Drug", "n", "GP", "COVID", "10% non-COVID",
                             "Dispensing", "MAPE >50", "Total", "Remain"),
               caption = "Summary of GP practices removed for each drug.") %>% 
  kableExtra::add_header_above(c(" "= 2, "Missing" = 4, "Removed" = 2, " " = 1)) %>% 
  footnote(general = '"Dispensing" is not always equal to the sum of COVID and 10% non-COVID, as a single practice may be missing both data in covid months and more than 10% of data in the non-covid months, but will only be excluded once.',
           threeparttable = TRUE)



```


```{r, big-discrepacies, eval=FALSE}

bigDiscreps <- function(x){
  message(x)
  
  big_discreps2 <- 
    differences %>% 
    filter(drug == x) %>% 
    filter(prop <.3| prop > 2) %>% 
    group_by(regional_unit) %>% 
    count()
  
  differences %>% 
    filter(drug == x) %>% 
    filter(regional_unit %in% big_discreps2$regional_unit) %>% 
    mutate(uid = paste(x, regional_unit)) %>% 
    ggplot(aes(x = datename, col = as.factor(regional_unit))) +
    geom_line(aes(y = med), lty = 1) +
    geom_line(aes(y = n), lty = 2) +
    facet_wrap(~uid, scales = "free") +
    theme(legend.position = "none")
}

map(.x = drugs, .f = ~bigDiscreps(.x))

```


## Forecasting

### Forecasting models

* We did not assume that the existing processes would be the same for all drugs or all GP practices, therefore, we investigated the fit of several different time series models to the pre-COVID data. 
* We used the `fable` [@R-fable] and `fasster` [@R-fasster] packages to conduct the time series analyses.
  * Time series linear model
    * $y_t = \beta_0 + \beta_1x_t + \varepsilon_t$
  * Simple methods
      * Naïve (with and without drift)
        * $\hat{y}_{T+h|T} = y_T$
      * Seasonal naïve (with and without drift)
        * $\hat{y}_{T+h|T} = y_{T-m(k+1)}$ where $m$ = seasonal period and $k$ is the complete years in $T+h$
  * Seasonal and Trend decomposition using Loess (STL) model [@Cleveland1990]
    * Fixed and variable seasonality
  * Autoregressive integrated moving average [ARIMA; @Box2015]
    * Using a version of the Hyndman-Khandakar algorithm [@Hyndman2008]
  * Exponential smoothing [@Holt2004; @Winters1960]
    * Simple exponential smoothing
    * Holt-Winters Additive Model [@Chatfield1978]
  * Forecasting with Additive Switching of Seasonality, Trends and Exogenous Regressors [fasster; @R-fasster]
    * State space model
  * Combination models [cf. @Clemen1989; @Thomson2019]
    * Forecasts that are made by combining models are often more accurate than those of the individual forecasts and often a simple average can significantly improve forecast accuracy.
    

    
* Prescribing quantities were log transformed and the forecasts use median estimates of prescribing to reduce bias that back transformation would introduce when using the mean
* Using January 2015 to December 2019 data, we fitted several different models and assessed their accuracy using a cross-validated process to reduce the likelihood of overfitting models to the data.
  * Started with 36 months of data, used an 8-month horizon as this was the horizon we would be using for the forecasts, 1-month step
    * Only interested in one forecast horizon: eight-months
    
```{r, time-series-model-tab}

readxl::read_xlsx("time_series_models.xlsx") %>% 
    knitr::kable(booktabs = TRUE, linesep = "",
               caption = "Description of time series models used.")

```

## Reproducability and code

We used `r cite_r("r-references.bib")` for all our analyses, functions are available in the `serCymruTools` package [@R-serCymruTools], and all other code is available at https://github.com/w-hardy/sercymru.


## Cross-validated model accuracy

```{r, cv-model-accuracy-by-drug-tab, eval=FALSE}
cv_model_files %>% 
  map_dfr(.id = "drug", .f = read_rds) %>% 
  mutate(drug = str_remove_all(drug, "ddd_"),
         drug = str_remove_all(drug, "quant_"),
         drug = str_remove_all(drug, "_ddd"),
         drug = relevel(as_factor(drug), ref = "all_drugs")) %>%
  rankModels() %>% 
  group_by(drug, regional_unit) %>% 
  slice(1, .preserve = TRUE) %>% 
  filter(MAPE < 50) %>% 
  group_by(drug) %>% 
  summarise(n_practice_retained = n(),
            mape_mean = mean(MAPE),
            mape_sd = sd(MAPE)) %>% 
  kable(caption = "Accuaracy of cross-validated models retained for forecasting.",
               digits = 2)
```


```{r, individual-drug-accuracy-plot, fig.cap="Accuracy of best model for each regional unit by drug, as measured by mean absoloute percentage error (MAPE). Models with MAPE > 50 have been removed. ACEi = ACE inhibitors, BAA = Beta~2~ adrenoceptor agonists, HCQ = Hydroxycholoroquine."}

plan(cluster)
cv_model_files %>% 
  furrr::future_map_dfr(.id = "drug", .f = read_rds) %>% 
  mutate(drug = str_remove_all(drug, "ddd_"),
         drug = str_remove_all(drug, "quant_"),
         drug = str_remove_all(drug, "_ddd"),
         drug = case_when(drug == "all_drugs" ~ "All",
                          drug == "ace" ~ "ACEi",
                          drug == "adreno" ~ "BAA",
                          drug == "cortico" ~ "Inhaled \ncortico",
                          drug == "hcq" ~ "HCQ",
                          drug == "nsaid" ~ "NSAIDs",
                          drug == "oral_contra" ~ "Oral\ncontra",
                          drug == "paracet" ~ "Paracet",
                          drug == "ssri" ~ "SSRIs",
                          drug == "vitd" ~ "Vit D",
                          drug == "warfarin" ~ "Warfarin"),
         drug = relevel(as_factor(drug), ref = "All")) %>%
  rankModels() %>% 
  group_by(drug, regional_unit) %>% 
  slice(1, .preserve = TRUE) %>% 
  filter(MAPE < 50) %>% 
  ggplot(aes(x = drug, y = MAPE, col = drug)) +
  geom_violin() +
  geom_jitter(alpha = .1) +
  xlab("Medicine group") +
  theme(legend.position = "none")

```


```{r best-cv-model-type, fig.cap="Performance by model type."}
plan(cluster)
cv_model_files %>% 
  map_dfr(.id = "drug", .f = read_rds) %>% 
  rankModels() %>% 
  group_by(drug, regional_unit) %>% 
  slice(1, .preserve = TRUE) %>% 
  filter(MAPE < 50) %>% 
  ggplot(aes(x = as.factor(.model))) +
  geom_bar(aes(fill = as.factor(drug)), col = "black", size = .25) +
  theme(axis.text.x = element_text(angle = 90))
plan(sequential)
```



## Warfarin

```{r, oac-gen-trend, fig.cap="Warfarin as a percentage of all oral anticoagulant prescribing in Wales. Pink shading covers duration of Wales' \"stay at home\" order."}
read_rds("../data/prescribing_data/warfarin_ddd.rds") %>% 
  dplyr::group_by(datename) %>% 
  dplyr::summarise(quantity = median(quantity, na.rm = TRUE)) %>% 
  mutate(datename = yearmonth(dmy(paste0("28-", datename)))) %>% 
  ggplot(aes(x = datename)) + 
  geom_rect(aes(xmin = dmy("01-03-2020"), xmax = dmy("31-07-2020"), 
                ymin = -Inf, ymax = Inf),
            fill = 'pink', col = 0, alpha = 0.03) +
  geom_line(aes(y = quantity)) +
  geom_vline(aes(xintercept = dmy("01-03-2020")), lty = 2, col = "red") +
  scale_x_yearmonth() +
  xlab("Date") +
  ylab("Warfarin (percentage of all OACs)") +
  ylim(0, 100) # Dyfrig's request

```


## GLS Results

### Analysis

```{r, gls-functions}

#### Prep GLS data ####
glsData <- function(data){
  df <- 
    differences %>% 
    filter(drug == data) %>% 
    mutate(Month = as.numeric(as.factor(datename)),
           pct_change = 100*(prop - 1)) %>% 
    select(c(regional_unit, Month, pct_change)) %>% 
    filter(Month > 2) %>% 
    left_join(gp_2020, by = "regional_unit") %>% 
    mutate(gp_load = npat / ngp)
  
  dd <- datadist(df)
  options(datadist = "dd")
  
  return(df)
}


#### GLS Assumption Checking ####
glsAssump <- function(model, data){
  data$resid <- r <- resid(model); data$fitted <- fitted(model)
  y1 <- ylab("Residuals")
  p1 <- ggplot(data, aes(x = fitted, y = resid)) + geom_point(alpha = .1) + y1
  # p2 <- ggplot(data, aes(x = feb_diff, y = resid)) + geom_point(alpha = .1) + y1
  p3 <- ggplot(data, aes(x = Month, y = resid)) + y1 + 
    stat_summary(fun.data = "mean_sdl", geom = "smooth")
  p4 <- ggplot(data, aes(sample = resid)) + stat_qq(alpha = .1) + 
    geom_abline(intercept = mean(r), slope = sd(r)) + y1
  
  gridExtra::grid.arrange(p1, #p2, 
                          p3, p4, ncol = 2)
}

#### GLS Estimated Effects ####
percentiles <- function(data, var){
  # return vector of 5th, 25th, 50th, 75th, and 95th percentile
  var <- enquo(var)
  data %>% 
    summarise(enframe(stats::quantile(!!var, c(.05, .25, .5, .75, .95)), 
                      "Percentile", "value"), .groups = "drop") %>% 
    mutate(value = round(value)) %>% .$value
}

# dodge <- position_dodge(width = .25)
predictPlot <- function(data = ., groups, names){
  groups <- enquo(groups)
  data %>% 
    tibble() %>% 
    group_by(Month, !!groups) %>% 
    summarise(yhat = mean(yhat)) %>% 
    mutate(groups = as.factor(!!groups)) %>% 
    ggplot(aes(x = Month, y = yhat, group = groups)) +
    geom_line(aes(col = groups)) +
    scale_colour_viridis_d(name = names) +
    scale_fill_viridis_d(name = names) +
    theme(legend.position = "top") +
    ylab(bquote(~X~hat(beta))) +
    ggthemes::theme_hc()
}

glsEffects <- function(model, name, data){
  
  Name <- case_when(name == "all_drugs" ~ "All",
                    name == "ace" ~ "ACEi",
                    name == "adreno" ~ "BAA",
                    name == "cortico" ~ "Inhaled \ncortico",
                    name == "hcq" ~ "HCQ",
                    name == "nsaid" ~ "NSAIDs",
                    name == "oral_contra" ~ "Oral\ncontra",
                    name == "paracet" ~ "Paracet",
                    name == "ssri" ~ "SSRIs",
                    name == "vitd" ~ "Vit D",
                    name == "warfarin" ~ "Warfarin")
  
  cat("\n\n")

  #### Plot interactions #### not including month*ngp as none significant
  p1 <- Predict(model, Month, dispensing, hboard, conf.int = .95) %>% 
    predictPlot(., groups = hboard, "Health board")
  gridExtra::grid.arrange(p1,nrow = 1, newpage = TRUE) # Effects 1
  cat("\n\n")
  
  p2 <- Predict(model, Month,  dispensing, hboard, conf.int = .95) %>% 
    predictPlot(., groups = dispensing, "Dispensing")
  gridExtra::grid.arrange(p2,nrow = 1, newpage = TRUE) # Effects 2
  cat("\n\n")
  
  p1 <- Predict(model, Month, dispensing, hboard,
                wimd2019 = percentiles(data, wimd2019),
                conf.int = .95) %>% 
        group_by(Month, wimd2019) %>% 
    summarise(yhat = mean(yhat)) %>% 
    predictPlot(., groups = wimd2019, "WIMD")
    gridExtra::grid.arrange(p1, nrow = 1, newpage = TRUE) # Effects 3
  cat("\n\n")
  
  p1 <- Predict(model, Month, dispensing, hboard,
                ngp = percentiles(data, ngp),
                conf.int = .95) %>% 
    predictPlot(., groups = ngp, "Number of GPs")
  gridExtra::grid.arrange(p1, ncol = 1, newpage = TRUE) # Effects 5
  cat("\n\n")
  
  p2 <- Predict(model, Month, dispensing, hboard,
                gp_load = percentiles(data, gp_load),
                conf.int = .95) %>% 
    predictPlot(., groups = gp_load, "GP load")
  gridExtra::grid.arrange(p2, nrow = 1, newpage = TRUE) # Effects 4
  cat("\n\n")
  
  
  # p1 <- Predict(model, Month, dispensing, hboard,
  #               PC1 = percentiles(data, PC1),
  #               conf.int = .95) %>% 
  #   predictPlot(., groups = PC1, "PC1")
  # p2 <- Predict(model, Month, dispensing, hboard,
  #               PC2 = percentiles(data, PC2),
  #               conf.int = .95) %>% 
  #   predictPlot(., groups = PC2, "PC2")
  # p3 <- Predict(model, Month, dispensing, hboard,
  #               PC3 = percentiles(data, PC3),
  #               conf.int = .95) %>% 
  #   predictPlot(., groups = PC3, "PC3")
  # p4 <- Predict(model, Month, dispensing, hboard,
  #               PC4 = percentiles(data, PC4),
  #               conf.int = .95) %>% 
  #   predictPlot(., groups = PC4, "PC4")
  # gridExtra::grid.arrange(p1,p2,p3,p4, ncol = 2, newpage = TRUE) # Effects 6
  # cat("\n\n")
  
  
  # #### ANOVA plot ####
  # p <- 
  #   capture.output(anova(model))[4:41] %>%
  #   read_fwf(fwf_empty(., col_names = c("Factor", "Chi-Square", "d.f.", "P"))) %>% 
  #   mutate(Factor = 
  #            str_remove_all(Factor, 
  #                           c(OPEN_PAREN %R% "Factor" %R% PLUS %R% 
  #                               "Higher Order Factors" %R% CLOSE_PAREN))) %>% 
  #   filter(!str_detect(Factor, "Nonlinear") &
  #            !str_detect(Factor, "TOTAL") &
  #            Factor != "All Interactions",
  #          !str_detect(Factor, c("f" %R% OPEN_PAREN %R% "A,B"))) %>% 
  #   ggplot(aes(x = `Chi-Square`-`d.f.`, 
  #              y = reorder(Factor, X = `Chi-Square`-`d.f.`))) +
  #   geom_point(aes(col = 
  #                    as.factor(if_else(as.numeric(str_remove_all(P, "<"))<.05, 
  #                                      TRUE,FALSE)))) +
  #   scale_color_discrete(name = "P < .05") + 
  #   xlab(expression(chi^2-"d.f.")) +
  #   ylab(NULL) +
  #   ggthemes::theme_few() 
  # 
  # gridExtra::grid.arrange(p, newpage = TRUE)
  # cat("\n\n")
  
  p <- anova(model, rm.other = list("Month"), trans = sqrt,
             tol = 1e-10, dec.chisq = 2, dec.p = 2) %>% 
    plot()
  
  p

  #### ANOVA Table ####
  # model %>% 
  #   anova() %>% 
  #   kable(booktabs = TRUE, linesep = "", digits = 2,
  #         caption = paste(Name, "Wald z-test statistics")) %>% 
  #   # add_indent(positions = c(3,5,6,8,10,11,13,15,17,19,21,23,25,27,28,30:34)) %>% 
  #   kable_styling(latex_options = c("striped", "HOLD_position", "repeat_header")) %>% 
  #   print()

  cat("\n\n")
}


gls_analysis_fig_cap <- NULL
for (i in 1:length(drugs)) {
  gls_analysis_fig_cap <- 
    c(gls_analysis_fig_cap, 
      paste(drugs[i], c("Assumptions", "Health board effects.", "Dispensing status effect.", "WIMD effects. Lines represent the 5th, 25th, 50th, 75th, and 95th quantiles.", "Number of GPs effects. Lines represent the 5th, 25th, 50th, 75th, and 95th quantiles.", "Patients per GP effects. Lines represent the 5th, 25th, 50th, 75th, and 95th quantiles.", "Patient related variable principal components 1-4 effects. Lines represent the 5th, 25th, 50th, 75th, and 95th quantiles.", "Relative importance of effects.")))
}



```


```{r, gls-analysis-read}
#### gls-analysis-read ####
best_models <- read_rds("../data/gls/best_models.rds")
best_bs_models <- read_rds("../data/gls/best_bs_models.rds")
```


```{r, gls-effects, results="asis", fig.cap=gls_analysis_fig_cap, dependson="gls-functions"}
#### gls-effects ####

dd <- NULL
for(i in 1:length(best_bs_models)){
  cat("####", (drugs[i]), "\n\n")
  cat("#####", "Assumptions\n\n")
  gls_data <- glsData(drugs[i])
  dd <- datadist(gls_data)
  options(datadist = "dd")
  glsAssump(best_bs_models[[i]], gls_data)
  cat("\n\n")
  cat("#####", "Effects\n\n")
  glsEffects(best_bs_models[[i]], drugs[i], gls_data)
  rm(dd)
  cat("\n\n")
  options(datadist = NULL)
}

```


### Summary of effects

```{r, gls-anova-summary-tab}
#### gls-anova-summary-tab ####
best_bs_models %>% 
  map(~anova(., tol = 1e-10)) %>% 
  map(~as_tibble(x = ., rownames = "Coef")) %>% 
  map(as.matrix) %>% 
  map(as_tibble) %>% 
  bind_rows(.id= "drug") %>% 
  mutate(across(`Chi-Square`:P, as.numeric)) %>% 
  select(-c(`Chi-Square`, d.f.)) %>% 
  filter(!str_detect(Coef, "Nonlinear") &
           !str_detect(Coef, "TOTAL") &
           !str_detect(Coef,"All Interactions"),
         !str_detect(Coef, c("f" %R% OPEN_PAREN %R% "A,B"))) %>%
  pivot_wider(names_from = drug, values_from = P) %>% 
  mutate(across(ace:warfarin, ~printnum(., zero = FALSE)),
         Coef = str_remove_all(Coef, OPEN_PAREN %R% "Factor" %R% PLUS %R% 
                                 "Higher Order Factors" %R% CLOSE_PAREN)) %>% 
  select(Coef, all_drugs, everything()) %>% 
  kable(booktabs = TRUE, linesep = "",
        caption = paste("Wald test p-values")) %>% 
  kable_styling(latex_options = c("striped", "HOLD_position", "repeat_header")) %>% 
  landscape()
```



### Full tables

```{r, gls-full-model-table, results="asis"}
options(prType="latex")

best_bs_models %>% 
  map(~print(., latex=TRUE))

options(prType="plain")
```






\newpage

## SM References

\begingroup
\setlength{\parindent}{-0.5in}
\setlength{\leftskip}{0.5in}

<div id="refs" custom-style="Bibliography"></div>
\endgroup

\newpage
