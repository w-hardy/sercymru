---
title: "oac inhibitors LPA"
author: "Will A. S. Hardy"
date: "27/01/2021"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
library(tidyverse)
library(tsibble)
library(tidyLPA)
library(future)
library(furrr)
library(tidymodels)
library(workflows)
library(tune)
library(nnet)

knitr::opts_chunk$set(echo = TRUE, cache = TRUE)

set.seed(32)

gp <- 
  read_rds("../OneDrive/2_interimdata/8_linkeddata/gp_agesex_qof_combined.rds") %>% 
  mutate(npat = N,
         N = NULL,
         practice_id = as_factor(practiceid),
         dispensing = as_factor(dispensing),
         hboard = as_factor(str_remove_all(hboard, "W110000"))) %>% 
  ungroup() %>% 
  janitor::clean_names()

differences_files <- 
  list.files("../data/differences/")
names(differences_files) <- 
  str_remove_all(differences_files, "_discreps.rds")

differences <- 
  map_dfr(.x = differences_files,
          .f = ~read_rds(paste0("../data/differences/", .x)),
          .id = "drug") %>% 
  mutate(drug = as_factor(drug)) %>% 
  select(drug, regional_unit, datename, discrepancy)

proportions <- 
  map_dfr(.x = differences_files,
          .f = ~read_rds(paste0("../data/differences/", .x)),
          .id = "drug") %>% 
  mutate(drug = as_factor(drug)) %>% 
  select(drug, regional_unit, datename, prop)

drugs <- unique(as.character(differences$drug))

```


## Data cleaning

```{r, data-problem-values, warning=FALSE}
differences %>% 
  pivot_wider(names_from = datename, values_from = discrepancy) %>% 
  psych::describeBy(group = "drug", fast = TRUE)

proportions %>% 
  pivot_wider(names_from = datename, values_from = prop) %>% 
  psych::describeBy(group = "drug", fast = TRUE)
```

* Problem with `oac` data
* Infinite values have been calculated when something has been divided by zero. Is this when the total prescribing of oac has been zero, thus wafarin as a percentage of 0 is Inf?

```{r, data-which-problem}
differences %>% 
  filter(drug == "oac" & 
           (is.na(discrepancy) | is.nan(discrepancy) | is.infinite(discrepancy))) %>% 
  group_by(datename) %>% 
  count()

differences %>% 
  filter(drug == "oac" & 
           (is.na(discrepancy) | is.nan(discrepancy) | is.infinite(discrepancy))) %>% 
  group_by(drug, regional_unit) %>% 
  count()
```

* Missing/inappropriate data in five practices
* Removed these practices from the `oac` data

```{r, data-cleaning}
differences <- 
  differences %>% 
  anti_join(y = differences %>% 
              filter(drug == "oac" & 
                       (is.na(discrepancy) |
                          is.nan(discrepancy) | 
                          is.infinite(discrepancy))) %>% 
              group_by(drug, regional_unit) %>% 
              count(), 
            by = c("drug", "regional_unit"))

differences_wide <- 
  differences %>% 
  pivot_wider(names_from = datename, values_from = discrepancy)
```


## Disease profiles

```{r}
df <- select(filter(gp, year == "2020"), p_fem:flu)
psych::fa.parallel(df)
five_fac <- psych::fa(df, nfactors = 4, rotate = "varimax")
print(five_fac$loadings, cutoff = .2)

dis_pca <- psych::principal(df, nfactors = 3, scores = TRUE)
plot(dis_pca$values)
dis_pca$rotation
dis_pca_scores <- bind_cols(practice_id = filter(gp, year == "2020")$practice_id, dis_pca$scores)

# 2d plot
x <- dis_pca$loadings[,1]
y <- dis_pca$loadings[,2]
z <- dis_pca$loadings[,3]

pca_plot_df <- bind_cols(dis = names(x), x = x, y = y, z = z)

ggplot(aes(x = x, y = y), data = pca_plot_df) +
  geom_text(aes(label = dis))

ggplot(aes(x = x, y = z), data = pca_plot_df) +
  geom_text(aes(label = dis))

# 3d plot
plotly::plot_ly(x=x, y=y, z=z, data = pca_plot_df,
                type="scatter3d", mode="text", text = ~dis)
```


## Latent profile analysis

### difference
#### LPA estimation

```{r, oac-lpa-diff}
tictoc::tic()
oac_diff_lpa <- 
  differences_wide %>% 
  filter(drug == "oac" & `2020 May` > -100) %>% 
  estimate_profiles(df = ., 
                    select_vars = c("2020 Mar", "2020 Apr", "2020 May", 
                                    "2020 Jun", "2020 Jul", "2020 Aug"),
                    n_profiles = 1:8,
                    models = c(1:3))
tictoc::toc()
```

#### LPA model selection

```{r, oac-fits-diff}
oac_diff_lpa_fits <- 
  compare_solutions(oac_diff_lpa, statistics = 
                      c("BIC", "BLRT_p", "Entropy", "prob_min", "n_min"))
oac_diff_lpa_fits

oac_diff_lpa_fits$fits %>% 
  mutate(Model = as.factor(Model),
         Classes = as.factor(Classes)) %>% 
  pivot_longer(names_to = "IC", cols = c(BIC, Entropy, prob_min, n_min)) %>% 
  ggplot(aes(x = Classes, colour = Model, group = Model)) +
  geom_line(aes(y = value)) +
  facet_wrap(~IC, scales = "free")

```

* AIC, BIC, SABIC all suggest model 2 is best fit with 6, 4, 6 classes
* BLRT < 6 classes for model 2
  * AIC and SABIC suggest 5 classes are best when BLRT threshold applied
* Entropy decreases when increasing from 4 to 5 classes
* Selected model 2 with 4 classes.


```{r, oac-diff-prof-vis}
oac_diff_lpa %>%
  plot_profiles(rawdata = FALSE, sd = FALSE)

differences_wide %>% 
  filter(drug == "oac" & `2020 May` > -100) %>% 
  estimate_profiles(df = ., 
                    select_vars = c("2020 Mar", "2020 Apr", "2020 May", 
                                    "2020 Jun", "2020 Jul", "2020 Aug"),
                    n_profiles = c(3:8),
                    models = 2) %>% 
  plot_profiles(rawdata = FALSE, sd = FALSE)
```


```{r, oac-profile-vis-diff}
oac_diff_lpa$model_2_class_4 %>% 
  plot_profiles(rawdata = FALSE, sd = FALSE)

df <- 
  oac_diff_lpa$model_2_class_4 %>% 
  get_data() %>% 
  select(-c(model_number, classes_number, starts_with("CPROB"))) %>% 
  rownames_to_column() %>% 
  pivot_longer(cols = `2020 Mar`:`2020 Aug`, values_to = "difference", 
               names_to = "datename") %>% 
  mutate(Class = as.factor(Class),
         datename = as_factor(datename)) 

df %>% 
  ggplot(aes(x = datename, y = difference, colour = Class)) +
  geom_boxplot() +
  geom_point(alpha = .1, position=position_jitterdodge(dodge.width=0.75))

df %>% 
  ggplot(aes(x = datename, y = difference)) +
  geom_line(aes(colour = as.factor(rowname), group = rowname), alpha = .1) +
  stat_summary(fun = "mean") +
  facet_wrap(~Class) +
  theme(legend.position = "none")

oac_diff_lpa$model_2_class_4 %>% 
  get_data() %>% 
  select(-c(model_number, classes_number, starts_with("CPROB"))) %>% 
  rownames_to_column() %>% 
  mutate(Class = as.factor(Class)) %>% 
  aov(`2020 Mar` ~ Class, data = .) %>% 
  summary()

oac_diff_lpa$model_2_class_4 %>% 
  get_data() %>% 
  select(-c(model_number, classes_number, starts_with("CPROB"))) %>% 
  rownames_to_column() %>% 
  mutate(Class = as.factor(Class)) %>% 
  aov(`2020 Mar` ~ Class, data = .) %>% 
  TukeyHSD()
```

* Class 1 - Reduced switching
* Class 2 - Reduced switching Mar then normal switching
* Class 3 - Increased switching Apr & May
* Class 4 - Greatly increased switching Apr & May


#### Multinomial logistic regression

```{r, oac-multinom-data}
oac_multinom_data <- 
  oac_diff_lpa$model_2_class_4 %>% 
  get_data() %>% 
  inner_join(filter(gp, year == 2020), by = c("regional_unit" = "practiceid")) %>% 
  select(-c(model_number, classes_number, starts_with("2020 "), starts_with("CPROB"))) %>% 
  mutate(gp_load = npat/ngp) %>% 
  select(Class, p_fem, af, wimd2019, dispensing, ngp, gp_load, hboard) %>%
  mutate(Class = as.factor(Class),
         hboard = as.factor(hboard))

oac_multinom_data %>% 
  DataExplorer::plot_correlation()
```


##### Class 1 ref

```{r, oac_multinom_data-ref1}
# Class 1 as ref class
oac_multinom_data$Class <- relevel(oac_multinom_data$Class, ref = "1")
oac_diff_m1 <- 
  oac_multinom_data %>% 
  multinom(Class ~ ., family = "binomial", data = .) 

summary(oac_diff_m1)
print("relative risk"); exp(coef(oac_diff_m1))

oac_diff_m1_z <- summary(oac_diff_m1)$coefficients/summary(oac_diff_m1)$standard.errors

# Two-tailed z-test
print("Wald test p-value")
oac_diff_m1_p <- (1 - pnorm(abs(oac_diff_m1_z), 0, 1)) * 2
oac_diff_m1_p

oac_multinom_data %>% 
  group_by(Class) %>% 
  summarise(dispensing = mean(if_else(dispensing == "Yes", 1, 0)),
            wimd = median(wimd2019),
           # pm_65 = median(pm_65),
            n = n())
```


```{r}
coef(oac_diff_m1) %>% 
  as_tibble(rownames = "Class") %>% 
  pivot_longer(cols = `(Intercept)`:gp_load, values_to = "coefficient",
               names_to = "variable") %>% 
  left_join(summary(oac_diff_m1)$standard.errors %>% 
  as_tibble(rownames = "Class") %>% 
  pivot_longer(cols = `(Intercept)`:gp_load, values_to = "se",
               names_to = "variable")) %>% 
  mutate(Class = as.factor(Class)) %>% 
  ggplot(aes(x = coefficient, y = variable, group = Class, colour = Class)) +
  geom_point(position = position_dodge(width = .5)) +
  geom_errorbarh(aes(xmin = coefficient - 2 * se, xmax = coefficient + 2 * se),
                 position = position_dodge(width = .5))

oac_multinom_data %>% 
  # mutate(across(where(is.numeric), scale)) %>% 
  pivot_longer(cols = where(is.numeric), names_to = "variable") %>% 
  ggplot(aes(x = Class, y = value, colour = Class)) +
  geom_boxplot() +
  facet_wrap(~variable, scales = "free")


# sjPlot::plot_model(oac_diff_m1, type = "pred", terms = c("pm_65 [all]", "dispensing"))
sjPlot::plot_model(oac_diff_m1, type = "eff")
```

