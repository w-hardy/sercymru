---
title: "Oral contraceptives"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
---

```{r setup}
## Packages
devtools::install_github("https://github.com/w-hardy/serCymruTools")
library(tidyverse)
library(lubridate)
library(tsibble)
library(rstan) # needed to load prophet
library(prophet)
library(fable)
library(fable.prophet)
library(feasts)
library(furrr)
library(rebus)
library(MplusAutomation)
library(tidyLPA)
library(serCymruTools)

## Options
knitr::opts_chunk$set(cache = TRUE)
options(mc.cores = parallel::detectCores() - 1)
rstan_options(auto_write = TRUE)

## Seed
set.seed(32)

```


```{r}
## Drugs of interest
combined_hormonal <- 
  c("0703010E0", "0703010F0", "0703010G0", "0703010H0", "0703010M0",
    "0703010S0", "0703010R0","0703010A0", "0703010P0")
progestogen_only <- 
  c("0703021Q0", "0703022P0", "0703021C0", "0703021L0", "0703023L0",
    "0703022M0", "0703021N0", "0703022N0", "0703021P0")

oral_contraceptives <- c(combined_hormonal, progestogen_only)


## Read from database
# con <- DBI::dbConnect(RSQLite::SQLite(), "../OneDrive/1_data/gpextract/db-gpextract.sqlite")
# db.gpextract <- tbl(con, "gpextract")
# 
# oc <- db.gpextract %>%
#   filter(bnfchem %in% oral_contraceptives) %>%
#   collect() %>%
#   mutate(datename = dmy(paste0("28-", datename)))  # Add day component to date and convert to date-time object


## Write to local file
# oc %>%
#   saveRDS("../data/oral_contraceptives.rds")

## Read from local file
#gp <- read_rds("../data/gp_linked_na_omit.rds")
gp <- read_rds("../OneDrive/2_interimdata/8_linkeddata/gp_agesex_qof_combined.rds") %>% 
  mutate(npat = N,
         N = NULL) %>% 
  filter(year == 2020) # do something better
oc <- read_rds("../data/oral_contraceptives.rds") 


## Sort into monthly count data
oc_monthly_count <- oc %>% 
  group_by(datename) %>% 
  summarise(n = sum(Quantity)) %>% 
  mutate(datename = yearmonth(datename),
         n = case_when(str_detect(datename, pattern = "Jan") ~ n/31,
                       str_detect(datename, pattern = "Feb") ~ n/28.25,
                       str_detect(datename, pattern = "Mar") ~ n/31,
                       str_detect(datename, pattern = "Apr") ~ n/30,
                       str_detect(datename, pattern = "May") ~ n/31,
                       str_detect(datename, pattern = "Jun") ~ n/30,
                       str_detect(datename, pattern = "Jul") ~ n/31,
                       str_detect(datename, pattern = "Aug") ~ n/31,
                       str_detect(datename, pattern = "Sep") ~ n/30,
                       str_detect(datename, pattern = "Oct") ~ n/31,
                       str_detect(datename, pattern = "Nov") ~ n/30,
                       str_detect(datename, pattern = "Dec") ~ n/31)) %>% 
  ungroup() %>% 
  as_tsibble(index = datename)
colnames(gp)

oc_monthly_quantity_hb <- 
  right_join(oc, select(gp, c(practiceid, hboard)), 
             by = c("PracticeID" = "practiceid")) %>%
  countRegional(hboard, datename, Quantity) %>% 
  left_join(gp %>% 
  select(c(practiceid, npat, hboard)) %>% 
  group_by(hboard) %>% 
  summarise(npat = sum(npat)), by = c("regional_unit" = "hboard")) %>% 
  mutate(n = 1000*n/npat) # quantity per 1000 pts

oc_monthly_quantity_cluster <- 
  right_join(oc, select(gp, c(practiceid, cluster)), 
             by = c("PracticeID" = "practiceid")) %>%
  countRegional(cluster, datename, Quantity) %>% 
  left_join(gp %>% 
  select(c(practiceid, npat, cluster)) %>% 
  group_by(cluster) %>% 
  summarise(npat = sum(npat)), by = c("regional_unit" = "cluster")) %>% 
  mutate(n = 1000*n/npat) # quantity per 1000 pts

oc_monthly_quantity_gp <- 
  countRegional(oc, PracticeID, datename, Quantity) %>% 
  right_join(select(gp, c(practiceid, npat)), 
            by = c("regional_unit" = "practiceid")) %>% 
  mutate(n = 1000*n/npat)
  

## Sort into monthly count data pre-lockdown (2020-03-23)
oc_monthly_count_pre_cv19 <- 
  oc_monthly_count %>% 
  filter(datename < dmy("01-03-2020"))

oc_monthly_quantity_hb_pre_cv19 <- 
  oc_monthly_quantity_hb %>% 
    filter(datename < dmy("01-03-2020"))

oc_monthly_quantity_cluster_pre_cv19 <- 
  oc_monthly_quantity_cluster %>% 
    filter(datename < dmy("01-03-2020"))

oc_monthly_quantity_gp_pre_cv19 <- 
  oc_monthly_quantity_gp %>% 
    filter(datename < dmy("01-03-2020"))

```


## Overview

### 2016-2020 plot of all oc prescriptions 

```{r oc-monthly-ts-plot, fig.cap="Total quantity of combined hormonal and progestogen only oral contraceptives prescribed per month."}
oc %>% 
  group_by(datename) %>% 
  summarise(n = sum(Quantity)) %>% 
  tsibble() %>% 
  autoplot(n) +
  geom_vline(xintercept = dmy("23-March-2020"), colour = "red") # add line to mark the start of lockdown
```

* General negative trend
* Seasonality unclear
  * Holiday effect? Drop in prescribing in Dec 2016-2019 followed by peak in Jan for 2017-2020.

### Seasonality

```{r oc-monthly-seasonality-plot}
df <- oc_monthly_count_pre_cv19 %>% 
  mutate(month = as.factor(month(datename, label = TRUE, abbr = TRUE)),
         year = as.factor(year(datename))) 

df2 <- df %>% 
  as_tibble() %>% 
  filter(year(datename) != 2020) %>% 
  group_by(month) %>% 
  summarise(n = mean(n))

df %>% 
  ggplot(aes(x = month, y = n, colour = year, group = year)) +
  geom_line() +
  geom_line(data = df2, aes(x = month, y = n, group = "Avg"), 
            colour = "red", lty = 2) +
  labs(caption = "Red dashed line is mean for 2016-2019")

```
* 2016 is very different. Is that grounds to remove it?
* Dec/Jan holiday effect
  * How, if at all, does the population of Wales change with students?
* Easter effect? Mar/Apr has a pattern with 2017 as exception (does the opposite)
  * What would be expected? If people are travelling for Easter, then they may get their prescriptions before and after, but not in the weeks around?
  * Range (2000-2020): March 23rd (2008) to April 21st (2019)
  * Dates:
    * 2016-03-27
    * 2017-04-16
    * 2018-04-01
    * 2019-04-21
  
    * 2020-04-12


```{r}
oc_monthly_count_pre_cv19 %>% 
  mutate(datename = yearmonth(datename)) %>% 
  gg_subseries(y = n, period = "year")
```

* 

### By `Quantity`
* Jan high and Dec low

### By `Items`
* Feb is lower, but has fewer days in it
* Dec is lower, holiday effect?
* Jan is higher, people who haven't had prescriptions due to holidays/have been entered late onto the system due to holidays

### Lag plots

```{r}
oc_monthly_count_pre_cv19 %>%
  mutate(datename = yearmonth(datename)) %>% 
  gg_lag(y = n, geom = "point", lags = 1:12)
```

```{r}
oc_monthly_count_pre_cv19 %>% 
  mutate(datename = yearmonth(datename)) %>% 
  gg_lag(y = n, geom = "point", lags = 13:24)
```
* Here the colours indicate the month of the variable on the y-axis. The relationship is strongest at lag 12 and 24 suggesting seasonal data


### Autocorrelation

```{r}
tseries::adf.test(oc_monthly_count$n)
urca::ur.df(oc_monthly_count$n)
```


```{r}
oc_monthly_count_pre_cv19 %>%
  mutate(datename = yearmonth(datename)) %>% 
  ACF(n, lag_max = 60) %>% autoplot()
```

* Autocorrelation greatest at 2 and 12

```{r}
oc_monthly_count_pre_cv19$n %>%
  pacf(lag.max = 60)
```


## Overview of each drug

```{r}
oc %>% 
  group_by(datename, chemname) %>% 
  summarise(n = sum(Quantity)) %>% 
  mutate(n = case_when(str_detect(datename, pattern = "-01-") ~ n/31,
                       str_detect(datename, pattern = "-02-") ~ n/28.25,
                       str_detect(datename, pattern = "-03-") ~ n/31,
                       str_detect(datename, pattern = "-04-") ~ n/30,
                       str_detect(datename, pattern = "-05-") ~ n/31,
                       str_detect(datename, pattern = "-06-") ~ n/30,
                       str_detect(datename, pattern = "-07-") ~ n/31,
                       str_detect(datename, pattern = "-08-") ~ n/31,
                       str_detect(datename, pattern = "-09-") ~ n/30,
                       str_detect(datename, pattern = "-10-") ~ n/31,
                       str_detect(datename, pattern = "-11-") ~ n/30,
                       str_detect(datename, pattern = "-12-") ~ n/31
                             )) %>% 
  as_tsibble(index = datename, key = chemname) %>% 
  autoplot(n) +
  theme(legend.position = "none") +
  geom_vline(xintercept = dmy("23-March-2020"), colour = "red") # add line to mark the start of lockdown
```

## Time series components

```{r}
dcmp <- 
  oc_monthly_count_pre_cv19 %>% 
  mutate(datename = yearmonth(datename)) %>% 
  model(STL(n))

oc_monthly_count_pre_cv19 %>% 
  mutate(datename = yearmonth(datename)) %>% 
  autoplot(n, color = "grey") + 
  autolayer(components(dcmp), trend, color = "red")

components(dcmp) %>% 
  autoplot()
```

```{r}
oc_monthly_count %>% 
  mutate(datename = yearmonth(datename)) %>% 
  autoplot(n, color = "grey") + 
  autolayer(components(dcmp), season_adjust, colour = "blue") +
  labs(title = "Seasonally adjusted")
```


## Predictions by `Locality`

```{r, eval=FALSE}
regions <- unique(as.character(oc_monthly_quantity_locality$regional_unit))
holidays <- 
  bind_rows(tibble(holiday = "christmas",
                   ds = as.Date(c("2016-12-25", "2017-12-25", "2018-12-25",
                                  "2019-12-25", "2020-12-25", "2021-12-25")),
                   lower_window = -1, 
                   upper_window = 1),
            
            tibble(holiday = "easter",
                   ds = as.Date(c("2016-03-27", "2017-04-16", "2018-04-01",
                                  "2019-04-21", "2020-04-12", "2021-04-04")),
                   lower_window = -1, 
                   upper_window = 1))


fit <- oc_monthly_quantity_locality_pre_cv19 %>% 
  # filter(year(datename) > 2016) %>% 
  mutate(datename = yearmonth(datename)) %>% 
  model(#trend_model1 = TSLM(n ~ trend()),#time series linear model
        trend_model2 = TSLM(n ~ trend() + season()),
        #ets1 = ETS(n ~ trend()),
        ets2 = ETS(n ~ trend() + season()),
        arima = ARIMA(n),# stepwise = FALSE, approximation = FALSE),
        #comb1 = combination_model(TSLM(n ~ trend()), ETS(n ~ trend())),
        comb2 = combination_model(TSLM(n ~ trend() + season()), 
                                  ETS(n ~ trend() + season())),
        # stl_dcmp1 = decomposition_model(STL(n ~ trend(),
        #                                    iterations = 1000, robust = FALSE),
        #                                NAIVE(season_adjust)),
        stl_dcmp2 = decomposition_model(STL(n ~ trend() + season(),
                                            iterations = 1000, robust = FALSE),
        SNAIVE(season_adjust)),
        s_naive = SNAIVE(n)
  ) 

fcsts <-  fit %>% 
  forecast(h = "6 months", bootstrap = FALSE) # can use `times = x` to control the number of samples

# single thread
regional_plots <- 
  map(.x = regions, 
      .f = ~regionalPlot(.x, oc_monthly_quantity_locality))

regional_plots

left_join(accuracy(fit),
          fit %>% 
            select(-starts_with(c("stl_dcmp", "comb"))) %>% 
            report(), 
by = c("regional_unit", ".model"))


fit %>% 
  accuracy() %>% 
  group_by(.model) %>% 
  summarise(across(is.numeric, .fns = ~mean(., na.rm = TRUE)))


```

* https://fabletools.tidyverts.org/reference/combination_model.html




### Residual diagnostics

```{r, eval=FALSE}
augment(fit) %>% 
  features(.resid, box_pierce, lag = 24, dof = 0) %>% 
  mutate(sig = if_else(bp_pvalue <.05, TRUE, FALSE))
```


## Predictions by `GPCluster`


```{r, eval=FALSE}
system.time(cluster_fit <- regionalJointFits(oc_monthly_quantity_cluster_pre_cv19))

```


### Residual diagnostics

```{r, eval=FALSE}
augment(cluster_fit) %>% 
  features(.resid, box_pierce, lag = 24, dof = 0) %>% 
  mutate(sig = if_else(bp_pvalue <.05, TRUE, FALSE))
```




## Predictions by `PracticeID`


```{r, eval=FALSE}
gp_fit <- regionalJointFits(oc_monthly_quantity_gp_pre_cv19)


gp_fcsts <-  gp_fit %>% 
  regionalJointFcsts()

```


### Residual diagnostics

```{r, eval=FALSE}
augment(fit) %>% 
  features(.resid, box_pierce, lag = 24, dof = 0) %>% 
  mutate(sig = if_else(bp_pvalue <.05, TRUE, FALSE))
```






## Modelling

### By Health Board

```{r, health-board-modelling}
plan(multisession)
system.time(oc_hb_cv_models <-
  regionalCV(data = oc_monthly_quantity_hb_pre_cv19))
plan(sequential)

# oc_hb_cv_models %>%
#   saveRDS("../data/oc_hb_cv_models.rds")
# 
# oc_hb_cv_models <- 
#   read_rds("../data/oc_hb_cv_models.rds")

oc_hb_cv_models %>% 
  group_by(regional_unit) %>% 
  arrange(RMSE, MAE) %>% 
  slice(1, .preserve = TRUE) %>% 
  ggplot(aes(x = MAPE)) +
  geom_histogram()

oc_hb_cv_models %>% 
  group_by(regional_unit) %>% 
  arrange(RMSE, MAE) %>% 
  slice(1, .preserve = TRUE) %>% 
  group_by(.model) %>% 
  count() %>% 
  arrange(desc(n))

oc_hb_cv_models %>% 
  group_by(regional_unit) %>% 
  ggplot(aes(x = reorder(.model, MAPE, mean), y = MAPE)) + # reorder by mean of y
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90))
```

* 570.350 seconds with multisession prophetModels()
* 278.968 seconds 2021-01-18

```{r}
# plan(multisession)
# system.time(oc_hb_fcsts <- regionalJointFcsts(oc_monthly_quantity_hb_pre_cv19))
# plan(sequential)
# 
# oc_hb_fcsts %>%
#   saveRDS("../data/oc_hb_fcsts.rds")

oc_hb_fcsts <- 
  read_rds("../data/oc_hb_fcsts.rds")
```

* 158.876 seconds 2020-12-08


### By GP Cluster

```{r, gp-cluster-modelling}
plan(multisession)
system.time(oc_gp_cluster_cv_models <-
  regionalCV(data = oc_monthly_quantity_cluster_pre_cv19))
plan(sequential)
# 
# oc_gp_cluster_cv_models %>%
#   saveRDS("../data/oc_gp_cluster_cv_models.rds")

oc_gp_cluster_cv_models <- 
  read_rds("../data/oc_gp_cluster_cv_models.rds")

oc_gp_cluster_cv_models %>% 
  group_by(regional_unit) %>% 
  arrange(RMSE, MAE) %>% 
  slice(1, .preserve = TRUE) %>% 
  ggplot(aes(x = MAPE)) +
  geom_histogram()

oc_gp_cluster_cv_models %>% 
  group_by(regional_unit) %>% 
  arrange(RMSE, MAE) %>% 
  slice(1, .preserve = TRUE) %>% 
  group_by(.model) %>% 
  count() %>% 
  arrange(desc(n))

oc_gp_cluster_cv_models %>% 
  group_by(regional_unit) %>% 
  ggplot(aes(x = reorder(.model, MAPE, mean), y = MAPE)) + # reorder by mean of y
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90))


```

* 4300.706 seconds

```{r}
# plan(multisession)
# system.time(oc_gp_cluster_fcsts <- 
#               regionalJointFcsts(oc_monthly_quantity_cluster_pre_cv19))
# plan(sequential)
# 
# oc_gp_cluster_fcsts %>%
#   saveRDS("../data/oc_gp_cluster_fcsts.rds")

oc_gp_cluster_fcsts <- 
  read_rds("../data/oc_gp_cluster_fcsts.rds")
```

* 1680.611 seconds pre prophet fix 2020-12-08 
* 1456.319 seconds post prophet fix 2020-12-08

### By Practice

```{r, gp-practice-modelling}
incomplete_gp <- oc_monthly_quantity_gp_pre_cv19 %>% 
    as_tibble() %>% 
    group_by(regional_unit) %>% 
    count() %>% 
    filter(n < 50) %>% 
    .$regional_unit %>% 
    unique()

# plan(multisession)
# system.time(oc_gp_cv_models <-
#   oc_monthly_quantity_gp_pre_cv19 %>%
#     filter(!regional_unit %in% incomplete_gp) %>%
#               regionalCV())
# plan(sequential)
# 
# oc_gp_cv_models %>%
#   saveRDS("../data/oc_gp_cv_models.rds")

oc_gp_cv_models <- 
  read_rds("../data/oc_gp_cv_models.rds")

oc_gp_cv_models %>% 
  group_by(regional_unit) %>% 
  arrange(RMSE, MAE) %>% 
  slice(1, .preserve = TRUE) %>% 
  ggplot(aes(x = MAPE)) +
  geom_histogram() +
  coord_cartesian(ylim = c(0,100))

oc_gp_cv_models %>% 
  group_by(regional_unit) %>% 
  arrange(RMSE, MAE) %>% 
  slice(1, .preserve = TRUE) %>% 
  group_by(.model) %>% 
  count() %>% 
  arrange(desc(n))

oc_gp_cv_models %>% 
  group_by(regional_unit) %>% 
  ggplot(aes(x = reorder(.model, MAPE, mean), y = MAPE)) + # reorder by mean of y
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90))

```


* 2.195e+04 seconds 2020-12-07
* 25547.266 seconds 2020-12-09

```{r gp-modelling-accuracy}
best_model_gp <- 
  oc_gp_cv_models %>% 
  group_by(regional_unit) %>% 
  arrange(RMSE, MAE) %>% 
  slice(1, .preserve = TRUE)

best_model_gp %>% 
  left_join(select(gp, practiceid, npat, ngp), 
            by = c("regional_unit" = "practiceid")) %>% 
  select(-c(.model, .type)) %>% 
  DataExplorer::plot_correlation()

```



```{r gp-practice-forecasts}
# plan(multisession)
# system.time(oc_gp_fcsts <-
#               oc_monthly_quantity_gp_pre_cv19 %>%
#               filter(!regional_unit %in% incomplete_gp) %>%
#               regionalJointFcsts())
# plan(sequential)
# 
# oc_gp_fcsts %>%
#   saveRDS("../data/oc_gp_fcsts.rds")

oc_gp_fcsts <- 
  read_rds("../data/oc_gp_fcsts.rds")

oc_gp_fcsts %>% 
  group_by(.model) %>% 
  count

```

* 2941.64 seconds 2021-01-08

## Discrepancies

### By Health Board

```{r, health-board-discrepancies}
best_model_hb <- 
  oc_hb_cv_models %>% 
  group_by(regional_unit) %>% 
  arrange(RMSE, MAE) %>% 
  slice(1, .preserve = TRUE)

best_model_hb %>% 
  select(.model, regional_unit) %>% 
  inner_join(mutate(oc_hb_fcsts,
                    datename = yearmonth(datename)), 
             by = c(".model", "regional_unit")) %>%
  left_join(mutate(select(oc_monthly_quantity_hb, 
                          c(regional_unit, datename, n)), 
                   datename = yearmonth(datename)),
            by = c("datename", "regional_unit")) %>% 
  mutate(discrepancy = n - .mean,
         z_discrepancy = discrepancy/sd) %>% 
  ggplot(aes(y = discrepancy)) +
  geom_line(aes(x = datename, y = discrepancy, colour = as.factor(regional_unit)),
            alpha = .8, lty = 2) +
  geom_hline(aes(yintercept = 0), colour = "red") +
  theme(legend.position = "none") #+
  facet_wrap(~.model)
```

### By GP Cluster

```{r, gp-cluster-discrepancies}
best_model_gp_cluster <- 
  oc_gp_cluster_cv_models %>% 
  group_by(regional_unit) %>% 
  arrange(RMSE, MAE) %>% 
  slice(1, .preserve = TRUE)

best_model_gp_cluster %>% 
  select(.model, regional_unit) %>% 
  inner_join(mutate(oc_gp_cluster_fcsts,
                    datename = yearmonth(datename)), 
             by = c(".model", "regional_unit")) %>%
  left_join(mutate(select(oc_monthly_quantity_cluster, 
                          c(regional_unit, datename, n)), 
                   datename = yearmonth(datename)),
            by = c("datename", "regional_unit")) %>% 
  mutate(discrepancy = n - .mean,
         z_discrepancy = discrepancy/sd) %>% 
  ggplot(aes(y = discrepancy)) +
  # geom_boxplot(aes(x = as.factor(datename))) +
  geom_line(aes(x = datename, y = discrepancy, colour = as.factor(regional_unit)),
            alpha = .8, lty = 2) +
  # scale_color_gradientn(colours = rainbow(100))+
  geom_hline(aes(yintercept = 0), colour = "red") +
  theme(legend.position = "none")
```

```{r, eval = FALSE}
best_model_gp_cluster %>% 
  select(.model, regional_unit) %>% 
  inner_join(mutate(oc_gp_cluster_fcsts,
                    datename = yearmonth(datename)), 
             by = c(".model", "regional_unit")) %>%
  left_join(mutate(select(oc_monthly_quantity_cluster, 
                          c(regional_unit, datename, n)), 
                   datename = yearmonth(datename)),
            by = c("datename", "regional_unit")) %>% 
  mutate(discrepancy = n - .mean,
         z_discrepancy = discrepancy/sd)  %>%
  select(discrepancy, regional_unit, datename) %>%
  pivot_wider(names_from = datename, values_from = discrepancy) %>% 
  ungroup() %>% 
  select(-regional_unit) %>% 
  estimate_profiles(1:6, models = c(1:3, 6)) %>% 
  compare_solutions(statistics = c("AIC", "BIC"))
```


### By GP Practice

```{r, gp-practice-discrepancies}
best_model_gp <- 
  oc_gp_cv_models %>% 
  group_by(regional_unit) %>% 
  arrange(RMSE, MAE) %>% 
  slice(1, .preserve = TRUE)

best_model_gp %>% 
  ggplot(aes(x = MAPE)) + 
  geom_histogram()

best_model_gp %>% 
  group_by(if_else(MAPE < 50, TRUE, FALSE)) %>% 
  count()

median(best_model_gp$MAPE)

acc_filter_value <- 50
  
best_model_gp_discrep <- 
  best_model_gp %>% 
  filter(MAPE <= acc_filter_value) %>% 
  select(.model, regional_unit) %>% 
  inner_join(mutate(oc_gp_fcsts,
                    datename = yearmonth(datename)), 
             by = c(".model", "regional_unit")) %>%
  left_join(mutate(select(oc_monthly_quantity_gp, 
                          c(regional_unit, datename, n)), 
                   datename = yearmonth(datename)),
            by = c("datename", "regional_unit")) %>% 
  mutate(discrepancy = n - .mean,
         z_discrepancy = discrepancy/sd) 

best_model_gp_discrep %>% 
  ggplot(aes(y = discrepancy)) +
  geom_line(aes(x = datename, y = discrepancy, 
                colour = as.factor(regional_unit)),
            alpha = .8, lty = 2) +
  geom_hline(aes(yintercept = 0), colour = "red") +
  theme(legend.position = "none")

```

```{r}
best_model_gp_discrep %>% 
  filter(discrepancy < -40)

oc_monthly_quantity_gp %>% 
  filter(regional_unit %in% c("W97009", "W98053")) %>% 
  as_tsibble(key = regional_unit, index = datename) %>% 
  autoplot()

gp %>% 
  filter(practiceid %in% c("W97009", "W98053"))
```

* Based on postcodes, these are both University GPs. Or at least, given their procimity to universities, they will likely have large student populations.

#### Latent profile analysis

```{r gp-lpa}
gp_lpa_fit <- 
  best_model_gp_discrep  %>%
  select(discrepancy, regional_unit, datename) %>%
  pivot_wider(names_from = datename, values_from = discrepancy) %>% 
  ungroup() %>% 
  select(-regional_unit) %>% 
  estimate_profiles(1:6, models = c(1:3, 6))

gp_lpa_fit %>% 
  compare_solutions(statistics = c("AIC", "BIC"))

gp_lpa_fit %>% 
  compare_solutions(statistics = c("AIC", "BIC")) %>% 
  .[[1]] %>% 
  ggplot(aes(x = Classes, y = BIC, group = Model, colour = as.factor(Model))) +
  geom_line()

gp_lpa_fit %>%
  plot_profiles(x = ., rawdata = FALSE)


```

#### mplus 

```{r, mplus-data-prep}
best_model_gp_discrep %>% 
  mutate(regional_unit = as.factor(regional_unit)) %>% 
  select(regional_unit, datename, discrepancy) %>% 
  filter(!is.na(discrepancy)) %>% # need to remove NA before pivoting to enable values_fill
  pivot_wider(names_from = datename, values_from = discrepancy, values_fill = -999) %>% 
  left_join(select(gp, c(practiceid, cluster)), by = c("regional_unit" = "practiceid")) %>% 
  mutate(regional_unit = as.factor(regional_unit),
         cluster = as.factor(cluster)) %>% 
  mutate(regional_unit = as.numeric(regional_unit),
         cluster = as.numeric(cluster)) %>% 
  select(cluster, regional_unit, everything()) %>% 
  write_csv(file = "../data/mplus/oc_gp_discrep.csv", col_names = FALSE)

```



```{r, mplus-anlayses}
source("../r_scripts/functions/mplus_plotting.R")
# mplus_models <- MplusAutomation::readModels("../mplus_analyses/oc_gp")

mplus_model_summaries <- 
  readModels("../mplus_analyses/oc_gp", what = "summaries", quiet = TRUE)

best_mplus_model_summary <- 
  mplus_model_summaries %>% 
  flatten() %>% 
  map(2) %>% 
  bind_rows() %>% 
  filter(Estimator == "MLR" & AnalysisType == "mixture") %>% 
  arrange(BIC) %>% 
  slice(1)

best_mplus_model <- 
  readModels(paste0("../mplus_analyses/oc_gp/", best_mplus_model_summary$Filename))

oc_discrep_5_class_ml <- 
  readModels("../mplus_analyses/oc_gp/oc_discrep_5_class_ml.out")

best_mplus_model$class_counts

# mplus.view.plots("../mplus_analyses/oc_gp/oc_discrep_5_class_ml.gh5")
mplus.plot.estimated_means("../mplus_analyses/oc_gp/oc_discrep_5_class_ml.gh5")
```
#### kmeans

```{r, gp-kmeans}
gp_kmeans_data <- 
  best_model_gp_discrep %>%  
  mutate(regional_unit = as.factor(regional_unit)) %>% 
  select(regional_unit, datename, discrepancy) %>% 
  filter(!is.na(discrepancy)) %>% # need to remove NA before pivoting to enable values_fill
  pivot_wider(names_from = datename, values_from = discrepancy) %>% 
  as_tibble() %>% 
  na.omit()

1:6 %>% 
  map_dfr(~as.data.frame(kmeans(x = gp_kmeans_data[2:6], centers = .x, nstart = 25)$cluster), 
          .id = "n_clusters") %>% 
  mutate(regional_unit = rep(gp_kmeans_data$regional_unit, 6)) %>% 
  pivot_wider(names_from = "n_clusters", id_cols = regional_unit,
              values_from = "kmeans(x = gp_kmeans_data[2:6], centers = .x, nstart = 25)$cluster")

1:6 %>% 
  map_dfr(~as.data.frame(kmeans(x = gp_kmeans_data[2:6],
                                centers = .x, nstart = 25)$centers), 
          .id = "n_clusters") %>% 
  rownames_to_column(var = "cluster") %>% 
  mutate(cluster = 
           str_remove_all(cluster, 
                          pattern = DOT %R% DOT %R% DOT %R% 
                            one_or_more(DIGIT))) %>% 
  pivot_longer(cols = starts_with("2020 "), names_to = "datename") %>% 
  ggplot(aes(x = yearmonth(datename), y = value, colour = as.factor(cluster))) + 
  geom_line() +
  facet_wrap(~n_clusters)
  

```
#### Comparing methods

```{r}
mplus_assignment <- 
  read_table("../mplus_analyses/oc_gp/oc_discrep_5_class_ml_cprob.txt", col_names = FALSE, na = "*") %>% 
  na.omit() %>% 
  .$X17

kmeans_assignment <- 
  kmeans(x = gp_kmeans_data[2:6], centers = 5, nstart = 25)$cluster

lpa_assignment <- 
  gp_lpa_fit$model_1_class_5$model$classification

df <- bind_cols(mplus_assignment, kmeans_assignment, lpa_assignment)

df %>% 
  ggplot(aes(x = mplus_assignment, y = kmeans_assignment, 
             colour = as.factor(mplus_assignment)))+
  geom_jitter(aes(shape = as.factor(kmeans_assignment)), alpha = .5)

df %>% 
  ggplot(aes(x = mplus_assignment, y = lpa_assignment, 
             colour = as.factor(kmeans_assignment))) +
  geom_jitter(alpha = .5)
```

