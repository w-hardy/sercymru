---
title: "Oral contraceptives"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
---

```{r setup}
## Packages
library(tidyverse)
library(lubridate)
library(tsibble)
library(rstan) # needed to load prophet
library(prophet)
library(fable)
library(fable.prophet)
library(feasts)
library(furrr)

## Options
knitr::opts_chunk$set(cache = TRUE)
options(mc.cores = parallel::detectCores() - 1)
rstan_options(auto_write = TRUE)

## Seed
set.seed(32)

## Functions
countRegional <- function(data, region, datename = datename, unit = Quantity){
 # Function to create tsibble object for a count of `unit` per `datename`
  # e.g. countRegional(oac, Locality, datename, Quantity) is the `Quantity`
  # per `datename` grouped by `Locality` from `oac`. `Quantity` is corrected for
  # the number of days in each month.
  region <- enquo(region)
  datename <- enquo(datename)
  unit <- enquo(unit)
  
  data %>% 
  mutate(regional_unit = as_factor(set_names(!!region))) %>% 
  group_by(regional_unit, !!datename) %>% 
  summarise(n = sum(!!unit),
            npat = sum(npat)) %>% 
  mutate(n = case_when(str_detect(!!datename, pattern = "-01-") ~ n/31,
                       str_detect(!!datename, pattern = "-02-") ~ n/28.25,
                       str_detect(!!datename, pattern = "-03-") ~ n/31,
                       str_detect(!!datename, pattern = "-04-") ~ n/30,
                       str_detect(!!datename, pattern = "-05-") ~ n/31,
                       str_detect(!!datename, pattern = "-06-") ~ n/30,
                       str_detect(!!datename, pattern = "-07-") ~ n/31,
                       str_detect(!!datename, pattern = "-08-") ~ n/31,
                       str_detect(!!datename, pattern = "-09-") ~ n/30,
                       str_detect(!!datename, pattern = "-10-") ~ n/31,
                       str_detect(!!datename, pattern = "-11-") ~ n/30,
                       str_detect(!!datename, pattern = "-12-") ~ n/31)) %>% 
  ungroup() %>% 
  as_tsibble(index = !!datename, key = regional_unit)
}

regionalPlot <- function(region, data){
  
  ## Prophet forecast - can this be taken outside of the function?
      ## no, when it is taken outside of the model, the forecast is becomes 
      ## much worse 2020-11-14
  df <- data %>%
    filter(regional_unit == region & datename < ymd("2020-03-23")) %>%
    transmute(ds = datename, y = n)

  m <- prophet::prophet(df, holidays = holidays,
                        seasonality.mode = "additive",# mcmc.samples = 1000,
                        weekly.seasonality = FALSE, daily.seasonality = FALSE)
  future <- make_future_dataframe(m, periods = 5, freq = 'month')
  fcst <- predict(m, future)

  ## Plotting
  plot <- fcsts %>% 
    filter(regional_unit == region) %>% 
    fabletools::autoplot(data, level = 80) + # fable forecasts over observed data
    geom_line(aes(y = c(rep(NA,50), fcst[51:55,]$yhat)), # prophet prediction
              col = "blue", lty = 3) +
    geom_ribbon(aes(ymin = c(rep(NA,50), fcst[51:55,]$yhat_lower), # prophet confidence
                    ymax = c(rep(NA,50), fcst[51:55,]$yhat_upper)),
                alpha = .3, fill = "blue") +
  geom_vline(xintercept = dmy("23-March-2020"), colour = "red") + # add line to mark the start of lockdown
    labs(title = region)
  
  ## Results
  result <- list("plots" = plot)#, "prophet" = fcst)
  return(result)
}
```

## Preparing data

```{r prep-data}
## Drugs of interest
oral_anticoagulants <- 
  c("0208020H0", "0208020Z0", "0208020X0", "0208020AA", "0208020W0", 
    "020802000", "0208020I0", "0208020N0", "0208020S0", "0208020Y0", 
    "0208020V0")


# ## Read from database
# con <- DBI::dbConnect(RSQLite::SQLite(), 
#                       "../OneDrive/1_data/gpextract/db-gpextract.sqlite")
# db.gpextract <- tbl(con, "gpextract")
# oac <- db.gpextract %>%
#   filter(bnfchem %in% oral_anticoagulants) %>%
#   collect() %>%
#   mutate(datename = dmy(paste0("28-", datename)))  # Add day component to date and convert to date-time object
# DBI::dbDisconnect(con)
# 
# ## Write to local file
# oac %>%
#   write_rds("../data/oral_anticoagulants.rds")

## Read from local file
gp <- read_rds("../data/gp_linked_na_omit.rds")
oac <- read_rds("../data/oral_anticoagulants.rds") 

## Sort into monthly count data
oac_monthly_count <- oac %>% 
  group_by(datename) %>% 
  summarise(n = sum(Quantity)) %>% 
  mutate(datename = yearmonth(datename),
         n = case_when(str_detect(datename, pattern = "Jan") ~ n/31,
                       str_detect(datename, pattern = "Feb") ~ n/28.25,
                       str_detect(datename, pattern = "Mar") ~ n/31,
                       str_detect(datename, pattern = "Apr") ~ n/30,
                       str_detect(datename, pattern = "May") ~ n/31,
                       str_detect(datename, pattern = "Jun") ~ n/30,
                       str_detect(datename, pattern = "Jul") ~ n/31,
                       str_detect(datename, pattern = "Aug") ~ n/31,
                       str_detect(datename, pattern = "Sep") ~ n/30,
                       str_detect(datename, pattern = "Oct") ~ n/31,
                       str_detect(datename, pattern = "Nov") ~ n/30,
                       str_detect(datename, pattern = "Dec") ~ n/31
                             )) %>% 
  ungroup() %>% 
  as_tsibble(index = datename)

oac_monthly_quantity_locality <- 
  right_join(oac, select(gp, c(PracticeID, npat, GPCluster)), 
             by = c("PracticeID" = "PracticeID")) %>%
  countRegional(., Locality, datename, Quantity)

oac_monthly_quantity_cluster <- 
  right_join(oac, select(gp, c(PracticeID, npat, GPCluster)), 
             by = c("PracticeID" = "PracticeID")) %>%
  countRegional(., GPCluster, datename, Quantity) %>% 
  mutate(n = 1000*n/npat) # quantity per 1000 pts

oac_monthly_quantity_gp <- 
    right_join(oac, select(gp, c(PracticeID, npat, GPCluster)), 
             by = c("PracticeID" = "PracticeID")) %>% 
  countRegional(., PracticeID, datename, Quantity)%>% 
  mutate(n = 1000*n/npat)
  

## Sort into monthly count data pre-lockdown (2020-03-23)
oac_monthly_count_pre_cv19 <- 
  oac_monthly_count %>% 
  filter(datename < dmy("01-03-2020"))

oac_monthly_quantity_locality_pre_cv19 <- 
  oac_monthly_quantity_locality %>% 
    filter(datename < dmy("01-03-2020"))

oac_monthly_quantity_cluster_pre_cv19 <- 
  oac_monthly_quantity_cluster %>% 
    filter(datename < dmy("01-03-2020"))

oac_monthly_quantity_gp_pre_cv19 <- 
  oac_monthly_quantity_gp %>% 
    filter(datename < dmy("01-03-2020"))

```


## Overview

### 2016-2020 plot of all oac prescriptions 

```{r oac-monthly-ts-plot, fig.cap="Total quantity of combined hormonal and progestogen only oral contraceptives prescribed per month."}
oac %>% 
  group_by(datename) %>% 
  summarise(n = sum(Quantity)) %>% 
  tsibble() %>% 
  autoplot(n) +
  geom_vline(xintercept = dmy("23-March-2020"), colour = "red") # add line to mark the start of lockdown
```

* General negative trend
* Seasonality unclear
  * Holiday effect? Drop in prescribing in Dec 2016-2019 followed by peak in Jan for 2017-2020.

### Seasonality

```{r oac-monthly-seasonality-plot}
df <- oac_monthly_count_pre_cv19 %>% 
  mutate(month = as.factor(month(datename, label = TRUE, abbr = TRUE)),
         year = as.factor(year(datename))) 

df2 <- df %>% 
  as_tibble() %>% 
  filter(year(datename) != 2020) %>% 
  group_by(month) %>% 
  summarise(n = mean(n))

df %>% 
  ggplot(aes(x = month, y = n, colour = year, group = year)) +
  geom_line() +
  geom_line(data = df2, aes(x = month, y = n, group = "Avg"), 
            colour = "red", lty = 2) +
  labs(caption = "Red dashed line is mean for 2016-2019")

```
* 


```{r}
oac_monthly_count_pre_cv19 %>% 
  mutate(datename = yearmonth(datename)) %>% 
  gg_subseries(y = n, period = "year")
```

* 

### By `Quantity`

* 

### By `Items`

* 

### Lag plots

```{r}
oac_monthly_count_pre_cv19 %>%
  mutate(datename = yearmonth(datename)) %>% 
  gg_lag(y = n, geom = "point", lags = 1:12)
```

* Here the colours indicate the month of the variable on the y-axis. The relationship is strongest at lag 3, 6, 9, and 12 suggesting seasonal data


### Autocorrelation

```{r}
tseries::adf.test(oac_monthly_count$n)
urca::ur.df(oac_monthly_count$n)
```


```{r}
oac_monthly_count_pre_cv19 %>%
  mutate(datename = yearmonth(datename)) %>% 
  ACF(n, lag_max = 24) %>% autoplot()
```

* Autocorrelation greatest at 2 and 12

```{r}
oac_monthly_count_pre_cv19$n %>%
  pacf(lag.max = 24)
```


## Time series components

```{r}
dcmp <- 
  oac_monthly_count_pre_cv19 %>% 
  mutate(datename = yearmonth(datename)) %>% 
  model(STL(n))

oac_monthly_count_pre_cv19 %>% 
  mutate(datename = yearmonth(datename)) %>% 
  autoplot(n, color = "grey") + 
  autolayer(components(dcmp), trend, color = "red")

components(dcmp) %>% 
  autoplot()
```

```{r}
oac_monthly_count %>% 
  mutate(datename = yearmonth(datename)) %>% 
  autoplot(n, color = "grey") + 
  autolayer(components(dcmp), season_adjust, colour = "blue") +
  labs(title = "Seasonally adjusted")
```

## Moving average

```{r}
df <- oac_monthly_count %>% 
  mutate(datename = yearmonth(datename),
         `5-MA` = slider::slide_dbl(n, mean, .before = 2, .after = 2, 
                                    .complete = TRUE),
         `12-MA` = slider::slide_dbl(n, mean, .before = 5, .after = 6, 
                                    .complete = TRUE),
         `2x12-MA` = slider::slide_dbl(`12-MA`, mean, .before = 2, .after = 2, 
                                    .complete = TRUE),
         )
df %>% 
  autoplot(n) + 
  autolayer(df, `5-MA`, colour = "red") +
  autolayer(df, `2x12-MA`, colour = "blue") +
  labs(caption = "Daily prescriptions (black) along with the 5-MA estimate of the trend-cycle (red) and 2x12-MA (blue).")
```


## Predictions by `Locality`

```{r}
regions <- unique(as.character(oac_monthly_quantity_locality$regional_unit))
holidays <- 
  bind_rows(tibble(holiday = "christmas",
                   ds = as.Date(c("2016-12-25", "2017-12-25", "2018-12-25",
                                  "2019-12-25", "2020-12-25", "2021-12-25")),
                   lower_window = -1, 
                   upper_window = 1),
            
            tibble(holiday = "easter",
                   ds = as.Date(c("2016-03-27", "2017-04-16", "2018-04-01",
                                  "2019-04-21", "2020-04-12", "2021-04-04")),
                   lower_window = -1, 
                   upper_window = 1))


fit <- oac_monthly_quantity_locality_pre_cv19 %>% 
  # filter(year(datename) > 2016) %>% 
  mutate(datename = yearmonth(datename)) %>% 
  model(#trend_model1 = TSLM(n ~ trend()),#time series linear model
        trend_model2 = TSLM(n ~ trend() + season()),
        #ets1 = ETS(n ~ trend()),
        ets2 = ETS(n ~ trend() + season()),
        arima = ARIMA(n),# stepwise = FALSE, approximation = FALSE),
        #comb1 = combination_model(TSLM(n ~ trend()), ETS(n ~ trend())),
        comb2 = combination_model(TSLM(n ~ trend() + season()), 
                                  ETS(n ~ trend() + season())),
        # stl_dcmp1 = decomposition_model(STL(n ~ trend(),
        #                                    iterations = 1000, robust = FALSE),
        #                                NAIVE(season_adjust)),
        stl_dcmp2 = decomposition_model(STL(n ~ trend() + season(),
                                            iterations = 1000, robust = FALSE),
        SNAIVE(season_adjust)),
        s_naive = SNAIVE(n)
  ) 

fcsts <-  fit %>% 
  forecast(h = "6 months", bootstrap = FALSE) # can use `times = x` to control the number of samples

# single thread
regional_plots <- 
  map(.x = regions, 
      .f = ~regionalPlot(.x, oac_monthly_quantity_locality))

regional_plots

left_join(accuracy(fit),
          fit %>% 
            select(-starts_with(c("stl_dcmp", "comb"))) %>% 
            report(), 
by = c("regional_unit", ".model"))


fit %>% 
  accuracy() %>% 
  group_by(.model) %>% 
  summarise(across(is.numeric, .fns = ~mean(., na.rm = TRUE)))


```

* https://fabletools.tidyverts.org/reference/combination_model.html




### Residual diagnostics

```{r}
augment(fit) %>% 
  features(.resid, box_pierce, lag = 24, dof = 0) %>% 
  mutate(sig = if_else(bp_pvalue <.05, TRUE, FALSE))
```


## Predictions by `GPCluster`


```{r}
regions <- unique(as.character(gp$GPCluster))
holidays <- 
  bind_rows(tibble(holiday = "christmas",
                   ds = as.Date(c("2016-12-25", "2017-12-25", "2018-12-25",
                                  "2019-12-25", "2020-12-25", "2021-12-25")),
                   lower_window = -1, 
                   upper_window = 1),
            
            tibble(holiday = "easter",
                   ds = as.Date(c("2016-03-27", "2017-04-16", "2018-04-01",
                                  "2019-04-21", "2020-04-12", "2021-04-04")),
                   lower_window = -1, 
                   upper_window = 1))

fit <- oac_monthly_quantity_cluster_pre_cv19 %>% 
    filter(regional_unit %in% gp$GPCluster) %>% 
  mutate(datename = yearmonth(datename)) %>% 
  model(#trend_model1 = TSLM(n ~ trend()),#time series linear model
        trend_model2 = TSLM(n ~ trend() + season()),
        ets2 = ETS(n ~ trend() + season()),
        arima = ARIMA(n),# stepwise = FALSE, approximation = FALSE),

        comb2 = combination_model(TSLM(n ~ trend() + season()), 
                                  ETS(n ~ trend() + season())),
        stl_dcmp2 = decomposition_model(STL(n ~ trend() + season(),
                                            iterations = 1000, robust = FALSE),
        SNAIVE(season_adjust)),
        # s_naive = SNAIVE(n)
  ) 

fcsts <-  fit %>% 
  forecast(h = "5 months", bootstrap = FALSE) # can use `times = x` to control the number of samples

# single thread
regional_plots <- 
  map(.x = regions, 
      .f = ~regionalPlot(.x, filter(oac_monthly_quantity_cluster, 
                                    regional_unit %in% oac_monthly_quantity_cluster$regional_unit)))

regional_plots

left_join(accuracy(fit),
          fit %>% 
            select(-starts_with(c("stl_dcmp", "comb"))) %>% 
            report(), 
by = c("regional_unit", ".model"))


fit %>% 
  accuracy() %>% 
  group_by(.model) %>% 
  summarise(across(where(is.numeric), .fns = ~mean(., na.rm = TRUE)))

```


### Residual diagnostics

```{r}
augment(fit) %>% 
  features(.resid, box_pierce, lag = 24, dof = 0) %>% 
  mutate(sig = if_else(bp_pvalue <.05, TRUE, FALSE))
```




## Predictions by `PracticeID`


```{r}
regions <- unique(as.character(gp$PracticeID))
holidays <- 
  bind_rows(tibble(holiday = "christmas",
                   ds = as.Date(c("2016-12-25", "2017-12-25", "2018-12-25",
                                  "2019-12-25", "2020-12-25", "2021-12-25")),
                   lower_window = -1, 
                   upper_window = 1),
            
            tibble(holiday = "easter",
                   ds = as.Date(c("2016-03-27", "2017-04-16", "2018-04-01",
                                  "2019-04-21", "2020-04-12", "2021-04-04")),
                   lower_window = -1, 
                   upper_window = 1))

fit <- oac_monthly_quantity_gp_pre_cv19 %>% 
    filter(regional_unit %in% gp$PracticeID) %>% 
  mutate(datename = yearmonth(datename)) %>% 
  model(#trend_model1 = TSLM(n ~ trend()),#time series linear model
        trend_model2 = TSLM(n ~ trend() + season()),
        ets2 = ETS(n ~ trend() + season()),
        arima = ARIMA(n),# stepwise = FALSE, approximation = FALSE),

        comb2 = combination_model(TSLM(n ~ trend() + season()), 
                                  ETS(n ~ trend() + season())),
        stl_dcmp2 = decomposition_model(STL(n ~ trend() + season(),
                                            iterations = 1000, robust = FALSE),
        SNAIVE(season_adjust)),
        # s_naive = SNAIVE(n)
  ) 

fcsts <-  fit %>% 
  forecast(h = "5 months", bootstrap = FALSE) # can use `times = x` to control the number of samples

# single thread
regional_plots <- 
  map(.x = regions, 
      .f = ~regionalPlot(.x, filter(oac_monthly_quantity_gp, 
                                    regional_unit %in% gp$PracticeID)))

regional_plots

left_join(accuracy(fit),
          fit %>% 
            select(-starts_with(c("stl_dcmp", "comb"))) %>% 
            report(), 
by = c("regional_unit", ".model"))


fit %>% 
  accuracy() %>% 
  group_by(.model) %>% 
  summarise(across(where(is.numeric), .fns = ~mean(., na.rm = TRUE)))



```


### Residual diagnostics

```{r}
augment(fit) %>% 
  features(.resid, box_pierce, lag = 24, dof = 0) %>% 
  mutate(sig = if_else(bp_pvalue <.05, TRUE, FALSE))
```



## Overview of each drug

```{r}
oac %>% 
  group_by(datename, chemname) %>% 
  summarise(n = sum(Quantity)) %>% 
  mutate(n = case_when(str_detect(datename, pattern = "-01-") ~ n/31,
                       str_detect(datename, pattern = "-02-") ~ n/28.25,
                       str_detect(datename, pattern = "-03-") ~ n/31,
                       str_detect(datename, pattern = "-04-") ~ n/30,
                       str_detect(datename, pattern = "-05-") ~ n/31,
                       str_detect(datename, pattern = "-06-") ~ n/30,
                       str_detect(datename, pattern = "-07-") ~ n/31,
                       str_detect(datename, pattern = "-08-") ~ n/31,
                       str_detect(datename, pattern = "-09-") ~ n/30,
                       str_detect(datename, pattern = "-10-") ~ n/31,
                       str_detect(datename, pattern = "-11-") ~ n/30,
                       str_detect(datename, pattern = "-12-") ~ n/31
                             )) %>% 
  as_tsibble(index = datename, key = chemname) %>% 
  autoplot(n) +
  # theme(legend.position = "none") +
  geom_vline(xintercept = dmy("23-March-2020"), colour = "red") # add line to mark the start of lockdown
```


## Modelling

### Prophet

```{r}
# Prophet model
oac_prophet_model <- 
  fable.prophet::prophet(n ~ growth("linear", n_changepoints = 0) +
                           season("year", type = "additive") + holiday(holidays))

fit <- oac_monthly_quantity_locality_pre_cv19 %>% 
  as_tsibble(index = datename) %>% 
  model(oac_prophet_model)

fc <- 
  fit %>% 
  forecast(h = "5 months")

accuracy(fit)

df <- oac_monthly_count_pre_cv19 %>% 
  transmute(ds = datename, y = n)
m <- prophet::prophet(df, seasonality.mode = "additive")
future <- make_future_dataframe(m, periods = 6, freq = 'month')
fcst <- predict(m, future)
prophet_plot_components(m, fcst)

oac_monthly_count %>% 
  ggplot(aes(x = datename, y = n)) +
  geom_line() +
  geom_ribbon(aes(ymin = c(rep(NA,50), fcst[51:55,]$yhat_lower),
                  ymax = c(rep(NA,50), fcst[51:55,]$yhat_upper)),
              alpha = .1, fill = "blue") +
  geom_line(aes(y = c(fcst[1:50,]$yhat, rep(NA, 5))),
            col = "blue", lty = 2) +
  geom_line(aes(y = c(rep(NA,50), fcst[51:55,]$yhat)),
            col = "blue", lty = 3) +
  geom_vline(xintercept = dmy("23-March-2020"), colour = "red") # add line to mark the start of lockdown

perf <- cross_validation(model = m, initial = 3*52, horizon = 52, units = "weeks")
performance_metrics(perf)
plot_cross_validation_metric(perf, metric = "rmse")
```



## Split by practice


```{r}
oac %>% 
  tibble %>% 
  group_by(datename, PracticeID) %>% 
  count %>% 
  group_by(PracticeID) %>% 
  summarise(n_min = min(n), 
            n_mean = mean(n)) %>% arrange((n_min)) %>% 
  filter(n_min >1)


oac %>% filter(PracticeID == "W91626") %>% 
  group_by(datename) %>% 
  count() %>% 
  as_tsibble(index = datename) %>% 
  autoplot()

```

