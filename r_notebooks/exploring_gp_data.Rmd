---
title: "GP data"
output: html_notebook
---

```{r setup}
library(tidyverse)
library(lubridate)
library(janitor)

#### Functions ####

read_interim <- function(path){ # Read processed files in
  if (str_detect(path, ".rds")) {
    read_rds(paste0("../OneDrive/2_interimdata/", path))
  } else
    if  (str_detect(path, ".csv")) {
      read_csv(paste0("../OneDrive/2_interimdata/", path))
    } else
      stop("File is not .rds or .csv")
}

interim_explore <- function(x){ # Summary of data
  glimpse(x)
  DataExplorer::plot_missing(x)
  DataExplorer::plot_bar(x)
  DataExplorer::plot_histogram(x)
  janitor::get_dupes(x)
}

```


## Reading data in

```{r}
gp_analysis <- read_interim("2_gpanalysis/gpanalysis1.rds")
wimd <- read_interim("3_wimd/lsoa_wimd_2019.csv")
agesex <- read_interim("5_agesexdata/gp_agesexdata_combined.rds")
qof <- read_interim("6_qof/gp_qof_dregs_combined.rds")
phwo <- read_interim("7_phwodata/gp_phwo_summary_2015.csv")

```

## agesex

```{r}
glimpse(agesex)
DataExplorer::plot_missing(agesex)
```
* npat could be used to replace missing data in `gp_analysis`
* Age by sex data is stored as the number of patients in an age range

## gp_analysis

```{r}
interim_explore(gp_analysis)
```
* Missing some northing and eastings but not postcodes - fixable either with additional data or manual search
* Missing number of GPs - fixable using manual search?
* Missing `nprespats` - Replace using agesex data?

```{r}
df <- left_join(filter(gp_analysis, year == 2020), agesex, by = "PracticeID")
cor.test((df$nprespats + df$ndisppats), df$npat)
plot((df$nprespats + df$ndisppats), df$npat)
plot(lm((df$nprespats + df$ndisppats) ~ df$npat))
```
* Why is the correlation not higher? There appear to be some major discrepancies in the two numbers.
  * Which year is the `agesex` data from?
  * Is r = `r round(cor((df$nprespats + df$ndisppats), df$npat, use = "complete.obs"), 2)` high enough to replace missing data?
  * Which data is more reliable?
  * r is higher by ~ .04 when `nprespats + ndisppats)` which is probs high enough
  * Would the `agedata` data be better to use as it relates to the distribution of pts by age and sex? Or once that is made into percentages would the rounding errors be greater than the difference in data quality?
  
```{r}
agesex %>% 
  mutate(female_sum = if_else(npat_fem == nf_0_4 + nf_5_14 + nf_15_44 + nf_45_64 + nf_65_74 + nf_75_84 + nf_85, TRUE, FALSE),
         male_sum = if_else(npat_male == nm_0_4 + nm_5_14 + nm_15_44 + nm_45_64 + nm_65_74 + nm_75_84 + nm_85, TRUE, FALSE)) %>% 
  filter(female_sum == FALSE | male_sum == FALSE)

agesex %>% 
  filter(PracticeID == "W00100")
```



* What is `hlthau`?
* Why are there `r nrow(gp_analysis)` cases when there are far fewer in the other data files?
  * There are multiple years of data (2013-2020)
  * `r nrow(filter(gp_analysis, year == 2020))` Practices in 2020


## phwo

```{r}
interim_explore(phwo)
```



## qof

```{r}
glimpse(qof)
DataExplorer::plot_histogram(qof)
DataExplorer::plot_correlation(qof)
```

## wimd

```{r}
interim_explore(wimd)
```
## Linked data

```{r}
gp_linked <- 
  gp_analysis %>% 
  filter(year == 2020) %>% 
  full_join(agesex, by = "PracticeID") %>% 
  full_join(phwo, by = "PracticeID") %>% 
  full_join(qof, by = "PracticeID") #%>% 
  #left_join(wimd, by = "lsoacode") already included in the data

Amelia::missmap(gp_linked)

```

### GPCluster

* `GPClyster` is in three datasets:
  * `agesex`
  * `phwo`
  * `qof`

```{r}
clus_disagree <- gp_linked %>% 
  select(PracticeID, starts_with("GPC")) %>% 
  mutate(miss = is.na(GPCluster.x) + is.na(GPCluster.y) + is.na(GPCluster),
         agree = if_else((GPCluster.x == GPCluster.y & 
                             GPCluster.x == GPCluster &
                             GPCluster.y == GPCluster), TRUE, FALSE)) %>% 
  filter(agree != TRUE)

clus_miss <- gp_linked %>% 
  select(PracticeID, starts_with("GPC")) %>% 
  mutate(miss = is.na(GPCluster.x) + is.na(GPCluster.y) + is.na(GPCluster),
         agree = if_else((GPCluster.x == GPCluster.y & 
                             GPCluster.x == GPCluster &
                             GPCluster.y == GPCluster), TRUE, FALSE)) %>% 
  filter(miss == 3)

str_detect(gp_linked$GPCluster, "Mold, Buckley & Caergwle") %>% sum(na.rm = T)
str_detect(gp_linked$GPCluster, "South Flintshire") %>% sum(na.rm = T)
str_detect(gp_linked$GPCluster.y, "Mold, Buckley & Caergwle") %>% sum(na.rm = T)
str_detect(gp_linked$GPCluster.y, "South Flintshire") %>% sum(na.rm = T)

gp_linked %>% 
  filter(GPCluster.y == "Mold, Buckley & Caergwle") %>% 
  select(starts_with("GPC"))
```


* `r nrow(clus_disagree)` Practices have different cluster names across the data files
  * Some of these look like different names for the same thing
    * "North & West Wrexham" & "West & North Wrexham"
    * "South Flintshire" & "Mold, Buckley & Caergwle"
* `r nrow(clus_miss)` Practices have no cluster name


## Write rds

```{r}
gp_linked %>% 
  na.omit() %>% 
  write_rds("../data/gp_linked_na_omit.rds")
```

