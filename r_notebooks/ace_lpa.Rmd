---
title: "Ace inhibitors LPA"
author: "Will A. S. Hardy"
date: "27/01/2021"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
library(tidyverse)
library(tsibble)
library(tidyLPA)
library(future)
library(furrr)
library(tidymodels)
library(workflows)
library(tune)
library(nnet)

knitr::opts_chunk$set(echo = TRUE, cache = TRUE)

set.seed(32)

gp <- 
  read_rds("../OneDrive/2_interimdata/8_linkeddata/gp_agesex_qof_combined.rds") %>% 
  mutate(npat = N,
         N = NULL,
         practice_id = as_factor(practiceid),
         dispensing = as_factor(dispensing),
         hboard = as_factor(str_remove_all(hboard, "W110000"))) %>% 
  ungroup() %>% 
  janitor::clean_names()

differences_files <- 
  list.files("../data/differences/")
names(differences_files) <- 
  str_remove_all(differences_files, "_discreps.rds")

differences <- 
  map_dfr(.x = differences_files,
          .f = ~read_rds(paste0("../data/differences/", .x)),
          .id = "drug") %>% 
  mutate(drug = as_factor(drug)) %>% 
  select(drug, regional_unit, datename, discrepancy)

proportions <- 
  map_dfr(.x = differences_files,
          .f = ~read_rds(paste0("../data/differences/", .x)),
          .id = "drug") %>% 
  mutate(drug = as_factor(drug)) %>% 
  select(drug, regional_unit, datename, prop)

drugs <- unique(as.character(differences$drug))

```


## Data cleaning

```{r, data-problem-values, warning=FALSE}
differences %>% 
  pivot_wider(names_from = datename, values_from = discrepancy) %>% 
  psych::describeBy(group = "drug", fast = TRUE)

proportions %>% 
  pivot_wider(names_from = datename, values_from = prop) %>% 
  psych::describeBy(group = "drug", fast = TRUE)
```

* Problem with `oac` data
* Infinite values have been calculated when something has been divided by zero. Is this when the total prescribing of oac has been zero, thus wafarin as a percentage of 0 is Inf?

```{r, data-which-problem}
differences %>% 
  filter(drug == "oac" & 
           (is.na(discrepancy) | is.nan(discrepancy) | is.infinite(discrepancy))) %>% 
  group_by(datename) %>% 
  count()

differences %>% 
  filter(drug == "oac" & 
           (is.na(discrepancy) | is.nan(discrepancy) | is.infinite(discrepancy))) %>% 
  group_by(drug, regional_unit) %>% 
  count()
```

* Missing/inappropriate data in five practices
* Removed these practices from the `oac` data

```{r, data-cleaning}
differences <- 
  differences %>% 
  anti_join(y = differences %>% 
              filter(drug == "oac" & 
                       (is.na(discrepancy) |
                          is.nan(discrepancy) | 
                          is.infinite(discrepancy))) %>% 
              group_by(drug, regional_unit) %>% 
              count(), 
            by = c("drug", "regional_unit"))

differences_wide <- 
  differences %>% 
  pivot_wider(names_from = datename, values_from = discrepancy)

proportions_wide <- 
  proportions %>% 
  pivot_wider(names_from = datename, values_from = prop)
```


## Disease profiles

```{r}
df <- select(filter(gp, year == "2020"), chd:flu) %>% 
  slice_sample(prop = .5)
psych::fa.parallel(df)
five_fac <- psych::fa(df, nfactors = 3, rotate = "varimax")
print(five_fac$loadings, cutoff = .2)

dis_pca <- psych::principal(df, nfactors = 3, scores = TRUE)
plot(dis_pca$values)
dis_pca$rotation
dis_pca_scores <- bind_cols(practice_id = filter(gp, year == "2020")$practice_id, dis_pca$scores)

# 2d plot
x <- dis_pca$loadings[,1]
y <- dis_pca$loadings[,2]
z <- dis_pca$loadings[,3]

pca_plot_df <- bind_cols(dis = names(x), x = x, y = y, z = z)

ggplot(aes(x = x, y = y), data = pca_plot_df) +
  geom_text(aes(label = dis))

ggplot(aes(x = x, y = z), data = pca_plot_df) +
  geom_text(aes(label = dis))

# 3d plot
plotly::plot_ly(x=x, y=y, z=z, data = pca_plot_df,
                type="scatter3d", mode="text", text = ~dis)
```


## Latent profile analysis

### difference
#### LPA estimation

```{r, ace-lpa-diff}
tictoc::tic()
ace_diff_lpa <- 
  differences_wide %>% 
  filter(drug == "ace" & `2020 May` > -100) %>% 
  estimate_profiles(df = ., 
                    select_vars = c("2020 Mar", "2020 Apr", "2020 May", 
                                    "2020 Jun", "2020 Jul", "2020 Aug"),
                    n_profiles = 1:8,
                    models = c(1:3))
tictoc::toc()
```

#### LPA model selection

```{r, ace-fits-diff}
ace_diff_lpa_fits <- 
  compare_solutions(ace_diff_lpa, statistics = 
                      c("BIC", "BLRT_p", "Entropy", "prob_min", "n_min"))
ace_diff_lpa_fits

ace_diff_lpa_fits$fits %>% 
  mutate(Model = as.factor(Model),
         Classes = as.factor(Classes)) %>% 
  pivot_longer(names_to = "IC", cols = c(BIC, Entropy, prob_min, n_min)) %>% 
  ggplot(aes(x = Classes, colour = Model, group = Model)) +
  geom_line(aes(y = value)) +
  facet_wrap(~IC, scales = "free")

```

* AIC, BIC, SABIC all suggest model 2 is best fit with 6, 4, 6 classes
* BLRT < 6 classes for model 2
  * AIC and SABIC suggest 5 classes are best when BLRT threshold applied
* Entropy decreases when increasing from 4 to 5 classes
* Selected model 2 with 4 classes.


```{r, ace-diff-prof-vis}
ace_diff_lpa %>%
  plot_profiles(rawdata = FALSE, sd = FALSE)

differences_wide %>% 
  filter(drug == "ace" & `2020 May` > -100) %>% 
  estimate_profiles(df = ., 
                    select_vars = c("2020 Mar", "2020 Apr", "2020 May", 
                                    "2020 Jun", "2020 Jul", "2020 Aug"),
                    n_profiles = c(3:8),
                    models = 2) %>% 
  plot_profiles(rawdata = FALSE, sd = FALSE)
```


```{r, ace-profile-vis-diff}
ace_diff_lpa$model_2_class_4 %>% 
  plot_profiles(rawdata = FALSE, sd = FALSE)

df <- 
  ace_diff_lpa$model_2_class_4 %>% 
  get_data() %>% 
  select(-c(model_number, classes_number, starts_with("CPROB"))) %>% 
  rownames_to_column() %>% 
  pivot_longer(cols = `2020 Mar`:`2020 Aug`, values_to = "difference", 
               names_to = "datename") %>% 
  mutate(Class = as.factor(Class),
         datename = as_factor(datename)) 

df %>% 
  ggplot(aes(x = datename, y = difference, colour = Class)) +
  geom_boxplot() +
  geom_point(alpha = .1, position=position_jitterdodge(dodge.width=0.75))

df %>% 
  ggplot(aes(x = datename, y = difference)) +
  geom_line(aes(colour = as.factor(rowname), group = rowname), alpha = .1) +
  stat_summary(fun = "mean") +
  facet_wrap(~Class) +
  theme(legend.position = "none")

ace_diff_lpa$model_2_class_4 %>% 
  get_data() %>% 
  select(-c(model_number, classes_number, starts_with("CPROB"))) %>% 
  rownames_to_column() %>% 
  mutate(Class = as.factor(Class)) %>% 
  aov(`2020 Mar` ~ Class, data = .) %>% 
  summary()

ace_diff_lpa$model_2_class_4 %>% 
  get_data() %>% 
  select(-c(model_number, classes_number, starts_with("CPROB"))) %>% 
  rownames_to_column() %>% 
  mutate(Class = as.factor(Class)) %>% 
  aov(`2020 Mar` ~ Class, data = .) %>% 
  TukeyHSD()
```

* Class 1 - 
* Class 2 - 
* Class 3 - 
* Class 4 - 

#### Multinomial logistic regression

```{r, ace-multinom-diff-data}
ace_multinom_data <- 
  ace_diff_lpa$model_2_class_4 %>% 
  get_data() %>% 
  inner_join(filter(gp, year == 2020), by = c("regional_unit" = "practiceid")) %>% 
  select(-c(model_number, classes_number, starts_with("2020 "), starts_with("CPROB"))) %>% 
  mutate(gp_load = npat/ngp) %>% 
  select(Class, pm_65, p_fem, wimd2019, dispensing, ngp, gp_load, hboard) %>%
  mutate(Class = as.factor(Class),
         hboard = as.factor(hboard))

ace_multinom_data %>% 
  DataExplorer::plot_correlation()
```


##### Class 1 ref

```{r, ace-multinom-diff-ref1}
# Class 1 as ref class
ace_multinom_data$Class <- relevel(ace_multinom_data$Class, ref = "1")
ace_m1 <- 
  ace_multinom_data %>% 
  multinom(Class ~ ., family = "binomial", data = .) 

summary(ace_m1)
print("relative risk"); exp(coef(ace_m1))

ace_m1_z <- summary(ace_m1)$coefficients/summary(ace_m1)$standard.errors
#ace_m1_z

# Two-tailed z-test
print("Wald test p-value")
ace_m1_p <- (1 - pnorm(abs(ace_m1_z), 0, 1)) * 2
ace_m1_p
```


##### Class 2 ref

```{r, ace-multinom-diff-ref2}
# Class 2 as ref class
ace_multinom_data$Class <- relevel(ace_multinom_data$Class, ref = "2")
ace_m2 <- 
  ace_multinom_data %>% 
  multinom(Class ~ ., family = "binomial", data = .) 

summary(ace_m2)
print("relative risk"); exp(coef(ace_m2))

ace_m2_z <- summary(ace_m2)$coefficients/summary(ace_m2)$standard.errors
# ace_m2_z

# Two-tailed z-test
print("Wald test p-value")
ace_m2_p <- (1 - pnorm(abs(ace_m2_z), 0, 1)) * 2
ace_m2_p
```


##### Class 3 ref

```{r, ace-multinom-diff-ref3}
# Class 3 as ref class
ace_multinom_data$Class <- relevel(ace_multinom_data$Class, ref = "3")
ace_m3 <- 
  ace_multinom_data %>% 
  multinom(Class ~ ., family = "binomial", data = .) 

summary(ace_m3)
print("relative risk"); exp(coef(ace_m3))

ace_m3_z <- summary(ace_m3)$coefficients/summary(ace_m3)$standard.errors
# ace_m3_z

# Two-tailed z-test
print("Wald test p-value")
ace_m3_p <- (1 - pnorm(abs(ace_m3_z), 0, 1)) * 2
ace_m3_p
```



```{r}
ace_multinom_data %>% 
  group_by(Class) %>% 
  summarise(dispensing = sum(if_else(as.character(dispensing) == "Yes", 1, 0))/n())
```


### proportion
#### LPA estimation

```{r, ace-prop-month-hist}
proportions %>% 
  filter(drug == "ace") %>% 
  ggplot(aes(x = prop)) + 
  geom_histogram() +
  facet_wrap(~as.factor(datename))
```


```{r, ace-lpa-prop}
tictoc::tic()
ace_prop_lpa <- 
  proportions_wide %>% 
  filter(drug == "ace") %>%
  estimate_profiles(df = ., 
                    select_vars = c("2020 Mar", "2020 Apr", "2020 May", 
                                    "2020 Jun", "2020 Jul", "2020 Aug"),
                    n_profiles = 1:8,
                    models = c(1:3))
tictoc::toc()
```

#### LPA model selection

```{r, ace-fits-prop}
ace_prop_lpa_fits <- 
  compare_solutions(ace_prop_lpa, 
                    c("BIC", "BLRT_p", "Entropy", "prob_min", "n_min"))

ace_prop_lpa_fits

ace_prop_lpa_fits$fits %>% 
  mutate(Model = as.factor(Model),
         Classes = as.factor(Classes)) %>% 
  pivot_longer(names_to = "IC", cols = c(BIC, Entropy, prob_min, n_min)) %>% 
  ggplot(aes(x = Classes, colour = Model, group = Model)) +
  geom_line(aes(y = value)) +
  facet_wrap(~IC, scales = "free")

```

* Selected model 2 with 6 classes.
  * BLRT suggests fewer than 5 classes
  * AIC suggests 7 classes
  * BIC favours 4 classes, but only small increase in BIC from 4 to 6 classes
  * SABIC suggests 6 classes
  * Entropy slightly between for 6 than 4 classes, but much worse than 2 classes


```{r, ace-prop-profile-plots}
ace_prop_lpa %>%
  plot_profiles(rawdata = FALSE, sd = FALSE)

differences_wide %>% 
  filter(drug == "ace" & `2020 Jul` > -50) %>% 
  estimate_profiles(df = ., 
                    select_vars = c("2020 Mar", "2020 Apr", "2020 May", 
                                    "2020 Jun", "2020 Jul", "2020 Aug"),
                    n_profiles = c(3:8),
                    models = 2) %>% 
  plot_profiles(rawdata = FALSE, sd = FALSE)
```


```{r, ace-profile-vis-prop}
ace_prop_lpa$model_2_class_6 %>% 
  plot_profiles(rawdata = FALSE, sd = FALSE)

df <- 
  ace_prop_lpa$model_2_class_6 %>% 
  get_data() %>% 
  select(-c(model_number, classes_number, starts_with("CPROB"))) %>% 
  rownames_to_column() %>% 
  pivot_longer(cols = `2020 Mar`:`2020 Aug`, values_to = "proportion", 
               names_to = "datename") %>% 
  mutate(Class = as.factor(Class),
         datename = as_factor(datename)) 

df %>% 
  ggplot(aes(x = datename, y = proportion, colour = Class)) +
  geom_boxplot() +
  geom_point(alpha = .1, position=position_jitterdodge(dodge.width=0.75)) +
  geom_hline(yintercept = 1, colour = "red", lty =2)

df %>% 
  ggplot(aes(x = datename, y = proportion)) +
  geom_line(aes(colour = as.factor(rowname), group = rowname), alpha = .2) +
  stat_summary(fun = "mean", size = .1) +
  facet_wrap(~Class) +
  theme(legend.position = "none") +
  coord_cartesian(ylim = c(.75, 1.25)) +
  geom_hline(yintercept = 1, colour = "red", lty =2)

ace_prop_lpa$model_2_class_6 %>% 
  get_data() %>% 
  group_by(Class) %>% 
  count()
```

```{r, ace-prop-mean-vis}
ace_prop_lpa$model_2_class_6 %>% 
  get_data() %>% 
  group_by(Class) %>% 
  summarise(across(`2020 Mar`:`2020 Aug`, median)) %>% 
  pivot_longer(cols = `2020 Mar`:`2020 Aug`, 
               names_to = "datename", values_to = "proportion") %>% 
  mutate(datename = yearmonth(datename),
         Class = as.factor(Class)) %>% 
  ggplot(aes(x = datename, y = proportion, colour = Class)) +
  geom_line() +
  geom_hline(yintercept = 1, colour = "red", lty =2)
```


```{r, ace-prop-aov}
df <- 
  ace_prop_lpa$model_2_class_6 %>% 
  get_data() %>% 
  select(-c(model_number, classes_number, starts_with("CPROB"), 
            drug)) %>% 
  mutate(Class = as.factor(Class)) %>% 
  pivot_longer(cols = `2020 Mar`:`2020 Aug`, names_to = "datename")


df %>% 
  split(.$datename) %>% 
  map(~aov(value ~ Class, data = .)) %>% 
  map_dfr(broom::tidy, .id = "month") %>% 
  mutate(month = yearmonth(month)) %>% 
  arrange(month, term)

df %>% 
  split(.$datename) %>% 
  map(~aov(value ~ Class, data = .)) %>% 
  map(TukeyHSD) %>% 
  map_dfr(broom::tidy, .id = "month") %>% 
  mutate(month = yearmonth(month)) %>% 
  select(-c(null.value, term)) %>% 
  arrange(month) %>% 
  mutate(adj.p.value = papaja::printnum(adj.p.value, zero = FALSE))
```


* Class 1
  * n = 58
  * High in Mar, slight depression for Apr & May, as forecast in Jun & Jul, low levels in Aug. Moderate variability throughout.
  * Stockpiling followed by reduced prescribing for two months before returning to "normal" for two months
* Class 2
  * n = 26
  * Very high in Mar, decreased prescribing in Apr, then extremely variable prescribing for the remaining months.
  * Very high levels of stockpiling followed by chaotic prescribing.
* Class 3
  * n = 125
  * Elevated levels of prescribing in Mar, as forecast in Apr, slight reduction in May, as forecast in Jun & Jul, then reduced prescribing in Aug. Very low levels of variability.
  * Business as usual with limited stockpiling
* Class 4
  * n = 85
  * High levels of prescribing in Mar & Apr, as forecast May, slight elevation in Jun & Jul, slight depression in Aug but still higher than others. Low levels of variability.
* Class 5
  * n = 72
  * High in Mar, as forecast in Apr, low levels in May, as forecast in Jun & Jul, low levels in Aug. Low levels of variability.
* Class 6
  * n = 36
  * High in Mar, extremely variable in Apr with prescribing as forecast, variable levels just below forecast, reduced variability and low levels of prescribing in Jun, as forecast in Jul, and low levels in Aug.


#### Multinomial logistic regression

```{r, ace-multinom-prop-data}
ace_multinom_prop_data <-
  ace_prop_lpa$model_2_class_6 %>%
  get_data() %>%
  inner_join(filter(gp, year == 2020), by = c("regional_unit" = "practiceid")) %>%
  select(-c(model_number, classes_number, starts_with("2020 "), starts_with("CPROB"))) %>%
  mutate(gp_load = npat/ngp) %>%
  select(Class, hyp, p_fem, wimd2019, dispensing, ngp, gp_load) %>%
  mutate(Class = as.factor(Class),
        #hboard = as.factor(hboard)
        )

ace_multinom_prop_data %>% 
  DataExplorer::plot_correlation()

car::vif(lm(as.numeric(Class) ~ ., data = ace_multinom_prop_data))

```


##### Class 1 ref

```{r, ace-multinom-prop-ref1}
# Class 1 as ref class
ace_multinom_prop_data$Class <- relevel(ace_multinom_prop_data$Class, ref = "1")
ace_prop_m1 <- 
  ace_multinom_prop_data %>% 
  multinom(Class ~ ., family = "binomial", data = .) 

summary(ace_prop_m1)
print("relative risk"); exp(coef(ace_prop_m1))

ace_prop_m1_z <- summary(ace_prop_m1)$coefficients/summary(ace_prop_m1)$standard.errors
#ace_m1_z

# Two-tailed z-test
print("Wald test p-value")
ace_prop_m1_p <- (1 - pnorm(abs(ace_prop_m1_z), 0, 1)) * 2
ace_prop_m1_p

ace_multinom_prop_data %>% 
  group_by(Class) %>% 
  summarise(dispensing = mean(if_else(dispensing == "Yes", 1, 0)),
            wimd = median(wimd2019),
            hyp = median(hyp))
```


```{r}
coef(ace_prop_m1) %>% 
  as_tibble(rownames = "Class") %>% 
  pivot_longer(cols = `(Intercept)`:gp_load, values_to = "coefficient",
               names_to = "variable") %>% 
  left_join(summary(ace_prop_m1)$standard.errors %>% 
  as_tibble(rownames = "Class") %>% 
  pivot_longer(cols = `(Intercept)`:gp_load, values_to = "se",
               names_to = "variable")) %>% 
  mutate(Class = as.factor(Class)) %>% 
  ggplot(aes(x = coefficient, y = variable, group = Class, colour = Class)) +
  geom_point(position = position_dodge(width = .5)) +
  geom_errorbarh(aes(xmin = coefficient - 2 * se, xmax = coefficient + 2 * se),
                 position = position_dodge(width = .5))

ace_multinom_prop_data %>% 
  # mutate(across(where(is.numeric), scale)) %>% 
  pivot_longer(cols = where(is.numeric), names_to = "variable") %>% 
  ggplot(aes(x = Class, y = value, colour = Class)) +
  geom_boxplot() +
  facet_wrap(~variable, scales = "free")


# sjPlot::plot_model(ace_prop_m1, type = "pred", terms = c("pm_65 [all]", "dispensing"))
sjPlot::plot_model(ace_prop_m1, type = "eff")
```


##### Class 2 ref

```{r, ace-multinom-prop-ref2}
# Class 2 as ref class
ace_multinom_prop_data$Class <- relevel(ace_multinom_prop_data$Class, ref = "2")
ace_prop_m2 <- 
  ace_multinom_prop_data %>% 
  multinom(Class ~ ., family = "binomial", data = .) 

summary(ace_prop_m2)
print("relative risk"); exp(coef(ace_prop_m2))

ace_prop_m2_z <- summary(ace_prop_m2)$coefficients/summary(ace_prop_m2)$standard.errors

# Two-tailed z-test
print("Wald test p-value")
ace_prop_m2_p <- (1 - pnorm(abs(ace_prop_m2_z), 0, 1)) * 2
ace_prop_m2_p
```


##### Class 3 ref

```{r, ace-multinom-prop-ref3}
# Class 3 as ref class
ace_multinom_prop_data$Class <- relevel(ace_multinom_prop_data$Class, ref = "3")
ace_prop_m3 <- 
  ace_multinom_prop_data %>% 
  multinom(Class ~ ., family = "binomial", data = .) 

summary(ace_prop_m3)
print("relative risk"); exp(coef(ace_prop_m3))

ace_prop_m3_z <- summary(ace_prop_m3)$coefficients/summary(ace_prop_m3)$standard.errors

# Two-tailed z-test
print("Wald test p-value")
ace_prop_m3_p <- (1 - pnorm(abs(ace_prop_m3_z), 0, 1)) * 2
ace_prop_m3_p
```


##### Class 4 ref

```{r, ace-multinom-prop-ref4}
# Class 2 as ref class
ace_multinom_prop_data$Class <- relevel(ace_multinom_prop_data$Class, ref = "4")
ace_prop_m4 <- 
  ace_multinom_prop_data %>% 
  multinom(Class ~ ., family = "binomial", data = .) 

summary(ace_prop_m4)
print("relative risk"); exp(coef(ace_prop_m4))

ace_prop_m4_z <- summary(ace_prop_m4)$coefficients/summary(ace_prop_m4)$standard.errors

# Two-tailed z-test
print("Wald test p-value")
ace_prop_m4_p <- (1 - pnorm(abs(ace_prop_m4_z), 0, 1)) * 2
ace_prop_m4_p
```


##### Class 5 ref

```{r, ace-multinom-prop-ref5}
# Class 2 as ref class
ace_multinom_prop_data$Class <- relevel(ace_multinom_prop_data$Class, ref = "5")
ace_prop_m5 <- 
  ace_multinom_prop_data %>% 
  multinom(Class ~ ., family = "binomial", data = .) 

summary(ace_prop_m5)
print("relative risk"); exp(coef(ace_prop_m5))

ace_prop_m5_z <- summary(ace_prop_m5)$coefficients/summary(ace_prop_m5)$standard.errors

# Two-tailed z-test
print("Wald test p-value")
ace_prop_m5_p <- (1 - pnorm(abs(ace_prop_m5_z), 0, 1)) * 2
ace_prop_m5_p
```

