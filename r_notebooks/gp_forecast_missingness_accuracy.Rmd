---
title: "GP forecast missingness and accuracy"
author: "Will A. S. Hardy"
date: "25/01/2021"
output: 
  html_document:
    code_folding: hide
---

```{r setup, include=FALSE}
library(tidyverse)
library(data.table)

gp <- 
  read_rds("../OneDrive/2_interimdata/8_linkeddata/gp_agesex_qof_combined.rds") %>% 
  mutate(npat = N,
         N = NULL,
         practice_id = as_factor(practiceid)) %>% 
  ungroup() %>% 
  janitor::clean_names() %>% 
  select(practice_id, year, npat)

original_files <- list.files("../data/presdata_updates_040121") %>% 
  grep("presc_wales_", x = ., value = TRUE)

names(original_files) <- 
  str_remove_all(original_files, "presc_wales_") %>% 
  str_remove_all(".rds")

drug_totals <- 
  original_files %>% 
  map_dfr(.x = ., 
          .f = ~read_rds(paste0("../data/presdata_updates_040121/", 
                                       .x)),
          .id = "drug") %>% 
  janitor::clean_names() %>% 
  group_by(drug) %>% 
  summarise(total = sum(quantity)) %>% 
  mutate(drug_code = tolower(str_sub(drug, 1, 3)))

```


Read in all gp_cv_model accuracies

```{r}
accuracy_files <-   
  list.files("../data") %>% 
  grep("gp_cv_models.rds", x = ., value = TRUE)

names(accuracy_files) <- str_remove_all(accuracy_files, "_gp_cv_models.rds")

cv_accuracy <- 
  accuracy_files %>% 
  map_dfr(.x = ., .f = ~read_rds(paste0("../data/", .x)), .id = "drug")
```


## Accuracy

### Overall accuracies

All models for all GPs

```{r}
cv_accuracy %>% 
  ggplot(aes(x = MAPE)) +
  geom_histogram(binwidth = 5) +
  coord_cartesian(xlim = c(0,100)) +
  facet_wrap(~drug)

cv_accuracy %>% 
  ggplot(aes(x = .model, y = MAPE)) +
  geom_boxplot() +
  coord_cartesian(ylim = c(0, 100)) 
```

### Best model accuracies

Accuracy of best model for each GP

```{r}
best_models <- 
  cv_accuracy %>% 
  group_by(drug, regional_unit) %>% 
  arrange(RMSE, MAE) %>% 
  slice(1, .preserve = TRUE)

best_models %>% 
    ggplot(aes(x = MAPE)) +
  geom_histogram(binwidth = 5) +
  coord_cartesian(xlim = c(0,100)) +
  facet_wrap(~drug)
```

* Models for ace, cortico, nsaid, paracet, and vitd are all *v. good*
* Models for adreno, azithro, contra, hcq, and oc are *okay*
* Models for nicot are *poor*


```{r}
df <- best_models %>% 
  group_by(drug) %>% 
  summarise(m_mape = mean(MAPE)) %>% 
  fuzzyjoin::regex_left_join(x = .,
                             y = drug_totals, 
                             by = c("drug" = "drug_code"))

df %>% 
  ggplot(aes(x = total, y = m_mape)) +
  geom_point(aes(colour = as.factor(drug.x))) 

cor.test(x = df$total, y = df$m_mape, method = "spearman")

```



## Missingness

Missingness based on cross validated models

```{r}
best_models %>% 
  select(regional_unit, drug) %>% 
  mutate(missing = FALSE) %>% 
  pivot_wider(names_from = drug, values_from = missing, values_fill = TRUE) %>% 
  pivot_longer(cols = ace:vitd, names_to = "drug", values_to = "missing") %>% 
  ggplot(aes(drug, regional_unit, fill = missing)) +
  geom_tile()
```


```{r}
best_models %>%
  select(drug, regional_unit) %>% 
  ungroup() %>% 
  left_join(gp, by = c("regional_unit" = "practice_id")) %>% 
  group_by(drug) %>% 
  summarise(pct_pat = 100*sum(npat)/sum(gp$npat), .groups = "drop_last")
```

* Missing > 40% of patients for nicotene
