---
title: "Oral anticoagulants"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
---

```{r setup}
## Packages
devtools::install_github("https://github.com/w-hardy/serCymruTools")
library(tidyverse)
library(lubridate)
library(tsibble)
library(rstan) # needed to load prophet
library(prophet)
library(fable)
library(fable.prophet)
library(feasts)
library(furrr)
library(progressr)
library(beepr)
library(serCymruTools)

## Options
knitr::opts_chunk$set(cache = TRUE)
options(mc.cores = parallel::detectCores() - 1)
rstan_options(auto_write = TRUE)

# handlers(global = TRUE)
# handlers(
#   list(
#     handler_progress(
#       format = ":spin :current/:total (:message) [:bar] :percent in :elapsed ETA: :eta",
#       width = 60,
#       complete = "+"),
#     handler_beepr(finish   = "wilhelm",
#                   interval = 2.0)
#   )
# )

## Seed
set.seed(32)


## Function
# Transforming data to be bound beweent a lower and upper limit http://www.maths.bristol.ac.uk/R/web/packages/fable/vignettes/transformations.html
scaled_logit <- function(x, lower=0, upper=1){
  log((x-lower)/(upper-x))}
inv_scaled_logit <- function(x, lower=0, upper=1){
  (upper-lower)*exp(x)/(1+exp(x)) + lower}
my_scaled_logit <- fabletools::new_transformation(scaled_logit, inv_scaled_logit)

propRegional <- function(data, region, datename = datename, unit = Quantity, 
                         bnf){
  # Function to create tsibble object for a proportion of a drug by a given `unit` 
  # per `datename`
  # e.g. propRegional(oc, Locality, datename, Quantity) is the `Quantity`
  # per `datename` grouped by `Locality` from `oc`. `Quantity` is corrected for
  # the number of days in each month.
  region <- enquo(region)
  datename <- enquo(datename)
  unit <- enquo(unit)
  
  data %>%
    mutate(regional_unit = as_factor(set_names(!!region))) %>%
    group_by(!!datename, bnfchem, regional_unit) %>% 
    summarise(n = sum(!!unit)) %>% 
    mutate(n = 100 * n / sum(n),
           log_n = log(n)) %>% 
    filter(bnfchem == bnf) %>%
    ungroup() %>%
    as_tsibble(index = !!datename, key = regional_unit)
}

# Modifying functions to model my_scaled_logit(n, 0, 100) as using proportion data
fableModelsBound <- function(data){
  if(!is_tsibble(data)){data <- as_tsibble(data, index = datename)}
  
  data %>%
    mutate(datename = yearmonth(datename)) %>%
    model(trend_model1 = TSLM(my_scaled_logit(n, 0, 100) ~ 
                                trend()),#time series linear model
          trend_model2 = TSLM(my_scaled_logit(n, 0, 100) ~ 
                                trend() + season("year")),
          ets1 = ETS(my_scaled_logit(n, 0, 100) ~ trend()),
          ets2 = ETS(my_scaled_logit(n, 0, 100) ~ trend() + season("A")),
          ets3 = ETS(my_scaled_logit(n, 0, 100) ~ trend() + season("M"), 
                     restrict = FALSE),
          arima = ARIMA(my_scaled_logit(n, 0, 100), 
                        stepwise = FALSE, 
                        approximation = FALSE),
          comb1 = combination_model(TSLM(my_scaled_logit(n, 0, 100) ~ trend()),
                                    ETS(my_scaled_logit(n, 0, 100) ~ trend())),
          comb2 = combination_model(TSLM(my_scaled_logit(n, 0, 100) ~ 
                                           trend() + season("year")),
                                    ETS(my_scaled_logit(n, 0, 100) ~ 
                                          trend() + season("A"))),
          stl_dcmp1 = decomposition_model(STL(my_scaled_logit(n, 0, 100) ~ 
                                                trend(),
                                              iterations = 1000,
                                              robust = TRUE),
                                          SNAIVE(season_adjust)),
          stl_dcmp2 = decomposition_model(STL(my_scaled_logit(n, 0, 100) ~ 
                                                trend() + season(),
                                              iterations = 1000,
                                              robust = TRUE),
                                          SNAIVE(season_adjust)),
          s_naive = SNAIVE(my_scaled_logit(n, 0, 100)), .safely = TRUE)
}

holidays <-
  bind_rows(tibble(holiday = "christmas",
                   ds = as.Date(c("2016-12-25", "2017-12-25", "2018-12-25",
                                  "2019-12-25", "2020-12-25", "2021-12-25")),
                   lower_window = -1,
                   upper_window = 1),
            
            tibble(holiday = "easter", # Sunday
                   ds = as.Date(c("2016-03-27", "2017-04-16", "2018-04-01",
                                  "2019-04-21", "2020-04-12", "2021-04-04")),
                   lower_window = -2,
                   upper_window = 1))

prophetModelsBound <- function(data){
  if(!is_tsibble(data)){data <- as_tsibble(data, index = datename)}
  
  oc_prophet_model1 <-
    fable.prophet::prophet(my_scaled_logit(n, 0, 100) ~ 
                             growth("linear", n_changepoints = 0) +
                             season("year", type = "additive") +
                             holiday(holidays))
  oc_prophet_model2 <-
    fable.prophet::prophet(my_scaled_logit(n, 0, 100) ~ 
                             growth("linear", n_changepoints = 0) +
                             season("year", type = "multiplicative") +
                             holiday(holidays))
  oc_prophet_model3 <-
    fable.prophet::prophet(my_scaled_logit(n, 0, 100) ~ 
                             growth("linear") +
                             season("year", type = "additive") +
                             holiday(holidays))
  oc_prophet_model4 <-
    fable.prophet::prophet(my_scaled_logit(n, 0, 100) ~ 
                             growth("linear") +
                             season("year", type = "multiplicative") +
                             holiday(holidays))
  oc_prophet_model5 <-
    fable.prophet::prophet(my_scaled_logit(n, 0, 100) ~ 
                             season("year", type = "additive") +
                             holiday(holidays))
  oc_prophet_model6 <-
    fable.prophet::prophet(my_scaled_logit(n, 0, 100) ~ 
                             season("year", type = "multiplicative") +
                             holiday(holidays))
  oc_prophet_model7 <-
    fable.prophet::prophet(my_scaled_logit(n, 0, 100) ~ holiday(holidays))
  oc_prophet_model8 <-
    fable.prophet::prophet(my_scaled_logit(n, 0, 100))
  
  data %>%
    mutate(datename = yearmonth(datename)) %>%
    model(oc_prophet_model1, oc_prophet_model2, oc_prophet_model3,
          oc_prophet_model4, oc_prophet_model5, oc_prophet_model6,
          oc_prophet_model7, oc_prophet_model8, .safely = TRUE)
}

regionalCV <- function(data, cv_dist = 6, init = 36, step = 1){
  
  # CV accuracy for fableModelsBound() and prophetModelsBound()
  
  regions <- unique(data$regional_unit) # Get unique regional_units for map()
  
  # p <- progressr::progressor(along = regions)

  fableCV <- function(data){ # Return CV model accuracy for fableModelsBound()
    x <- data$regional_unit

    data_test <-
      data %>%
      mutate(datename = yearmonth(datename))

    data %>%
      select(regional_unit, datename, n) %>%
      mutate(datename = yearmonth(datename)) %>%
      fill_gaps() %>%
      slice(1:(n()-cv_dist), .preserve = TRUE) %>%
      stretch_tsibble(.init = init, .step = step) %>% 
      fableModelsBound() %>%
      forecast(h = cv_dist) %>%
      accuracy(data_test)
    
    # p()
  }
  
  prophetCV <- function(data){# Return CV model accuracy for prophetModelsBound()
    x <- data$regional_unit

    data_test <-
      data %>%
      mutate(datename = yearmonth(datename))

    data_trn <-
      data %>%
      select(regional_unit, datename, n) %>%
      mutate(datename = yearmonth(datename)) %>%
      fill_gaps() %>%
      slice(1:(n()-cv_dist), .preserve = TRUE) %>%
      stretch_tsibble(.init = init, .step = step)
      
    data_trn %>% 
      prophetModelsBound() %>%
      forecast(h = cv_dist) %>%
      accuracy(data_test)

    # p()
  }

  prophet_fits <-
    future_map_dfr(.x =  regions,
                   .f = ~prophetCV(data = filter(data, regional_unit == .x)),
                   .options = furrr_options(seed = TRUE))
  message("prophetModelsBound() complete")
  
  # Fable models will run using plan(cluster), but need to be run as below
  # with `furrr_options(seed = TRUE)` otherwise improper random numbers are
  # generated
  fable_fits <-
    future_map_dfr(.x =  regions,
                   .f = ~fableCV(data = filter(data, regional_unit == .x)),
                   .options = furrr_options(seed = TRUE))
  message("fableModelsBound() complete")
  
  bind_rows(fable_fits, prophet_fits) %>%
    group_by(regional_unit) %>%
    arrange(RMSE, MAE)
}

regionalJointFcsts <- function(data, h ="5 months"){
  regions <- unique(data$regional_unit)

  fable_fcst <-
    future_map_dfr(.x = regions,
                   .f = ~fableModelsBound(filter(data, regional_unit ==.x)) %>%
                    forecast(h = h),
                   .options = furrr_options(seed = TRUE)) %>%
    as_tibble()
  
  message("fable forecasts complete")


  prophet_fcst <-
    future_map_dfr(.x = regions,
                   .f = ~prophetModelsBound(filter(data, regional_unit ==.x)) %>%
                    forecast(h = h),
                   .options = furrr_options(seed = TRUE)) %>%
    as_tibble()

  message("prophet forecasts complete")

  # joint_fit <-
  #   left_join(fable_fit, prophet_fit, by = "regional_unit")
  joint_fcst <-
    bind_rows(fable_fcst, prophet_fcst) %>%
    mutate(lb_95 = quantile(n, .025),
           lb_80 = quantile(n, .1),
           med = median(n),
           ub_80 = quantile(n, .9),
           ub_95 = quantile(n, .975),
           sd = distributional::variance(n)^2,
           dist = n,
           n = NULL)

  return(joint_fcst)
}

```

## Preparing data

```{r prep-data}
## Drugs of interest
oral_anticoagulants <- 
  c("0208020H0", "0208020Z0", "0208020X0", "0208020AA", "0208020W0", 
    "020802000", "0208020I0", "0208020N0", "0208020S0", "0208020Y0", 
    "0208020V0")
warf <- "0208020V0"


# ## Read from database
# con <- DBI::dbConnect(RSQLite::SQLite(), 
#                       "../OneDrive/1_data/gpextract/db-gpextract.sqlite")
# db.gpextract <- tbl(con, "gpextract")
# oac <- db.gpextract %>%
#   filter(bnfchem %in% oral_anticoagulants) %>%
#   collect() %>%
#   mutate(datename = dmy(paste0("28-", datename)))  # Add day component to date and convert to date-time object
# DBI::dbDisconnect(con)
# 
# ## Write to local file
# oac %>%
#   write_rds("../data/oral_anticoagulants.rds")

## Read from local file
gp <- read_rds("../OneDrive/2_interimdata/8_linkeddata/gp_agesex_qof_combined.rds") %>% 
  mutate(npat = N,
         N = NULL) %>% 
  filter(year == 2020) # Do something better. Is npat important for the proportion?

oac <- read_rds("../data/oral_anticoagulants.rds") 

## Sort into monthly count data
oac_p_monthly_count <- 
  oac %>% 
  group_by(datename, bnfchem) %>% 
  summarise(n = sum(Quantity)) %>% 
  mutate(n = 100 * n / sum(n), # make it a percentage rather than proportion
         log_n = log(n)) %>% 
  filter(bnfchem == warf) %>% 
  ungroup() %>%
  as_tsibble(index = datename)

oac_p_monthly_quantity_hb <- 
  right_join(oac, select(gp, c(practiceid, hboard)), 
             by = c("PracticeID" = "practiceid")) %>%
  propRegional(region = hboard, datename = datename, unit = Quantity,
               bnf = warf) 

oac_p_monthly_quantity_cluster <- 
  right_join(oac, select(gp, c(practiceid, cluster)), 
             by = c("PracticeID" = "practiceid")) %>%
  propRegional(cluster, datename, Quantity, bnf = warf)

oac_p_monthly_quantity_gp <- 
  oac %>% 
  group_by(PracticeID, datename, bnfchem) %>% 
  summarise(sum_n = sum(Quantity), .groups = "drop_last") %>% 
  mutate(p_war = 100 * sum_n / sum(sum_n)) %>% 
  filter(bnfchem == as_name(warf)) %>% 
  transmute(regional_unit = as.factor(PracticeID),
            datename = datename,
            n = p_war) %>%
    ungroup() %>%
    as_tsibble(index = datename, key = regional_unit)
  
  

## Sort into monthly count data pre-lockdown (2020-03-23)
oac_p_monthly_count_pre_cv19 <- 
  oac_p_monthly_count %>% 
  filter(datename < dmy("01-03-2020"))

# oac_p_monthly_quantity_hb_pre_cv19 <- 
#   oac_p_monthly_quantity_hb %>% 
#     filter(datename < dmy("01-03-2020"))
# 
# oac_p_monthly_quantity_cluster_pre_cv19 <- 
#   oac_p_monthly_quantity_cluster %>% 
#     filter(datename < dmy("01-03-2020"))

oac_p_monthly_quantity_gp_pre_cv19 <- 
  oac_p_monthly_quantity_gp %>% 
    filter(datename < dmy("01-03-2020"))


```


## Overview

### 2016-2020 plot of all oac_p prescriptions 

```{r oac_p-monthly-ts-plot, fig.cap="Total quantity of combined oral anticoagulants prescribed per month."}
oac %>% 
  group_by(datename) %>% 
  summarise(n = sum(Quantity)) %>% 
  tsibble() %>% 
  autoplot(n) +
  geom_vline(xintercept = dmy("23-March-2020"), colour = "red") # add line to mark the start of lockdown
```

```{r oac-p-monthly-ts-plot, fig.cap="Warfarin prescribing as a percentage of all oral anticoagulants prescribed per month."}
oac_p_monthly_count %>% 
  select(datename, n) %>% 
  autoplot() +
  geom_vline(xintercept = dmy("23-March-2020"), colour = "red") # add line to mark the start of lockdown
```


### Seasonality

```{r oac_p-monthly-seasonality-plot}
df <- 
  oac_p_monthly_count_pre_cv19 %>% 
  mutate(month = as.factor(month(datename, label = TRUE, abbr = TRUE)),
         year = as.factor(year(datename))) 

df2 <- df %>% 
  as_tibble() %>% 
  filter(year(datename) != 2020) %>% 
  group_by(month) %>% 
  summarise(n = mean(n))

df %>% 
  ggplot(aes(x = month, y = n, colour = year, group = year)) +
  geom_line() +
  geom_line(data = df2, aes(x = month, y = n, group = "Avg"), 
            colour = "red", lty = 2) +
  labs(caption = "Red dashed line is mean for 2016-2019")

```
* 


```{r}
oac_p_monthly_count_pre_cv19 %>% 
  mutate(datename = yearmonth(datename)) %>% 
  gg_subseries(y = n, period = "year")
```


### Autocorrelation

```{r}
tseries::adf.test(oac_p_monthly_count$n)
urca::ur.df(oac_p_monthly_count$n)
```


```{r}
oac_p_monthly_count_pre_cv19 %>%
  mutate(datename = yearmonth(datename)) %>% 
  ACF(n, lag_max = 24) %>% autoplot()
```

* Autocorrelation greatest at 2 and 12

```{r}
oac_p_monthly_count_pre_cv19$n %>%
  pacf(lag.max = 24)
```


## Modelling

### By Health Board

```{r, health-board-modelling, eval = FALSE}
plan(cluster)
system.time(oac_p_hb_cv_models <-
  regionalCV(data = oac_p_monthly_quantity_hb_pre_cv19))
plan(sequential)
oac_p_hb_cv_models %>%
  write_rds("../data/oac_p_hb_cv_models.rds")

oac_p_hb_cv_models <- 
  read_rds("../data/oac_p_hb_cv_models.rds")

oac_p_hb_cv_models %>% 
  group_by(regional_unit) %>% 
  arrange(RMSE, MAE) %>% 
  slice(1, .preserve = TRUE) %>% 
  ggplot(aes(x = MAPE)) +
  geom_histogram()

oac_p_hb_cv_models %>% 
  group_by(regional_unit) %>% 
  arrange(RMSE, MAE) %>% 
  slice(1, .preserve = TRUE) %>% 
  group_by(.model) %>% 
  count() %>% 
  arrange(desc(n))

oac_p_hb_cv_models %>% 
  group_by(regional_unit) %>% 
  ggplot(aes(x = reorder(.model, MAPE, mean), y = MAPE)) + # reorder by mean of y
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90))
```

* 965.17 seconds with prophetModelsBound() 2021-01-15

```{r health-board-forecast, eval = FALSE}
plan(cluster)
system.time(oac_p_hb_fcsts <- regionalJointFcsts(oac_p_monthly_quantity_hb_pre_cv19))
plan(sequential)
oac_p_hb_fcsts %>%
  write_rds("../data/oac_p_hb_fcsts.rds")

oac_p_hb_fcsts <- 
  read_rds("../data/oac_p_hb_fcsts.rds")
```
129.80 2021-01-15
* 


### By GP Cluster

```{r, gp-cluster-modelling, eval = FALSE}
plan(cluster)
system.time(oac_p_gp_cluster_cv_models <-
  regionalCV(data = oac_p_monthly_quantity_cluster_pre_cv19))
plan(sequential)

oac_p_gp_cluster_cv_models %>%
  write_rds("../data/oac_p_gp_cluster_cv_models.rds")

oac_p_gp_cluster_cv_models <- 
  read_rds("../data/oac_p_gp_cluster_cv_models.rds")

oac_p_gp_cluster_cv_models %>% 
  group_by(regional_unit) %>% 
  arrange(RMSE, MAE) %>% 
  slice(1, .preserve = TRUE) %>% 
  ggplot(aes(x = MAPE)) +
  geom_histogram()

oac_p_gp_cluster_cv_models %>% 
  group_by(regional_unit) %>% 
  arrange(RMSE, MAE) %>% 
  slice(1, .preserve = TRUE) %>% 
  group_by(.model) %>% 
  count() %>% 
  arrange(desc(n))

oac_p_gp_cluster_cv_models %>% 
  group_by(regional_unit) %>% 
  ggplot(aes(x = reorder(.model, MAPE, mean), y = MAPE)) + # reorder by mean of y
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90))


```

* 

```{r gp-cluste-forecast, eval = FALSE}
plan(cluster)
system.time(oac_p_gp_cluster_fcsts <- 
              regionalJointFcsts(oac_p_monthly_quantity_cluster_pre_cv19))
plan(sequential)

oac_p_gp_cluster_fcsts %>%
  write_rds("../data/oac_p_gp_cluster_fcsts.rds")

oac_p_gp_cluster_fcsts <- 
  read_rds("../data/oac_p_gp_cluster_fcsts.rds")
```

* 1266.126 seconds 2020-12-10
* 590.595 seconds 2021-01-11

### By Practice

```{r, gp-practice-modelling}
incomplete_gp <- # Need to remove GP Practices with incomplete data
  oac_p_monthly_quantity_gp_pre_cv19 %>% 
  as_tibble() %>% 
  group_by(regional_unit) %>% 
  count() %>% 
  filter(n < 50) %>% 
  .$regional_unit %>% 
  as.character() %>% 
  unique()

complete_oac_p_monthly_quantity_gp_pre_cv19 <- 
  oac_p_monthly_quantity_gp_pre_cv19 %>% 
  filter(!regional_unit %in% incomplete_gp)

# Splitting practices into separate analyses to ease computational burden
seg_1 <- 
  complete_oac_p_monthly_quantity_gp_pre_cv19$regional_unit %>% 
           unique() %>% 
           .[1:101] %>% 
  as.character()
seg_2 <- 
  complete_oac_p_monthly_quantity_gp_pre_cv19$regional_unit %>% 
           unique() %>% 
           .[102:202] %>% 
  as.character()
seg_3 <- 
  complete_oac_p_monthly_quantity_gp_pre_cv19$regional_unit %>% 
           unique() %>% 
           .[203:303] %>% 
  as.character()
seg_4 <- 
  complete_oac_p_monthly_quantity_gp_pre_cv19$regional_unit %>% 
           unique() %>% 
           .[304:404] %>% 
  as.character()

complete_oac_p_monthly_quantity_gp_pre_cv19_1 <- 
  complete_oac_p_monthly_quantity_gp_pre_cv19 %>% 
  filter(regional_unit %in% seg_1)
complete_oac_p_monthly_quantity_gp_pre_cv19_2 <- 
  complete_oac_p_monthly_quantity_gp_pre_cv19 %>% 
  filter(regional_unit %in% seg_2)
complete_oac_p_monthly_quantity_gp_pre_cv19_3 <- 
  complete_oac_p_monthly_quantity_gp_pre_cv19 %>% 
  filter(regional_unit %in% seg_3)
complete_oac_p_monthly_quantity_gp_pre_cv19_4 <- 
  complete_oac_p_monthly_quantity_gp_pre_cv19 %>% 
  filter(regional_unit %in% seg_4)

# Running regionalCV() on each of the quarter of the data
plan(multisession)
system.time(oac_p_gp_cv_models_1 <-
  complete_oac_p_monthly_quantity_gp_pre_cv19_1 %>%
              regionalCV())
system.time(oac_p_gp_cv_models_2 <-
  complete_oac_p_monthly_quantity_gp_pre_cv19_2 %>%
              regionalCV())
system.time(oac_p_gp_cv_models_3 <-
  complete_oac_p_monthly_quantity_gp_pre_cv19_3 %>%
              regionalCV())
system.time(oac_p_gp_cv_models_4 <-
  complete_oac_p_monthly_quantity_gp_pre_cv19_4 %>%
              regionalCV())
plan(sequential)

# Joining the separated results
oac_p_gp_cv_models <- 
  rbind(oac_p_gp_cv_models_1,
        oac_p_gp_cv_models_2,
        oac_p_gp_cv_models_3,
        oac_p_gp_cv_models_4)

oac_p_gp_cv_models %>%
  saveRDS("../data/oac_p_gp_cv_models.rds")

oac_p_gp_cv_models <- 
  read_rds("../data/oac_p_gp_cv_models.rds")

oac_p_gp_cv_models %>% 
  group_by(regional_unit) %>% 
  arrange(RMSE, MAE) %>% 
  slice(1, .preserve = TRUE) %>% 
  ggplot(aes(x = MAPE)) +
  geom_histogram()

oac_p_gp_cv_models %>% 
  group_by(regional_unit) %>% 
  arrange(RMSE, MAE) %>% 
  slice(1, .preserve = TRUE) %>% 
  group_by(.model) %>% 
  count() %>% 
  arrange(desc(n))

oac_p_gp_cv_models %>% 
  group_by(regional_unit) %>% 
  ggplot(aes(x = reorder(.model, MAPE, mean), y = MAPE)) + # reorder by mean of y
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90))
```


* prophetModelsBound() complete
NaNs producedfableModelsBound() complete
    user   system  elapsed 
  504.83    38.03 11465.09 
prophetModelsBound() complete                                         
NaNs producedNaNs producedfableModelsBound() complete                 
    user   system  elapsed 
  520.35    40.97 11534.13 
prophetModelsBound() complete
fableModelsBound() complete
    user   system  elapsed 
  377.34    22.89 11300.13 
prophetModelsBound() complete
fableModelsBound() complete
    user   system  elapsed 
  370.35    21.11 11321.84 


```{r gp-practice-forecast}
plan(multisession)
system.time(oac_p_gp_fcst_1 <-
  oac_p_monthly_quantity_gp_pre_cv19 %>%
              filter(regional_unit %in% seg_1) %>%
    regionalJointFcsts())
system.time(oac_p_gp_fcst_2 <-
  oac_p_monthly_quantity_gp_pre_cv19 %>%
              filter(regional_unit %in% seg_2) %>%
    regionalJointFcsts())
system.time(oac_p_gp_fcst_3 <-
  oac_p_monthly_quantity_gp_pre_cv19 %>%
              filter(regional_unit %in% seg_3) %>%
    regionalJointFcsts())
system.time(oac_p_gp_fcst_4 <-
  oac_p_monthly_quantity_gp_pre_cv19 %>%
              filter(regional_unit %in% seg_4) %>%
    regionalJointFcsts())
plan(sequential)

oac_p_gp_fcsts <-
  bind_rows(oac_p_gp_fcst_1,
            oac_p_gp_fcst_2,
            oac_p_gp_fcst_3,
            oac_p_gp_fcst_4)

oac_p_gp_fcsts %>%
  saveRDS("../data/oac_p_gp_fcsts.rds")

oac_p_gp_fcsts <- 
  read_rds("../data/oac_p_gp_fcsts.rds")
```

* NaNs producedNaNs producedfable forecasts complete
prophet forecasts complete
    user   system  elapsed 
  97.430   22.773 1580.689 
fable forecasts complete
prophet forecasts complete
    user   system  elapsed 
 106.565   84.755 1719.863 
fable forecasts complete
prophet forecasts complete
    user   system  elapsed 
 114.419  116.874 1867.420 
fable forecasts complete
prophet forecasts complete
    user   system  elapsed 
 113.032  124.767 1910.564 

```{r}
oac_p_monthly_quantity_gp_pre_cv19_complete <-
  oac_p_monthly_quantity_gp_pre_cv19 %>% 
  filter(!regional_unit %in% incomplete_gp)

plan(multisession)
system.time(fable_fit_1 <-
  future_map_dfr(.x = oac_p_monthly_quantity_gp_pre_cv19_complete$regional_unit[1:101],
                 .f = ~fableModelsBound(filter(oac_p_monthly_quantity_gp_pre_cv19_complete,
                                          regional_unit ==.x)),
                 .options = furrr_options(seed = TRUE)) %>%
  forecast(h = "5 months") %>%
  as_tibble())

system.time(prophet_fit_1 <-
  future_map_dfr(.x = oac_p_monthly_quantity_gp_pre_cv19_complete$regional_unit[1:101],
                 .f = ~prophetModelsBound(filter(oac_p_monthly_quantity_gp_pre_cv19_complete,
                                            regional_unit ==.x)),
                 .options = furrr_options(seed = TRUE)) %>%
  forecast(h = "5 months") %>%
  as_tibble())
system.time(fable_fit_2 <-
  future_map_dfr(.x = oac_p_monthly_quantity_gp_pre_cv19_complete$regional_unit[102:202],
                 .f = ~fableModelsBound(filter(oac_p_monthly_quantity_gp_pre_cv19_complete,
                                          regional_unit ==.x)),
                 .options = furrr_options(seed = TRUE)) %>%
  forecast(h = "5 months") %>%
  as_tibble())

system.time(prophet_fit_2 <-
  future_map_dfr(.x = oac_p_monthly_quantity_gp_pre_cv19_complete$regional_unit[102:202],
                 .f = ~prophetModelsBound(filter(oac_p_monthly_quantity_gp_pre_cv19_complete,
                                            regional_unit ==.x)),
                 .options = furrr_options(seed = TRUE)) %>%
  forecast(h = "5 months") %>%
  as_tibble())
system.time(fable_fit_3 <-
  future_map_dfr(.x = oac_p_monthly_quantity_gp_pre_cv19_complete$regional_unit[203:303],
                 .f = ~fableModelsBound(filter(oac_p_monthly_quantity_gp_pre_cv19_complete,
                                          regional_unit ==.x)),
                 .options = furrr_options(seed = TRUE)) %>%
  forecast(h = "5 months") %>%
  as_tibble())

system.time(prophet_fit_3 <-
  future_map_dfr(.x = oac_p_monthly_quantity_gp_pre_cv19_complete$regional_unit[203:303],
                 .f = ~prophetModelsBound(filter(oac_p_monthly_quantity_gp_pre_cv19_complete,
                                            regional_unit ==.x)),
                 .options = furrr_options(seed = TRUE)) %>%
  forecast(h = "5 months") %>%
  as_tibble())
system.time(fable_fit_4 <-
  future_map_dfr(.x = oac_p_monthly_quantity_gp_pre_cv19_complete$regional_unit[304:404],
                 .f = ~fableModelsBound(filter(oac_p_monthly_quantity_gp_pre_cv19_complete,
                                          regional_unit ==.x)),
                 .options = furrr_options(seed = TRUE)) %>%
  forecast(h = "5 months") %>%
  as_tibble())

system.time(prophet_fit_4 <-
  future_map_dfr(.x = oac_p_monthly_quantity_gp_pre_cv19_complete$regional_unit[304:404],
                 .f = ~prophetModelsBound(filter(oac_p_monthly_quantity_gp_pre_cv19_complete,
                                            regional_unit ==.x)),
                 .options = furrr_options(seed = TRUE)) %>%
  forecast(h = "5 months") %>%
  as_tibble())
plan(sequential)

joint_fcst <-
  bind_rows(fable_fcst_1, prophet_fcst_1,
            fable_fcst_2, prophet_fcst_2,
            fable_fcst_3, prophet_fcst_3,
            fable_fcst_4, prophet_fcst_4) %>%
  mutate(lb_95 = quantile(n, .025),
         lb_80 = quantile(n, .1),
         med = median(n),
         ub_80 = quantile(n, .9),
         ub_95 = quantile(n, .975),
         sd = distributional::variance(n)^2,
         dist = n,
         n = NULL)
joint_fcst %>%
  saveRDS("../data/oac_p_gp_fcsts.rds")

oac_p_gp_fcsts <-
  read_rds("../data/oac_p_gp_fcsts.rds")

```

## Discrepancies

### By Health Board

```{r, health-board-discrepancies}
best_model_hb <- 
  oac_p_hb_cv_models %>% 
  group_by(regional_unit) %>% 
  arrange(RMSE, MAE) %>% 
  slice(1, .preserve = TRUE)

best_model_hb %>% 
  select(.model, regional_unit) %>% 
  inner_join(mutate(oac_p_hb_fcsts,
                    datename = yearmonth(datename)), 
             by = c(".model", "regional_unit")) %>%
  left_join(mutate(select(oac_p_monthly_quantity_hb, 
                          c(regional_unit, datename, n)), 
                   datename = yearmonth(datename)),
            by = c("datename", "regional_unit")) %>% 
  mutate(discrepancy = n - .mean,
         z_discrepancy = discrepancy/sd) %>% 
  ggplot(aes(y = discrepancy)) +
  geom_line(aes(x = datename, y = discrepancy, colour = as.factor(regional_unit)),
            alpha = .8, lty = 2) +
  geom_hline(aes(yintercept = 0), colour = "red") +
  theme(legend.position = "none")
```

### By GP Cluster

```{r, gp-cluster-discrepancies}
best_model_gp_cluster <- 
  oac_p_gp_cluster_cv_models %>% 
  group_by(regional_unit) %>% 
  arrange(RMSE, MAE) %>% 
  slice(1, .preserve = TRUE)

best_model_gp_cluster %>% 
  select(.model, regional_unit) %>% 
  inner_join(mutate(oac_p_gp_cluster_fcsts,
                    datename = yearmonth(datename)), 
             by = c(".model", "regional_unit")) %>%
  left_join(mutate(select(oac_p_monthly_quantity_cluster, 
                          c(regional_unit, datename, n)), 
                   datename = yearmonth(datename)),
            by = c("datename", "regional_unit")) %>% 
  mutate(discrepancy = n - .mean,
         z_discrepancy = discrepancy/sd) %>% 
  ggplot(aes(y = discrepancy)) +
  # geom_boxplot(aes(x = as.factor(datename))) +
  geom_line(aes(x = datename, y = discrepancy, colour = as.factor(regional_unit)),
            alpha = .8, lty = 2) +
  # scale_color_gradientn(colours = rainbow(100))+
  geom_hline(aes(yintercept = 0), colour = "red") +
  theme(legend.position = "none")
```

```{r, eval = FALSE}
# lcmm::

```


```{r}
best_model_gp_cluster %>% 
  select(.model, regional_unit) %>% 
  inner_join(mutate(oac_p_gp_cluster_fcsts,
                    datename = yearmonth(datename)), 
             by = c(".model", "regional_unit")) %>%
  left_join(mutate(select(oac_p_monthly_quantity_cluster, 
                          c(regional_unit, datename, n)), 
                   datename = yearmonth(datename)),
            by = c("datename", "regional_unit")) %>% 
  mutate(discrepancy = (n - .mean), # Why are the numbers so small?
         regional_unit = as.factor(regional_unit)) %>% 
  select(regional_unit, datename, discrepancy) %>% 
  pivot_wider(names_from = datename, values_from = discrepancy) %>% 
  mutate(regional_unit = as.numeric(regional_unit)) %>% 
  write_csv(file = "../data/mplus/oac_cluster_discrep.csv", col_names = FALSE)
```

### By GP Practice

```{r, gp-practice-discrepancies}
best_model_gp <- 
  oac_p_gp_cv_models %>% 
  group_by(regional_unit) %>% 
  arrange(RMSE, MAE) %>% 
  slice(1, .preserve = TRUE)

best_model_gp %>% 
  select(.model, regional_unit) %>% 
  inner_join(mutate(oac_p_gp_fcsts,
                    datename = yearmonth(datename)), 
             by = c(".model", "regional_unit")) %>%
  left_join(mutate(select(oac_p_monthly_quantity_gp, 
                          c(regional_unit, datename, n)), 
                   datename = yearmonth(datename)),
            by = c("datename", "regional_unit")) %>% 
  mutate(discrepancy = n - .mean,
         z_discrepancy = discrepancy/sd) %>% 
  ggplot(aes(y = discrepancy)) +
  # geom_boxplot(aes(x = as.factor(datename))) +
  geom_line(aes(x = datename, y = discrepancy, colour = as.factor(regional_unit)),
            alpha = .8, lty = 2) +
  geom_hline(aes(yintercept = 0), colour = "red") +
  theme(legend.position = "none")

```


```{r}
best_model_gp %>% 
  select(.model, regional_unit) %>% 
  inner_join(mutate(oac_p_gp_fcsts,
                    datename = yearmonth(datename)), 
             by = c(".model", "regional_unit")) %>%
  left_join(mutate(select(oac_p_monthly_quantity_gp, 
                          c(regional_unit, datename, n)), 
                   datename = yearmonth(datename)),
            by = c("datename", "regional_unit")) %>% 
  mutate(discrepancy = n - .mean,
         # regional_unit = as.character(regional_unit)
         ) %>% 
  ggplot(aes(x = datename, y = n, group = regional_unit)) +
  geom_line() +
  facet_wrap(~regional_unit)
  
  as_tsibble(key = regional_unit, index = datename) %>% 
  autoplot(oac_p_monthly_quantity_gp_pre_cv19 %>% 
             select(regional_unit, datename, n) %>% 
             as_tsibble(key = regional_unit, index = datename)) +
  theme(legend.position = "none")
```


